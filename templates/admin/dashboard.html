<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카비서 관리자 - 대시보드</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-logo">카비서 관리자</a>
            <nav class="admin-nav">
                <a href="{{ url_for('admin.dashboard') }}" class="{% if not show_reviewers|default(false) %}active{% endif %}">대시보드</a>
                <a href="{{ url_for('admin.campaigns') }}">캠페인</a>
                <a href="{{ url_for('admin.overview') }}">전체현황</a>
                <a href="{{ url_for('admin.chat_list') }}">대화이력</a>
                <a href="{{ url_for('admin.reviews') }}">검수</a>
                <a href="{{ url_for('admin.settlement') }}">정산</a>
                <a href="{{ url_for('admin.activity_logs') }}">활동로그</a>
                <a href="{{ url_for('admin.reviewers') }}" class="{% if show_reviewers|default(false) %}active{% endif %}">리뷰어</a>
                <a href="{{ url_for('admin.guide') }}">가이드</a>
                <a href="{{ url_for('admin.logout') }}">로그아웃</a>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        {% if show_reviewers|default(false) %}
        <!-- 리뷰어 목록 -->
        <h1>리뷰어 목록</h1>
        <form class="admin-search" method="GET" action="{{ url_for('admin.reviewers') }}" style="margin-bottom:1rem;">
            <input type="text" name="q" placeholder="진행자/수취인/연락처/아이디 검색" value="{{ q|default('') }}">
            <button type="submit" class="btn btn-primary">검색</button>
        </form>

        <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">
            <label for="statusFilter" style="font-weight:600;">상태 필터:</label>
            <select id="statusFilter" style="padding:0.4rem 0.8rem; border:1px solid #d1d5db; border-radius:6px;">
                <option value="">전체</option>
                <option value="타임아웃취소">타임아웃취소</option>
                <option value="신청">신청</option>
                <option value="가이드전달">가이드전달</option>
                <option value="구매내역제출">구매내역제출</option>
                <option value="리뷰제출">리뷰제출</option>
                <option value="입금대기">입금대기</option>
                <option value="입금완료">입금완료</option>
                <option value="취소">취소</option>
            </select>
        </div>

        <form id="restoreForm" method="POST" action="{{ url_for('admin.reviewers_restore') }}">
        <div class="admin-table-wrap">
            <table class="admin-table" id="reviewerTable">
                <thead>
                    <tr>
                        <th style="width:40px;"><input type="checkbox" id="checkAll"></th>
                        <th>진행자</th>
                        <th>진행자연락처</th>
                        <th>수취인</th>
                        <th>아이디</th>
                        <th>제품명</th>
                        <th>상태</th>
                        <th>구매일</th>
                        <th>카톡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in reviewers|default([]) %}
                    <tr data-status="{{ item.get('상태', '') }}">
                        <td><input type="checkbox" name="row_idx" value="{{ item.get('_row_idx', '') }}" class="row-check"></td>
                        <td>{{ item.get('진행자이름', '') }}</td>
                        <td>{{ item.get('진행자연락처', '') }}</td>
                        <td>{{ item.get('수취인명', '') }}</td>
                        <td>{{ item.get('아이디', '') }}</td>
                        <td>{{ item.get('상품명', item.get('제품명', '')) }}</td>
                        <td><span class="admin-status-badge {{ item.get('상태', '')|lower }}">{{ item.get('상태', '') }}</span></td>
                        <td>{{ item.get('구매일', '') }}</td>
                        <td><button type="button" class="btn btn-sm" style="background:#fae100;color:#3c1e1e;border:none;padding:2px 8px;border-radius:4px;cursor:pointer;font-size:12px;" onclick="sendKakao({{ item.get('_row_idx', 0) }})">카톡</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="margin-top:1rem; display:flex; gap:0.5rem;">
            <button type="submit" class="btn btn-primary" id="restoreBtn">타임아웃 복원 (가이드전달로 변경)</button>
            <button type="button" class="btn" style="background:#fae100;color:#3c1e1e;border:none;" onclick="bulkKakao()">카톡 일괄발송</button>
        </div>
        </form>

        <!-- 카톡 발송 모달 -->
        <div id="kakaoModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:420px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 style="margin:0;">카카오톡 발송</h3>
                    <button onclick="closeKakaoModal()" style="border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
                </div>
                <p id="kakaoTarget" style="color:#666;margin-bottom:12px;">대상: 1건</p>
                <textarea id="kakaoMessage" placeholder="커스텀 메시지 (비우면 상태별 기본 메시지)" rows="3" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;resize:vertical;box-sizing:border-box;"></textarea>
                <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end;">
                    <button onclick="closeKakaoModal()" style="padding:8px 16px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;">취소</button>
                    <button onclick="confirmKakaoSend()" style="padding:8px 16px;border:none;border-radius:6px;background:#fae100;color:#3c1e1e;cursor:pointer;font-weight:600;">발송</button>
                </div>
            </div>
        </div>

        <script>
        var _kakaoIds = [];

        function sendKakao(progressId) {
            _kakaoIds = [progressId];
            document.getElementById('kakaoTarget').textContent = '대상: 1건';
            document.getElementById('kakaoMessage').value = '';
            document.getElementById('kakaoModal').style.display = 'flex';
        }

        function bulkKakao() {
            var checked = document.querySelectorAll('.row-check:checked');
            if (checked.length === 0) { alert('발송할 항목을 선택해주세요.'); return; }
            _kakaoIds = [];
            checked.forEach(function(cb) { _kakaoIds.push(parseInt(cb.value)); });
            document.getElementById('kakaoTarget').textContent = '대상: ' + _kakaoIds.length + '건';
            document.getElementById('kakaoMessage').value = '';
            document.getElementById('kakaoModal').style.display = 'flex';
        }

        function closeKakaoModal() {
            document.getElementById('kakaoModal').style.display = 'none';
        }

        function confirmKakaoSend() {
            var msg = document.getElementById('kakaoMessage').value.trim();
            var url = _kakaoIds.length === 1
                ? '/admin/api/kakao/send'
                : '/admin/api/kakao/bulk';
            var body = _kakaoIds.length === 1
                ? { progress_id: _kakaoIds[0], message: msg }
                : { progress_ids: _kakaoIds, message: msg };

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                closeKakaoModal();
                if (d.ok) {
                    var count = d.sent || 1;
                    alert('카톡 발송 완료: ' + count + '건');
                } else {
                    alert('발송 실패: ' + (d.message || '알 수 없는 오류'));
                }
            })
            .catch(function(e) {
                closeKakaoModal();
                alert('발송 에러: ' + e.message);
            });
        }

        (function() {
            var filter = document.getElementById('statusFilter');
            var table = document.getElementById('reviewerTable');
            var checkAll = document.getElementById('checkAll');
            var restoreBtn = document.getElementById('restoreBtn');

            // 상태 필터
            filter.addEventListener('change', function() {
                var val = this.value;
                var rows = table.querySelectorAll('tbody tr');
                rows.forEach(function(row) {
                    if (!val || row.getAttribute('data-status') === val) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
                checkAll.checked = false;
            });

            // 전체 선택
            checkAll.addEventListener('change', function() {
                var checked = this.checked;
                var rows = table.querySelectorAll('tbody tr');
                rows.forEach(function(row) {
                    if (row.style.display !== 'none') {
                        row.querySelector('.row-check').checked = checked;
                    }
                });
            });

            // 복원 확인
            document.getElementById('restoreForm').addEventListener('submit', function(e) {
                var checked = document.querySelectorAll('.row-check:checked');
                if (checked.length === 0) {
                    e.preventDefault();
                    alert('복원할 항목을 선택해주세요.');
                    return;
                }
                // 타임아웃취소가 아닌 건이 포함되었는지 확인
                var nonTimeout = [];
                checked.forEach(function(cb) {
                    var row = cb.closest('tr');
                    if (row.getAttribute('data-status') !== '타임아웃취소') {
                        nonTimeout.push(row.getAttribute('data-status'));
                    }
                });
                if (nonTimeout.length > 0) {
                    e.preventDefault();
                    alert('타임아웃취소 상태인 건만 복원할 수 있습니다.\n선택 항목 중 다른 상태(' + nonTimeout.join(', ') + ')가 포함되어 있습니다.');
                    return;
                }
                if (!confirm(checked.length + '건을 가이드전달 상태로 복원하시겠습니까?')) {
                    e.preventDefault();
                }
            });
        })();
        </script>

        {% else %}
        <!-- 대시보드 -->
        <h1>오늘 현황</h1>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.get('new_today', 0) }}</div>
                <div class="stat-label">신규 신청</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.get('purchase_today', 0) }}</div>
                <div class="stat-label">구매 완료</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.get('review_today', 0) }}</div>
                <div class="stat-label">리뷰 완료</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.get('total', 0) }}</div>
                <div class="stat-label">전체 건수</div>
            </div>
        </div>

        <h2>최근 대화</h2>
        <div class="recent-messages">
            {% for msg in recent_messages %}
            <div class="recent-msg">
                <span class="msg-reviewer">{{ msg.reviewer_id }}</span>
                <span class="msg-sender {% if msg.sender == 'bot' %}bot{% else %}user{% endif %}">{{ msg.sender }}</span>
                <span class="msg-text">{{ msg.message[:80] }}{% if msg.message|length > 80 %}...{% endif %}</span>
            </div>
            {% endfor %}
            {% if not recent_messages %}
            <p class="admin-empty">아직 대화가 없습니다.</p>
            {% endif %}
        </div>
        {% endif %}
    </main>
</body>
</html>
