<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카비서 관리자 - 캠페인</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
    .admin-table-wrap { overflow-x: auto; }
    #campaignTable { min-width: 1100px; }
    .admin-status-badge.모집중 { background: #e3f2fd; color: #1565c0; }
    .admin-status-badge.진행중 { background: #e8f5e9; color: #2e7d32; }
    .admin-status-badge.마감 { background: #fff8e1; color: #f57f17; }
    .admin-status-badge.종료 { background: #f5f5f5; color: #999; }

    /* 오늘/목표 색상 */
    .today-normal { color: #2563eb; font-weight: 700; }
    .today-over { color: #ef4444; font-weight: 700; }
    .today-done { color: #16a34a; font-weight: 700; }

    /* 달성률 프로그레스 바 */
    .progress-cell { min-width: 100px; }
    .progress-bar-mini {
        width: 100%;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 2px;
    }
    .progress-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s;
    }
    .progress-bar-fill.high { background: #22c55e; }
    .progress-bar-fill.mid { background: #eab308; }
    .progress-bar-fill.low { background: #ef4444; }
    .progress-pct {
        font-size: 12px;
        font-weight: 600;
    }
    .progress-pct.high { color: #16a34a; }
    .progress-pct.mid { color: #ca8a04; }
    .progress-pct.low { color: #dc2626; }

    /* 토글 버튼 */
    .toggle-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        padding: 2px 6px;
        color: #888;
        transition: transform 0.2s;
    }
    .toggle-btn.open { transform: rotate(180deg); }

    /* 클릭 가능한 행 */
    .campaign-row { cursor: pointer; }
    .campaign-row:hover { background: #f9fafb; }

    /* 펼침 상세 영역 */
    .detail-row { display: none; }
    .detail-row.open { display: table-row; }
    .detail-cell {
        padding: 16px 20px !important;
        background: #f8fafc;
        border-left: 3px solid #e2e8f0;
    }
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px 24px;
        margin-bottom: 12px;
    }
    .detail-item {
        font-size: 13px;
    }
    .detail-label {
        color: #94a3b8;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    .detail-value {
        color: #1e293b;
        font-weight: 500;
        word-break: break-all;
    }
    .detail-value a {
        color: #2563eb;
        text-decoration: underline;
    }

    /* 일정 블록 */
    .schedule-blocks {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        margin-top: 4px;
    }
    .schedule-block {
        background: #f1f5f9;
        border-radius: 4px;
        padding: 3px 8px;
        font-size: 11px;
        text-align: center;
        min-width: 38px;
        border: 1px solid #e2e8f0;
    }
    .schedule-block .day-num {
        font-size: 10px;
        color: #94a3b8;
    }
    .schedule-block .day-qty {
        font-weight: 700;
        color: #334155;
    }
    .schedule-block.today {
        background: #dbeafe;
        border-color: #3b82f6;
    }
    .schedule-block.today .day-num { color: #2563eb; }
    .schedule-block.today .day-qty { color: #1d4ed8; }
    .schedule-block.past {
        opacity: 0.5;
    }
    .schedule-none {
        font-size: 12px;
        color: #94a3b8;
        font-style: italic;
    }

    /* 숫자 셀 */
    .num-cell { text-align: center; font-variant-numeric: tabular-nums; }

    /* 캠페인 관리 버튼 */
    .campaign-actions { display: flex; gap: 4px; align-items: center; flex-wrap: nowrap; }
    .campaign-actions .admin-btn-sm { white-space: nowrap; padding: 4px 8px; font-size: 12px; }
    .admin-btn-pause {
        background: #fff7ed; color: #ea580c; border-color: #fdba74;
    }
    .admin-btn-pause:hover { background: #fed7aa; }
    .admin-btn-resume {
        background: #f0fdf4; color: #16a34a; border-color: #86efac;
    }
    .admin-btn-resume:hover { background: #bbf7d0; }
    .admin-btn-danger {
        background: #fef2f2; color: #dc2626; border-color: #fca5a5;
    }
    .admin-btn-danger:hover { background: #fecaca; }

    .admin-status-badge.중지 { background: #fff7ed; color: #ea580c; }
    .admin-status-badge.당일마감 { background: #fef2f2; color: #dc2626; font-size: 11px; margin-left: 4px; }

    /* 토글 슬라이더 */
    #promoSlider:before {
        position: absolute; content: ""; height: 18px; width: 18px;
        left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s;
    }
    #promoToggle:checked + #promoSlider { background: #22c55e; }
    #promoToggle:checked + #promoSlider:before { transform: translateX(20px); }
    </style>
</head>
<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-logo">카비서 관리자</a>
            <nav class="admin-nav">
                <a href="{{ url_for('admin.dashboard') }}">대시보드</a>
                <a href="{{ url_for('admin.campaigns') }}" class="active">캠페인</a>
                <a href="{{ url_for('admin.quotes') }}">견적서</a>
                <a href="{{ url_for('admin.chat_list') }}">대화이력</a>
                <a href="{{ url_for('admin.reviews') }}">검수</a>
                <a href="{{ url_for('admin.settlement') }}">정산</a>
                <a href="{{ url_for('admin.activity_logs') }}">활동로그</a>
                <a href="{{ url_for('admin.reviewers') }}">리뷰어</a>
                <a href="{{ url_for('admin.inquiries') }}">문의{% if pending_inquiry_count %}<span style="background:#ef4444;color:#fff;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;">{{ pending_inquiry_count }}</span>{% endif %}</a>
                <a href="{{ url_for('admin.spreadsheet') }}">데이터</a>
                <a href="{{ url_for('admin.guide') }}">가이드</a>
                <a href="{{ url_for('admin.settings') }}">설정</a>
                <a href="{{ url_for('admin.logout') }}">로그아웃</a>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <h1>캠페인 관리</h1>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="admin-flash">
            {% for msg in messages %}
            <p>{{ msg }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div style="margin-bottom: 16px; display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
            <a href="{{ url_for('admin.campaign_new') }}" class="admin-btn admin-btn-primary">신규 등록</a>
            <div style="display:flex;align-items:center;gap:8px;margin-left:auto;padding:8px 16px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;">
                <span style="font-size:13px;font-weight:600;color:#64748b;">카톡 홍보</span>
                <label class="toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;">
                    <input type="checkbox" id="promoToggle" style="opacity:0;width:0;height:0;">
                    <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;border-radius:24px;transition:0.3s;" id="promoSlider"></span>
                </label>
                <span id="promoLabel" style="font-size:13px;font-weight:600;color:#94a3b8;">--</span>
            </div>
        </div>

        {% if campaigns %}
        <div class="admin-table-wrap">
            <table class="admin-table" id="campaignTable">
                <thead>
                    <tr>
                        <th style="width:28px;"></th>
                        <th>캠페인명</th>
                        <th>업체명</th>
                        <th class="num-cell">총수량</th>
                        <th class="num-cell">오늘/목표</th>
                        <th class="num-cell">구매</th>
                        <th class="num-cell">리뷰</th>
                        <th class="num-cell">정산</th>
                        <th class="progress-cell">달성률</th>
                        <th>상태</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in campaigns %}
                    {% set total = (c.get('총수량', '0')|int) or 0 %}
                    {% set active = (c.get('신청수', '0')|int) or 0 %}
                    {% set today = (c.get('오늘수량', '0')|int) or 0 %}
                    {% set target = (c.get('오늘목표', '0')|int) or 0 %}
                    {% set purchase = (c.get('구매완료', '0')|int) or 0 %}
                    {% set review = (c.get('리뷰완료', '0')|int) or 0 %}
                    {% set settle = (c.get('정산완료', '0')|int) or 0 %}
                    {% set rate = ((active / total * 100)|round(1)) if total > 0 else 0 %}
                    {% set rate_class = 'high' if rate >= 70 else ('mid' if rate >= 40 else 'low') %}
                    <!-- 메인 행 -->
                    <tr class="campaign-row" data-idx="{{ loop.index0 }}" onclick="toggleDetail({{ loop.index0 }})">
                        <td><button type="button" class="toggle-btn" id="toggleBtn{{ loop.index0 }}">&#9660;</button></td>
                        <td style="font-weight:600;">{{ c.get('캠페인명', '') or c.get('상품명', '') }}</td>
                        <td>{{ c.get('업체명', '') }}</td>
                        <td class="num-cell">{{ total }}</td>
                        <td class="num-cell">
                            {% if target > 0 %}
                                {% if today >= target %}
                                <span class="today-done">{{ today }}/{{ target }}</span>
                                {% elif today > 0 %}
                                <span class="today-normal">{{ today }}/{{ target }}</span>
                                {% else %}
                                <span style="color:#64748b;">0/{{ target }}</span>
                                {% endif %}
                            {% else %}
                            <span style="color:#cbd5e1;">-</span>
                            {% endif %}
                        </td>
                        <td class="num-cell">{{ purchase }}</td>
                        <td class="num-cell">{{ review }}</td>
                        <td class="num-cell">{{ settle }}</td>
                        <td class="progress-cell">
                            <div class="progress-bar-mini">
                                <div class="progress-bar-fill {{ rate_class }}" style="width:{{ [rate, 100]|min }}%"></div>
                            </div>
                            <span class="progress-pct {{ rate_class }}">{{ active }}/{{ total }} ({{ rate }}%)</span>
                        </td>
                        <td>
                            <span class="admin-status-badge {{ c.get('상태', '모집중') }}">{{ c.get('상태', '모집중') }}</span>
                            {% if c.get('_daily_closed') %}<span class="admin-status-badge 당일마감">당일마감</span>{% endif %}
                        </td>
                        <td>
                            <div class="campaign-actions">
                                <a href="{{ url_for('admin.spreadsheet', campaign=c.get('캠페인ID', '')) }}"
                                   class="admin-btn admin-btn-sm" onclick="event.stopPropagation();" style="background:#e3f2fd;color:#1565c0;">진행현황</a>
                                <button type="button" class="admin-btn admin-btn-sm"
                                        onclick="event.stopPropagation(); copyLink('{{ c.get('캠페인ID', '') }}', this);"
                                        style="background:#f0fdf4;color:#16a34a;">링크</button>
                                <a href="{{ url_for('admin.campaign_edit', campaign_id=c.get('캠페인ID', '')) }}"
                                   class="admin-btn admin-btn-sm" onclick="event.stopPropagation();">수정</a>
                                <a href="{{ url_for('admin.campaign_new', copy=c.get('캠페인ID', '')) }}"
                                   class="admin-btn admin-btn-sm" onclick="event.stopPropagation();" style="background:#f0f4ff;color:#4a6cf7;">복사</a>
                                <button type="button" class="admin-btn admin-btn-sm"
                                        onclick="event.stopPropagation(); openPhotoModal('{{ c.get('캠페인ID', '') }}', '{{ (c.get('캠페인명', '') or c.get('상품명', '')) | e }}');"
                                        style="background:#fef3c7;color:#92400e;">사진</button>
                                {% if c.get('상태', '모집중') == '중지' %}
                                <button type="button" class="admin-btn admin-btn-sm admin-btn-resume"
                                        onclick="event.stopPropagation(); campaignResume('{{ c.get('캠페인ID', '') }}', this);">재개</button>
                                {% else %}
                                <button type="button" class="admin-btn admin-btn-sm admin-btn-pause"
                                        onclick="event.stopPropagation(); campaignPause('{{ c.get('캠페인ID', '') }}', this);">중지</button>
                                {% endif %}
                                <button type="button" class="admin-btn admin-btn-sm admin-btn-danger"
                                        onclick="event.stopPropagation(); campaignDelete('{{ c.get('캠페인ID', '') }}', '{{ (c.get('캠페인명', '') or c.get('상품명', '')) | e }}', this);">삭제</button>
                            </div>
                        </td>
                    </tr>
                    <!-- 상세 펼침 행 -->
                    <tr class="detail-row" id="detailRow{{ loop.index0 }}">
                        <td colspan="11" class="detail-cell">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">플랫폼</div>
                                    <div class="detail-value">{{ c.get('플랫폼', '-') or '-' }}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">구매시간</div>
                                    <div class="detail-value">{{ c.get('구매가능시간', '') or '24시간' }}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">리뷰비</div>
                                    <div class="detail-value">{{ c.get('리뷰비', '-') or '-' }}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">시작일</div>
                                    <div class="detail-value">{{ c.get('시작일', '-') or '-' }}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">키워드</div>
                                    <div class="detail-value">{{ c.get('키워드', '-') or '-' }}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">상품링크</div>
                                    <div class="detail-value">
                                        {% set link = c.get('상품링크', '') %}
                                        {% if link %}
                                        <a href="{{ link }}" target="_blank" rel="noopener">{{ link[:50] }}{% if link|length > 50 %}...{% endif %}</a>
                                        {% else %}-{% endif %}
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">상품이미지</div>
                                    <div class="detail-value">
                                        {% set img = c.get('상품이미지', '') %}
                                        {% if img %}
                                        <img src="{{ img.replace('/file/d/', '/thumbnail?id=').replace('/view', '&sz=w300') if '/file/d/' in img else img }}"
                                             alt="상품이미지" style="max-width:200px;border-radius:8px;border:1px solid #ddd;"
                                             onerror="this.style.display='none'">
                                        {% else %}-{% endif %}
                                    </div>
                                </div>
                            </div>
                            <!-- 일별 일정 -->
                            <div style="margin-top:8px;">
                                <div class="detail-label">일별 일정</div>
                                {% set schedule = c.get('일정', []) %}
                                {% set start_date = c.get('시작일', '') %}
                                {% if schedule %}
                                <div class="schedule-blocks">
                                    {% for qty in schedule %}
                                    {% set day_class = '' %}
                                    {% if start_date %}
                                    {# day_index calculated via JS below #}
                                    {% endif %}
                                    <div class="schedule-block" data-day="{{ loop.index0 }}" data-start="{{ start_date }}">
                                        <div class="day-num">{{ loop.index }}일차</div>
                                        <div class="day-qty">{{ qty }}</div>
                                    </div>
                                    {% endfor %}
                                    <div class="schedule-block" style="background:#fff3e0;border-color:#ffcc80;">
                                        <div class="day-num">합계</div>
                                        <div class="day-qty">{{ schedule|sum }}</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="schedule-none">일정 없음</div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="admin-empty">등록된 캠페인이 없습니다.</p>
        {% endif %}

        <!-- 사진 세트 모달 -->
        <div id="photoModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
            <div style="max-width:640px;margin:40px auto;background:#fff;border-radius:12px;padding:24px;position:relative;">
                <button onclick="closePhotoModal()" style="position:absolute;top:12px;right:16px;border:none;background:none;font-size:20px;cursor:pointer;color:#999;">&times;</button>
                <h2 style="margin:0 0 4px;" id="photoModalTitle">사진 세트 관리</h2>
                <p style="color:#64748b;font-size:13px;margin:0 0 16px;" id="photoModalSub"></p>

                <!-- 현황 -->
                <div id="photoSetsInfo" style="margin-bottom:16px;">
                    <p style="color:#94a3b8;font-size:13px;">로딩 중...</p>
                </div>

                <!-- 업로드 -->
                <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;">
                    <h3 style="font-size:14px;margin:0 0 8px;color:#334155;">사진 업로드</h3>
                    <p style="font-size:12px;color:#94a3b8;margin:0 0 8px;">파일명 규칙: 1.jpg, 2-1.jpg, 2-2.jpg, 3.jpg ... (세트번호-인덱스)</p>
                    <input type="file" id="photoFiles" multiple accept="image/*" style="margin-bottom:8px;font-size:13px;">
                    <div id="photoPreview" style="font-size:12px;color:#64748b;margin-bottom:8px;"></div>
                    <button onclick="uploadPhotos()" class="admin-btn admin-btn-primary" style="font-size:13px;padding:6px 16px;" id="btnUploadPhotos">업로드</button>
                    <span id="uploadStatus" style="font-size:13px;margin-left:8px;"></span>
                </div>

                <!-- 배분 -->
                <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:16px;">
                    <h3 style="font-size:14px;margin:0 0 8px;color:#166534;">배분 + 알림</h3>
                    <p style="font-size:12px;color:#64748b;margin:0 0 8px;">미할당 리뷰어에게 세트를 순차 배분하고, 리뷰 미제출자에게 카톡 알림을 보냅니다.</p>
                    <button onclick="distributePhotos()" class="admin-btn" style="font-size:13px;padding:6px 16px;background:#16a34a;color:#fff;border-color:#16a34a;" id="btnDistribute">배분 + 알림</button>
                    <span id="distributeStatus" style="font-size:13px;margin-left:8px;"></span>
                </div>
            </div>
        </div>
    </main>

    <script>
    // 홍보 토글
    (function() {
        var toggle = document.getElementById('promoToggle');
        var label = document.getElementById('promoLabel');
        // 초기 상태 로드
        fetch('/admin/api/promotion/status')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.enabled === null) {
                    label.textContent = '서버 오프라인';
                    label.style.color = '#ef4444';
                    toggle.disabled = true;
                } else {
                    toggle.checked = data.enabled;
                    label.textContent = data.enabled ? 'ON' : 'OFF';
                    label.style.color = data.enabled ? '#16a34a' : '#94a3b8';
                }
            })
            .catch(function() {
                label.textContent = '연결 실패';
                label.style.color = '#ef4444';
            });
        // 토글 변경
        toggle.addEventListener('change', function() {
            var enabled = toggle.checked;
            // ON으로 변경 시 비밀번호 확인
            if (enabled) {
                var pw = prompt('홍보를 시작하려면 비밀번호를 입력하세요:');
                if (pw === null || pw.trim() !== '4444') {
                    toggle.checked = false;
                    if (pw !== null) {
                        label.textContent = '비밀번호 오류';
                        label.style.color = '#ef4444';
                        setTimeout(function() {
                            label.textContent = 'OFF';
                            label.style.color = '#94a3b8';
                        }, 2000);
                    }
                    return;
                }
            }
            label.textContent = '변경중...';
            label.style.color = '#94a3b8';
            fetch('/admin/api/promotion/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: enabled})
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.ok) {
                    label.textContent = enabled ? 'ON' : 'OFF';
                    label.style.color = enabled ? '#16a34a' : '#94a3b8';
                } else {
                    toggle.checked = !enabled;
                    label.textContent = data.error || '실패';
                    label.style.color = '#ef4444';
                    setTimeout(function() {
                        label.textContent = toggle.checked ? 'ON' : 'OFF';
                        label.style.color = toggle.checked ? '#16a34a' : '#94a3b8';
                    }, 2000);
                }
            })
            .catch(function() {
                toggle.checked = !enabled;
                label.textContent = '연결 실패';
                label.style.color = '#ef4444';
            });
        });
    })();

    function copyLink(campaignId, btn) {
        var url = location.origin + '/campaign/' + campaignId;
        navigator.clipboard.writeText(url).then(function() {
            var orig = btn.textContent;
            btn.textContent = '복사됨!';
            btn.style.background = '#16a34a';
            btn.style.color = '#fff';
            setTimeout(function() {
                btn.textContent = orig;
                btn.style.background = '#f0fdf4';
                btn.style.color = '#16a34a';
            }, 1500);
        });
    }

    function toggleDetail(idx) {
        var row = document.getElementById('detailRow' + idx);
        var btn = document.getElementById('toggleBtn' + idx);
        if (row.classList.contains('open')) {
            row.classList.remove('open');
            btn.classList.remove('open');
        } else {
            row.classList.add('open');
            btn.classList.add('open');
        }
    }

    // ──── 캠페인 중지/재개/삭제 ────

    function campaignPause(campaignId, btn) {
        if (!confirm('이 캠페인을 중지하시겠습니까?')) return;
        btn.disabled = true;
        fetch('/admin/api/campaigns/' + campaignId + '/pause', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                // 상태 배지 업데이트
                var row = btn.closest('tr');
                var badge = row.querySelector('.admin-status-badge');
                if (badge) {
                    badge.className = 'admin-status-badge 중지';
                    badge.textContent = '중지';
                }
                // 버튼을 "재개"로 교체
                var resumeBtn = document.createElement('button');
                resumeBtn.type = 'button';
                resumeBtn.className = 'admin-btn admin-btn-sm admin-btn-resume';
                resumeBtn.textContent = '재개';
                resumeBtn.onclick = function(e) {
                    e.stopPropagation();
                    campaignResume(campaignId, resumeBtn);
                };
                btn.parentNode.replaceChild(resumeBtn, btn);
            } else {
                alert('중지 실패: ' + (data.message || ''));
                btn.disabled = false;
            }
        })
        .catch(function() { alert('요청 실패'); btn.disabled = false; });
    }

    function campaignResume(campaignId, btn) {
        if (!confirm('이 캠페인을 재개하시겠습니까?')) return;
        btn.disabled = true;
        fetch('/admin/api/campaigns/' + campaignId + '/resume', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                var row = btn.closest('tr');
                var badge = row.querySelector('.admin-status-badge');
                if (badge) {
                    badge.className = 'admin-status-badge 모집중';
                    badge.textContent = '모집중';
                }
                // 버튼을 "중지"로 교체
                var pauseBtn = document.createElement('button');
                pauseBtn.type = 'button';
                pauseBtn.className = 'admin-btn admin-btn-sm admin-btn-pause';
                pauseBtn.textContent = '중지';
                pauseBtn.onclick = function(e) {
                    e.stopPropagation();
                    campaignPause(campaignId, pauseBtn);
                };
                btn.parentNode.replaceChild(pauseBtn, btn);
            } else {
                alert('재개 실패: ' + (data.message || ''));
                btn.disabled = false;
            }
        })
        .catch(function() { alert('요청 실패'); btn.disabled = false; });
    }

    function campaignDelete(campaignId, productName, btn) {
        if (!confirm('캠페인 "' + productName + '"을(를) 삭제하시겠습니까?\n연결된 진행건도 모두 삭제됩니다.')) return;
        btn.disabled = true;
        fetch('/admin/api/campaigns/' + campaignId, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                // 행 삭제 (메인 행 + 상세 행)
                var row = btn.closest('tr');
                var idx = row.getAttribute('data-idx');
                var detailRow = document.getElementById('detailRow' + idx);
                if (detailRow) detailRow.remove();
                row.remove();
            } else {
                alert('삭제 실패: ' + (data.message || ''));
                btn.disabled = false;
            }
        })
        .catch(function() { alert('요청 실패'); btn.disabled = false; });
    }

    // 일정 블록에 오늘 하이라이트 적용
    (function() {
        var today = new Date();
        today.setHours(0,0,0,0);
        var blocks = document.querySelectorAll('.schedule-block[data-start]');
        blocks.forEach(function(block) {
            var startStr = block.getAttribute('data-start');
            var dayIdx = parseInt(block.getAttribute('data-day'));
            if (!startStr || isNaN(dayIdx)) return;
            var parts = startStr.split('-');
            if (parts.length !== 3) return;
            var startDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            startDate.setHours(0,0,0,0);
            var diffDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            if (dayIdx === diffDays) {
                block.classList.add('today');
            } else if (dayIdx < diffDays) {
                block.classList.add('past');
            }
        });
    })();

    // ──── 사진 세트 모달 ────

    var _photoModalCampaignId = '';

    function openPhotoModal(campaignId, campaignName) {
        _photoModalCampaignId = campaignId;
        document.getElementById('photoModalTitle').textContent = '사진 세트 관리';
        document.getElementById('photoModalSub').textContent = campaignName;
        document.getElementById('photoFiles').value = '';
        document.getElementById('photoPreview').textContent = '';
        document.getElementById('uploadStatus').textContent = '';
        document.getElementById('distributeStatus').textContent = '';
        document.getElementById('photoModal').style.display = 'block';
        loadPhotoSets();
    }

    function closePhotoModal() {
        document.getElementById('photoModal').style.display = 'none';
    }

    // 모달 배경 클릭으로 닫기
    document.getElementById('photoModal').addEventListener('click', function(e) {
        if (e.target === this) closePhotoModal();
    });

    function loadPhotoSets() {
        var container = document.getElementById('photoSetsInfo');
        container.innerHTML = '<p style="color:#94a3b8;font-size:13px;">로딩 중...</p>';
        fetch('/admin/api/campaign/' + _photoModalCampaignId + '/photo-sets')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.ok) { container.innerHTML = '<p style="color:#ef4444;">조회 실패</p>'; return; }
                var sets = data.sets || {};
                var keys = Object.keys(sets).sort(function(a,b){ return parseInt(a)-parseInt(b); });
                if (keys.length === 0) {
                    container.innerHTML = '<p style="color:#94a3b8;font-size:13px;">등록된 사진이 없습니다.</p>';
                    document.getElementById('btnDistribute').disabled = true;
                    return;
                }
                document.getElementById('btnDistribute').disabled = false;
                var html = '<div style="font-size:13px;margin-bottom:8px;"><strong>' + data.total_sets + '세트</strong> 등록 / <strong>' + data.unassigned_reviewers + '명</strong> 미할당</div>';
                html += '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
                html += '<thead><tr style="border-bottom:1px solid #e2e8f0;"><th style="text-align:left;padding:4px 8px;">세트</th><th style="text-align:left;padding:4px 8px;">사진 수</th><th style="text-align:left;padding:4px 8px;">할당</th></tr></thead><tbody>';
                keys.forEach(function(sn) {
                    var s = sets[sn];
                    var assignText = s.assigned_to ? '<span style="color:#16a34a;">' + s.assigned_to + '</span>' : '<span style="color:#94a3b8;">미할당</span>';
                    html += '<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:4px 8px;">세트 ' + sn + '</td><td style="padding:4px 8px;">' + s.photos.length + '장</td><td style="padding:4px 8px;">' + assignText + '</td></tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            })
            .catch(function() { container.innerHTML = '<p style="color:#ef4444;">연결 실패</p>'; });
    }

    // 파일 선택 시 미리보기
    document.getElementById('photoFiles').addEventListener('change', function() {
        var files = this.files;
        if (!files || files.length === 0) { document.getElementById('photoPreview').textContent = ''; return; }
        var setMap = {};
        for (var i = 0; i < files.length; i++) {
            var name = files[i].name.replace(/\.[^.]+$/, '').trim();
            var m = name.match(/^(\d+)(?:-(\d+))?$/);
            if (m) {
                var sn = parseInt(m[1]);
                setMap[sn] = (setMap[sn] || 0) + 1;
            }
        }
        var keys = Object.keys(setMap).sort(function(a,b){ return parseInt(a)-parseInt(b); });
        if (keys.length === 0) {
            document.getElementById('photoPreview').textContent = '파일명 형식이 맞지 않습니다 (예: 1.jpg, 2-1.jpg)';
            document.getElementById('photoPreview').style.color = '#ef4444';
            return;
        }
        var summary = keys.map(function(k) { return '세트' + k + ': ' + setMap[k] + '장'; }).join(', ');
        document.getElementById('photoPreview').textContent = keys.length + '세트 — ' + summary;
        document.getElementById('photoPreview').style.color = '#64748b';
    });

    function uploadPhotos() {
        var files = document.getElementById('photoFiles').files;
        if (!files || files.length === 0) { alert('파일을 선택하세요'); return; }
        var btn = document.getElementById('btnUploadPhotos');
        var status = document.getElementById('uploadStatus');
        btn.disabled = true;
        status.textContent = '업로드 중...';
        status.style.color = '#64748b';

        var formData = new FormData();
        for (var i = 0; i < files.length; i++) {
            formData.append('photos', files[i]);
        }

        fetch('/admin/api/campaign/' + _photoModalCampaignId + '/upload-photos', {
            method: 'POST',
            body: formData,
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            if (data.ok) {
                status.textContent = data.uploaded + '장 업로드 완료';
                status.style.color = '#16a34a';
                loadPhotoSets();
            } else {
                status.textContent = '실패: ' + (data.error || '');
                status.style.color = '#ef4444';
            }
        })
        .catch(function() { btn.disabled = false; status.textContent = '연결 실패'; status.style.color = '#ef4444'; });
    }

    function distributePhotos() {
        var btn = document.getElementById('btnDistribute');
        var status = document.getElementById('distributeStatus');
        if (!confirm('미할당 리뷰어에게 사진 세트를 배분하고 카톡 알림을 보내시겠습니까?')) return;
        btn.disabled = true;
        status.textContent = '배분 중...';
        status.style.color = '#64748b';

        fetch('/admin/api/campaign/' + _photoModalCampaignId + '/distribute-photos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            if (data.ok) {
                status.textContent = data.assigned + '명 배분, ' + data.notified + '명 카톡 알림 완료';
                status.style.color = '#16a34a';
                if (data.message) status.textContent = data.message;
                loadPhotoSets();
            } else {
                status.textContent = '실패: ' + (data.error || '');
                status.style.color = '#ef4444';
            }
        })
        .catch(function() { btn.disabled = false; status.textContent = '연결 실패'; status.style.color = '#ef4444'; });
    }
    </script>
</body>
</html>
