<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카비서 관리자 - 데이터</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
    /* 스프레드시트 전용: 전체 폭 사용 */
    .admin-main {
        max-width: none !important;
        padding: 24px 16px !important;
    }
    .filter-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
        align-items: center;
        flex-wrap: wrap;
    }
    .filter-bar label {
        font-size: 13px;
        font-weight: 600;
        color: #555;
    }
    .filter-bar select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
        outline: none;
    }
    .filter-bar select:focus { border-color: #fee500; }
    .filter-bar .btn-filter {
        padding: 8px 18px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fee500;
        font-size: 14px;
        font-weight: 600;
        color: #3c1e1e;
        cursor: pointer;
        text-decoration: none;
    }
    .filter-bar .btn-filter:hover { background: #e6cf00; }

    .spreadsheet-wrap {
        overflow-x: auto;
        margin-bottom: 24px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
    }
    .spreadsheet-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        white-space: nowrap;
    }
    .spreadsheet-table thead th {
        background: #f8f8f8;
        border-bottom: 2px solid #ddd;
        padding: 6px 6px;
        font-size: 11px;
        font-weight: 700;
        color: #555;
        text-align: left;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    .spreadsheet-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
    }
    .spreadsheet-table tbody tr:hover {
        background: #fefce8;
    }
    .spreadsheet-table tbody td {
        padding: 4px 6px;
        color: #333;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .spreadsheet-table tbody td.readonly {
        color: #888;
        background: #fafafa;
    }
    .spreadsheet-table tbody td.editable {
        border-bottom: 1px dotted #bbb;
        cursor: pointer;
    }
    .spreadsheet-table tbody td.editable:hover {
        background: #fffde7;
    }
    .spreadsheet-table tbody td input.cell-input {
        width: 100%;
        min-width: 60px;
        padding: 3px 5px;
        border: 1px solid #fee500;
        border-radius: 4px;
        font-size: 12px;
        outline: none;
        background: #fffff0;
        box-sizing: border-box;
    }
    .spreadsheet-table tbody td select.cell-select {
        padding: 3px 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        background: #fff;
        outline: none;
    }
    .spreadsheet-table tbody td select.cell-select:focus {
        border-color: #fee500;
    }
    .btn-delete {
        padding: 2px 8px;
        border: none;
        border-radius: 4px;
        background: #ef4444;
        color: #fff;
        font-size: 11px;
        cursor: pointer;
        font-weight: 600;
    }
    .btn-delete:hover { background: #dc2626; }
    .btn-kakao {
        padding: 2px 8px;
        border: none;
        border-radius: 4px;
        background: #fae100;
        color: #3c1e1e;
        font-size: 11px;
        cursor: pointer;
        font-weight: 600;
    }
    .btn-kakao:hover { background: #e6cf00; }
    .btn-capture {
        display: inline-block;
        padding: 2px 6px;
        border: none;
        border-radius: 4px;
        font-size: 10px;
        cursor: pointer;
        font-weight: 600;
        margin: 1px;
    }
    .btn-capture.purchase {
        background: #dbeafe;
        color: #1d4ed8;
    }
    .btn-capture.purchase:hover { background: #bfdbfe; }
    .btn-capture.review {
        background: #dcfce7;
        color: #15803d;
    }
    .btn-capture.review:hover { background: #bbf7d0; }
    .capture-modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    .capture-modal-overlay.open { display: flex; }
    .capture-modal {
        background: #fff;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    .capture-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 20px;
        border-bottom: 1px solid #e5e7eb;
    }
    .capture-modal-header h3 { margin: 0; font-size: 16px; }
    .capture-modal-close {
        border: none; background: none; font-size: 22px; cursor: pointer; color: #666;
    }
    .capture-modal-body {
        flex: 1;
        display: flex;
        gap: 12px;
        padding: 16px;
        overflow: hidden;
    }
    .capture-modal-body .img-col {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .capture-modal-body .img-col .img-label {
        font-size: 13px;
        font-weight: 700;
        color: #555;
        margin-bottom: 6px;
        text-align: center;
    }
    .capture-modal-body .img-col iframe {
        flex: 1;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
    }
    .capture-modal-body .img-col .no-img {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 14px;
        border: 1px dashed #ddd;
        border-radius: 8px;
    }
    .bulk-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        align-items: center;
    }
    .timeout-panel {
        margin-bottom: 20px;
        border: 1px solid #fbbf24;
        border-radius: 8px;
        background: #fffbeb;
        padding: 12px 16px;
    }
    .timeout-panel h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: #92400e;
    }
    .timeout-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 4px 0;
        font-size: 13px;
        color: #78350f;
    }
    .timeout-item .time-remaining {
        font-weight: 700;
        min-width: 50px;
    }
    .timeout-item .time-remaining.urgent { color: #ef4444; }

    @keyframes flashGreen {
        0% { background-color: #bbf7d0; }
        100% { background-color: transparent; }
    }
    .cell-saved {
        animation: flashGreen 0.8s ease-out;
    }

    .result-count {
        font-size: 14px;
        color: #888;
        margin-bottom: 12px;
    }
    .result-count strong { color: #333; }
    </style>
</head>
<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-logo">카비서 관리자</a>
            <nav class="admin-nav">
                <a href="{{ url_for('admin.dashboard') }}">대시보드</a>
                <a href="{{ url_for('admin.campaigns') }}">캠페인</a>
                <a href="{{ url_for('admin.quotes') }}">견적서</a>
                <a href="{{ url_for('admin.chat_list') }}">대화이력</a>
                <a href="{{ url_for('admin.reviews') }}">검수</a>
                <a href="{{ url_for('admin.settlement') }}">정산</a>
                <a href="{{ url_for('admin.activity_logs') }}">활동로그</a>
                <a href="{{ url_for('admin.reviewers') }}">리뷰어</a>
                <a href="{{ url_for('admin.inquiries') }}">문의{% if pending_inquiry_count %}<span style="background:#ef4444;color:#fff;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;">{{ pending_inquiry_count }}</span>{% endif %}</a>
                <a href="{{ url_for('admin.spreadsheet') }}" class="active">데이터</a>
                <a href="{{ url_for('admin.guide') }}">가이드</a>
                <a href="{{ url_for('admin.settings') }}">설정</a>
                <a href="{{ url_for('admin.logout') }}">로그아웃</a>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <h1>데이터 관리</h1>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="flash-messages">
            {% for msg in messages %}
            <div class="flash">{{ msg }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Filters -->
        <div class="filter-bar">
            <label>캠페인:</label>
            <select id="filterCampaign">
                <option value="">전체</option>
                {% for c in campaigns|default([]) %}
                <option value="{{ c.get('캠페인ID', '') }}" {% if campaign_filter == c.get('캠페인ID', '')|string %}selected{% endif %}>{{ c.get('캠페인명', '') or c.get('상품명', '') }}</option>
                {% endfor %}
            </select>
            <label>상태:</label>
            <select id="filterStatus">
                <option value="">전체</option>
                {% for s in ['신청','가이드전달','구매캡쳐대기','리뷰대기','리뷰제출','입금대기','입금완료','타임아웃취소'] %}
                <option value="{{ s }}" {% if status_filter == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
            <button class="btn-filter" onclick="applyFilters()">필터 적용</button>
        </div>

        <!-- 타임아웃 모니터 -->
        <div id="timeoutPanel" class="timeout-panel" style="display:none;">
            <h3>⏰ 타임아웃 대기 세션</h3>
            <div id="timeoutList"></div>
        </div>

        <div class="result-count" style="display:flex;align-items:center;gap:16px;">
            <span>검색 결과: <strong>{{ items|default([])|length }}</strong>건</span>
            <button class="btn-kakao" style="font-size:13px;padding:6px 16px;" onclick="bulkKakao()">선택 카톡 발송</button>
        </div>

        <!-- Table -->
        {% if items %}
        <div class="spreadsheet-wrap">
            <table class="spreadsheet-table" id="spreadsheetTable">
                <thead>
                    <tr>
                        <th style="width:30px;"><input type="checkbox" id="checkAll"></th>
                        <th>ID</th>
                        <th>신청일시</th>
                        <th>제품명</th>
                        <th>진행자</th>
                        <th>수취인명</th>
                        <th>연락처</th>
                        <th>은행</th>
                        <th>계좌</th>
                        <th>예금주</th>
                        <th>아이디</th>
                        <th>주문번호</th>
                        <th>주소</th>
                        <th>상태</th>
                        <th>구매일</th>
                        <th>리뷰기한</th>
                        <th>리뷰비</th>
                        <th>입금금액</th>
                        <th>비고</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr data-id="{{ item.get('_row_idx', '') }}">
                        <td><input type="checkbox" class="row-check" value="{{ item.get('_row_idx', '') }}"></td>
                        <td class="readonly">{{ item.get('_row_idx', '') }}</td>
                        <td class="readonly">{{ item.get('날짜', '') }}</td>
                        <td class="readonly" style="max-width:100px;">{{ item.get('제품명', '') }}</td>
                        <td class="readonly">{{ item.get('진행자이름', '') }}</td>
                        <td class="editable" data-field="수취인명">{{ item.get('수취인명', '') }}</td>
                        <td class="editable" data-field="연락처">{{ item.get('연락처', '') }}</td>
                        <td class="editable" data-field="은행">{{ item.get('은행', '') }}</td>
                        <td class="editable" data-field="계좌">{{ item.get('계좌', '') }}</td>
                        <td class="editable" data-field="예금주">{{ item.get('예금주', '') }}</td>
                        <td class="editable" data-field="아이디">{{ item.get('아이디', '') }}</td>
                        <td class="editable" data-field="주문번호">{{ item.get('주문번호', '') }}</td>
                        <td class="editable" data-field="주소">{{ item.get('주소', '') }}</td>
                        <td data-field="상태">
                            <select class="cell-select" data-field="상태" data-id="{{ item.get('_row_idx', '') }}" onchange="saveSelect(this)">
                                {% for s in ['신청','가이드전달','구매캡쳐대기','리뷰대기','리뷰제출','입금대기','입금완료','타임아웃취소'] %}
                                <option value="{{ s }}" {% if item.get('상태', '') == s %}selected{% endif %}>{{ s }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="editable" data-field="구매일">{{ item.get('구매일', '') }}</td>
                        <td class="editable" data-field="리뷰기한">{{ item.get('리뷰기한', '') }}</td>
                        <td class="editable" data-field="리뷰비">{{ item.get('리뷰비', '') }}</td>
                        <td class="editable" data-field="입금금액">{{ item.get('입금금액', '') }}</td>
                        <td class="editable" data-field="비고" style="max-width:250px;">
                            <span class="remark-text">{{ item.get('비고', '') }}</span>
                            {% if item.get('구매캡쳐링크') %}
                            <button class="btn-capture purchase" onclick="event.stopPropagation();openCapture({{ item.get('_row_idx', 0) }},'purchase')" title="구매내역 캡쳐 보기">구매캡쳐</button>
                            {% endif %}
                            {% if item.get('리뷰캡쳐링크') %}
                            <button class="btn-capture review" onclick="event.stopPropagation();openCapture({{ item.get('_row_idx', 0) }},'review')" title="리뷰 캡쳐 보기">리뷰사진</button>
                            {% endif %}
                        </td>
                        <td style="white-space:nowrap;">
                            <button class="btn-kakao" onclick="sendKakao({{ item.get('_row_idx', 0) }})">카톡</button>
                            <button class="btn-delete" onclick="deleteRow(this, '{{ item.get('_row_idx', '') }}')">삭제</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="admin-empty">데이터가 없습니다. 필터를 변경해보세요.</p>
        {% endif %}
    </main>

    <!-- 카톡 발송 모달 -->
    <div id="kakaoModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
        <div style="background:#fff;border-radius:12px;padding:24px;max-width:420px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h3 style="margin:0;">카카오톡 발송</h3>
                <button onclick="closeKakaoModal()" style="border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
            </div>
            <p id="kakaoTarget" style="color:#666;margin-bottom:12px;">대상: 1건</p>
            <textarea id="kakaoMessage" placeholder="커스텀 메시지 (비우면 상태별 기본 메시지)" rows="3" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;resize:vertical;box-sizing:border-box;"></textarea>
            <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end;">
                <button onclick="closeKakaoModal()" style="padding:8px 16px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;">취소</button>
                <button onclick="confirmKakaoSend()" style="padding:8px 16px;border:none;border-radius:6px;background:#fae100;color:#3c1e1e;cursor:pointer;font-weight:600;">발송</button>
            </div>
        </div>
    </div>

    <!-- 캡쳐 이미지 모달 -->
    <div id="captureModal" class="capture-modal-overlay">
        <div class="capture-modal">
            <div class="capture-modal-header">
                <h3 id="captureModalTitle">캡쳐 보기</h3>
                <button class="capture-modal-close" onclick="closeCapture()">&times;</button>
            </div>
            <div class="capture-modal-body">
                <div class="img-col" style="flex:1;">
                    <div id="captureImg"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- Capture Data ---
    var CAPTURE_DATA = {
        {% for item in items %}
        {{ item.get('_row_idx', 0) }}: {
            purchase: {{ item.get('구매캡쳐링크', '')|tojson }},
            review: {{ item.get('리뷰캡쳐링크', '')|tojson }}
        },
        {% endfor %}
    };

    function drivePreviewUrl(link) {
        if (!link) return '';
        var m = link.match(/\/d\/([^\/]+)/);
        if (m) return 'https://drive.google.com/file/d/' + m[1] + '/preview';
        return link;
    }

    function renderCaptureFrame(containerId, link) {
        var el = document.getElementById(containerId);
        var previewUrl = drivePreviewUrl(link);
        if (previewUrl) {
            el.innerHTML = '<iframe src="' + previewUrl + '" frameborder="0" allowfullscreen></iframe>';
        } else {
            el.innerHTML = '<div class="no-img">미제출</div>';
        }
    }

    function openCapture(progressId, type) {
        var data = CAPTURE_DATA[progressId];
        if (!data) return;
        var title = type === 'purchase' ? '구매내역 캡쳐' : '리뷰 캡쳐';
        var link = type === 'purchase' ? data.purchase : data.review;
        document.getElementById('captureModalTitle').textContent = title + ' (ID: ' + progressId + ')';
        renderCaptureFrame('captureImg', link);
        document.getElementById('captureModal').classList.add('open');
    }

    function closeCapture() {
        document.getElementById('captureModal').classList.remove('open');
        document.getElementById('captureImg').innerHTML = '';
    }

    document.getElementById('captureModal').addEventListener('click', function(e) {
        if (e.target === this) closeCapture();
    });

    // --- Kakao Send ---
    var _kakaoIds = [];

    function sendKakao(progressId) {
        _kakaoIds = [progressId];
        document.getElementById('kakaoTarget').textContent = '대상: 1건';
        document.getElementById('kakaoMessage').value = '';
        document.getElementById('kakaoModal').style.display = 'flex';
    }

    function bulkKakao() {
        var checked = document.querySelectorAll('.row-check:checked');
        if (checked.length === 0) { alert('발송할 항목을 선택해주세요.'); return; }
        _kakaoIds = [];
        checked.forEach(function(cb) { _kakaoIds.push(parseInt(cb.value)); });
        document.getElementById('kakaoTarget').textContent = '대상: ' + _kakaoIds.length + '건';
        document.getElementById('kakaoMessage').value = '';
        document.getElementById('kakaoModal').style.display = 'flex';
    }

    function closeKakaoModal() {
        document.getElementById('kakaoModal').style.display = 'none';
    }

    function confirmKakaoSend() {
        var msg = document.getElementById('kakaoMessage').value.trim();
        var url = _kakaoIds.length === 1 ? '/admin/api/kakao/send' : '/admin/api/kakao/bulk';
        var body = _kakaoIds.length === 1
            ? { progress_id: _kakaoIds[0], message: msg }
            : { progress_ids: _kakaoIds, message: msg };
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            closeKakaoModal();
            if (d.ok) {
                alert('카톡 발송 완료: ' + (d.sent || 1) + '건');
            } else {
                alert('발송 실패: ' + (d.message || '알 수 없는 오류'));
            }
        })
        .catch(function(e) { closeKakaoModal(); alert('발송 에러: ' + e.message); });
    }

    // --- Check All ---
    document.getElementById('checkAll').addEventListener('change', function() {
        var checked = this.checked;
        document.querySelectorAll('.row-check').forEach(function(cb) { cb.checked = checked; });
    });

    // --- Timeout Monitor ---
    function loadTimeouts() {
        fetch('/admin/api/timeout-sessions')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var panel = document.getElementById('timeoutPanel');
            var list = document.getElementById('timeoutList');
            if (!d.sessions || d.sessions.length === 0) {
                panel.style.display = 'none';
                return;
            }
            panel.style.display = 'block';
            list.innerHTML = '';
            d.sessions.forEach(function(s) {
                var urgentCls = s.remaining_sec < 300 ? ' urgent' : '';
                var min = Math.floor(s.remaining_sec / 60);
                var sec = s.remaining_sec % 60;
                var timeStr = min + '분 ' + sec + '초';
                var div = document.createElement('div');
                div.className = 'timeout-item';
                div.innerHTML = '<span class="time-remaining' + urgentCls + '">' + timeStr + '</span>'
                    + '<span>' + s.name + ' (' + s.phone + ')</span>'
                    + '<span style="color:#a78bfa;">' + (s.store_ids || '') + '</span>'
                    + '<span style="color:#9ca3af;font-size:12px;">' + (s.product || '') + '</span>';
                list.appendChild(div);
            });
        })
        .catch(function() {});
    }
    loadTimeouts();
    setInterval(loadTimeouts, 15000);

    // --- Filter ---
    function applyFilters() {
        var campaign = document.getElementById('filterCampaign').value;
        var status = document.getElementById('filterStatus').value;
        var params = new URLSearchParams();
        if (campaign) params.set('campaign', campaign);
        if (status) params.set('status', status);
        var qs = params.toString();
        window.location.href = '{{ url_for("admin.spreadsheet") }}' + (qs ? '?' + qs : '');
    }

    // --- Inline Edit (double-click) ---
    document.querySelectorAll('#spreadsheetTable td.editable').forEach(function(td) {
        td.addEventListener('dblclick', function(e) {
            // 캡쳐 버튼 클릭 시 편집 모드 진입 방지
            if (e.target.classList.contains('btn-capture')) return;
            if (td.querySelector('input')) return; // already editing

            var field = td.getAttribute('data-field');
            var row = td.closest('tr');
            var progressId = row.getAttribute('data-id');

            // 비고 필드: remark-text 부분만 편집, 캡쳐 버튼 보존
            var isRemark = field === '비고';
            var captureButtons = [];
            var oldValue;
            if (isRemark) {
                var remarkSpan = td.querySelector('.remark-text');
                oldValue = remarkSpan ? remarkSpan.textContent.trim() : td.textContent.trim();
                td.querySelectorAll('.btn-capture').forEach(function(btn) {
                    captureButtons.push(btn.cloneNode(true));
                });
            } else {
                oldValue = td.textContent.trim();
            }

            var input = document.createElement('input');
            input.type = 'text';
            input.className = 'cell-input';
            input.value = oldValue;

            td.textContent = '';
            td.appendChild(input);
            input.focus();
            input.select();

            function restoreCell(value) {
                td.textContent = '';
                if (isRemark) {
                    var span = document.createElement('span');
                    span.className = 'remark-text';
                    span.textContent = value;
                    td.appendChild(span);
                    captureButtons.forEach(function(btn) {
                        td.appendChild(btn);
                    });
                } else {
                    td.textContent = value;
                }
            }

            function commit() {
                var newValue = input.value.trim();
                if (newValue === oldValue) {
                    restoreCell(oldValue);
                    return;
                }
                fetch('/admin/api/progress/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        progress_id: progressId,
                        field: field,
                        value: newValue
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.ok) {
                        restoreCell(newValue);
                        td.classList.add('cell-saved');
                        setTimeout(function() { td.classList.remove('cell-saved'); }, 900);
                    } else {
                        restoreCell(oldValue);
                        alert('저장 실패: ' + (d.message || '알 수 없는 오류'));
                    }
                })
                .catch(function(e) {
                    restoreCell(oldValue);
                    alert('저장 에러: ' + e.message);
                });
            }

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    restoreCell(oldValue);
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(function() {
                    if (td.querySelector('input')) {
                        commit();
                    }
                }, 50);
            });
        });
    });

    // --- Status Select Save ---
    function saveSelect(sel) {
        var progressId = sel.getAttribute('data-id');
        var field = sel.getAttribute('data-field');
        var newValue = sel.value;
        var td = sel.closest('td');

        fetch('/admin/api/progress/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                progress_id: progressId,
                field: field,
                value: newValue
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.ok) {
                td.classList.add('cell-saved');
                setTimeout(function() { td.classList.remove('cell-saved'); }, 900);
            } else {
                alert('상태 변경 실패: ' + (d.message || '알 수 없는 오류'));
            }
        })
        .catch(function(e) {
            alert('상태 변경 에러: ' + e.message);
        });
    }

    // --- Delete Row ---
    function deleteRow(btn, progressId) {
        if (!confirm('이 항목을 삭제하시겠습니까? (ID: ' + progressId + ')')) return;

        fetch('/admin/api/progress/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ progress_id: progressId })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.ok) {
                var row = btn.closest('tr');
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(function() { row.remove(); }, 300);
            } else {
                alert('삭제 실패: ' + (d.message || '알 수 없는 오류'));
            }
        })
        .catch(function(e) {
            alert('삭제 에러: ' + e.message);
        });
    }
    </script>
</body>
</html>
