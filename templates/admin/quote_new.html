<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카비서 관리자 - 견적서 작성</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
    .top-area { display: flex; gap: 20px; margin-bottom: 20px; }
    .raw-card { flex: 1; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .raw-card h3 { font-size: 15px; font-weight: 700; color: #3c1e1e; margin: 0 0 12px; padding-bottom: 8px; border-bottom: 2px solid #fee500; }
    .raw-textarea { width: 100%; min-height: 200px; border: 1px solid #ddd; border-radius: 8px; padding: 12px; font-size: 13px; line-height: 1.6; resize: vertical; font-family: inherit; }
    .raw-textarea:focus { outline: none; border-color: #fee500; }
    .btn-parse { display: block; width: 100%; margin-top: 10px; padding: 10px; background: #3c1e1e; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; }
    .btn-parse:hover { background: #5a3030; }
    .btn-parse:disabled { opacity: .5; }
    .parsing-status { text-align: center; padding: 8px; font-size: 13px; color: #888; display: none; }

    /* 탭 */
    .tab-bar { display: flex; gap: 4px; margin-bottom: 16px; }
    .tab-bar button { padding: 10px 24px; border: 1px solid #ddd; border-bottom: none; border-radius: 8px 8px 0 0; background: #f5f5f5; font-size: 14px; cursor: pointer; font-weight: 600; color: #888; }
    .tab-bar button.active { background: #fff; color: #3c1e1e; border-bottom: 2px solid #fff; margin-bottom: -1px; }
    .tab-content { display: none; background: #fff; border-radius: 0 12px 12px 12px; padding: 24px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .tab-content.active { display: block; }

    /* 폼 */
    .section-title { font-size: 14px; font-weight: 700; color: #3c1e1e; margin: 20px 0 10px; padding-left: 8px; border-left: 3px solid #fee500; }
    .section-title:first-child { margin-top: 0; }
    .fg { margin-bottom: 10px; }
    .fg label { display: block; font-size: 12px; font-weight: 600; color: #555; margin-bottom: 3px; }
    .fg input, .fg select, .fg textarea { width: 100%; padding: 7px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    .fg input:focus, .fg select:focus, .fg textarea:focus { outline: none; border-color: #fee500; }
    .fr { display: flex; gap: 10px; }
    .fr .fg { flex: 1; }

    /* 품목 테이블 */
    .items-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .items-table th { background: #f8f5f0; border: 1px solid #e0dcd5; padding: 8px; font-size: 12px; font-weight: 600; color: #555; }
    .items-table td { border: 1px solid #e0dcd5; padding: 4px; }
    .items-table input { border: none; width: 100%; padding: 6px; font-size: 13px; text-align: right; }
    .items-table input.text-left { text-align: left; }
    .items-table .calc { background: #fafafa; color: #333; text-align: right; padding: 6px; font-size: 13px; }
    .items-table .total-row td { font-weight: 700; background: #f8f5f0; }
    .btn-add-row { padding: 6px 14px; border: 1px dashed #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 12px; color: #888; margin-top: 6px; }
    .btn-add-row:hover { border-color: #fee500; color: #3c1e1e; }
    .btn-del-row { border: none; background: none; color: #dc2626; cursor: pointer; font-size: 16px; padding: 2px 6px; }

    .total-box { background: #f8f5f0; border: 2px solid #e0dcd5; border-radius: 8px; padding: 14px 20px; margin: 16px 0; display: flex; justify-content: space-between; align-items: center; }
    .total-box .label { font-size: 15px; font-weight: 700; color: #3c1e1e; }
    .total-box .amount { font-size: 20px; font-weight: 700; color: #3c1e1e; }
    .total-box .korean { font-size: 13px; color: #888; margin-top: 2px; }

    .btn-bar { display: flex; gap: 10px; margin-top: 20px; }
    .btn-save { flex: 1; padding: 12px; background: #fee500; color: #3c1e1e; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }
    .btn-save:hover { background: #e6cf00; }
    .btn-cancel { padding: 12px 24px; background: #fff; color: #555; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; cursor: pointer; text-decoration: none; text-align: center; }
    .field-highlight { border-color: #60a5fa !important; background: #eff6ff !important; }
    @media (max-width: 768px) { .top-area { flex-direction: column; } .fr { flex-direction: column; } }
    </style>
</head>
<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-logo">카비서 관리자</a>
            <nav class="admin-nav">
                <a href="{{ url_for('admin.dashboard') }}">대시보드</a>
                <a href="{{ url_for('admin.campaigns') }}">캠페인</a>
                <a href="{{ url_for('admin.quotes') }}" class="active">견적서</a>
                <a href="{{ url_for('admin.chat_list') }}">대화이력</a>
                <a href="{{ url_for('admin.reviews') }}">검수{% if pending_review_count %}<span style="background:#ef4444;color:#fff;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;">{{ pending_review_count }}</span>{% endif %}</a>
                <a href="{{ url_for('admin.settlement') }}">정산</a>
                <a href="{{ url_for('admin.activity_logs') }}">활동로그</a>
                <a href="{{ url_for('admin.reviewers') }}">리뷰어</a>
                <a href="{{ url_for('admin.inquiries') }}">문의{% if pending_inquiry_count %}<span style="background:#ef4444;color:#fff;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;">{{ pending_inquiry_count }}</span>{% endif %}</a>
                <a href="{{ url_for('admin.spreadsheet') }}">데이터</a>
                <a href="{{ url_for('admin.guide') }}">가이드</a>
                <a href="{{ url_for('admin.settings') }}">설정</a>
                <a href="{{ url_for('admin.logout') }}">로그아웃</a>
            </nav>
        </div>
    </header>
    <main class="admin-main">
        <h1>견적서 작성</h1>

        <!-- 요청서 입력 -->
        <div class="top-area">
            <div class="raw-card">
                <h3>요청서 원본</h3>
                <textarea id="rawText" class="raw-textarea" placeholder="업체에서 받은 요청서 텍스트를 붙여넣으세요..."></textarea>
                <button type="button" id="btnParse" class="btn-parse" onclick="parseRequest()">AI 파싱</button>
                <div id="parsingStatus" class="parsing-status">AI가 요청서를 분석하고 있습니다...</div>
            </div>
        </div>

        <!-- 탭 -->
        <div class="tab-bar">
            <button class="active" onclick="switchTab('quote',this)">견적서</button>
            <button onclick="switchTab('campaign',this)">캠페인 정보</button>
        </div>

        <form method="POST" action="{{ url_for('admin.quote_new_post') }}" id="quoteForm">
            <input type="hidden" name="raw_text" id="hidRawText">
            <input type="hidden" name="parsed_data" id="hidParsedData">
            <input type="hidden" name="items" id="hidItems">
            <input type="hidden" name="supplier_id" id="hidSupplierId">
            <input type="hidden" name="recipient" id="hidRecipient">
            <input type="hidden" name="notes" id="hidNotes">

            <!-- 탭1: 견적서 -->
            <div id="tab-quote" class="tab-content active">
                <div class="section-title">받는곳</div>
                <div class="fg">
                    <label>업체명</label>
                    <input type="text" id="q_recipient" placeholder="유노애드">
                </div>

                <div class="section-title">공급자</div>
                <div class="fg">
                    <label>프리셋 선택</label>
                    <select id="q_supplier" onchange="loadSupplier()">
                        <option value="">선택</option>
                        {% for s in suppliers %}
                        <option value="{{ s.id }}" {{ 'selected' if s.is_default }}>{{ s.name }} ({{ s.company_name }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="section-title">품목</div>
                <table class="items-table" id="itemsTable">
                    <thead>
                        <tr>
                            <th style="width:30px;"></th>
                            <th style="width:100px;">품목</th>
                            <th style="width:100px;">규격</th>
                            <th style="width:70px;">수량</th>
                            <th style="width:100px;">단가</th>
                            <th style="width:110px;">공급가액</th>
                            <th style="width:90px;">세액</th>
                            <th style="width:110px;">비고</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="5" style="text-align:right;padding-right:10px;">합계</td>
                            <td class="calc" id="totalSupply">0</td>
                            <td class="calc" id="totalTax">0</td>
                            <td class="calc" id="totalAmount">0</td>
                        </tr>
                    </tfoot>
                </table>
                <button type="button" class="btn-add-row" onclick="addItemRow()">+ 품목 추가</button>

                <div class="total-box">
                    <div>
                        <div class="label">합계금액 (부가세 포함)</div>
                        <div class="korean" id="totalKorean"></div>
                    </div>
                    <div class="amount" id="totalDisplay">0 원</div>
                </div>

                <div class="section-title">특이사항</div>
                <div class="fg">
                    <textarea id="q_notes" rows="6" style="resize:vertical;font-size:13px;line-height:1.6;">1. 구매평 진행 시, 구매 진행 후 취소하시더라도 취소가 어려운 점 참고 부탁드립니다
2. 구매가 진행되지 않은 건수에 한해서는 전액 환불이 가능합니다
3. 포토리뷰 시 포토와 리뷰가이드는 미리 준비하시면 원활한 진행이 가능합니다
4. 택배 분실 시 재발송을 해주셔야 하며, 택배대행시에는 저희가 무상으로 재발송 합니다
5. 리뷰는 배송완료일로부터 7일이내 작성되지만, 개인작업자들이다 보니 조금 더 늦을 수 있음을 양해 부탁드립니다</textarea>
                </div>
            </div>

            <!-- 탭2: 캠페인 정보 -->
            <div id="tab-campaign" class="tab-content">
                <div class="section-title">상품 정보</div>
                <div class="fg"><label>상품링크</label><input type="text" id="f_상품링크"></div>
                <div class="fr">
                    <div class="fg"><label>플랫폼</label>
                        <select id="f_플랫폼"><option value="">선택</option><option>스마트스토어</option><option>쿠팡</option><option>오늘의집</option><option>11번가</option><option>지마켓</option><option>올리브영</option><option>기타</option></select>
                    </div>
                    <div class="fg"><label>캠페인유형</label>
                        <select id="f_캠페인유형"><option value="">선택</option><option>실배송</option><option>빈박스</option></select>
                    </div>
                </div>
                <div class="fr">
                    <div class="fg"><label>업체명</label><input type="text" id="f_업체명"></div>
                    <div class="fg"><label>상품명</label><input type="text" id="f_상품명"></div>
                </div>
                <div class="fr">
                    <div class="fg"><label>상품금액</label><input type="text" id="f_상품금액"></div>
                    <div class="fg"><label>리뷰비</label><input type="text" id="f_리뷰비"></div>
                </div>
                <div class="fg"><label>옵션</label><input type="text" id="f_옵션"></div>

                <div class="section-title">수량 / 일정</div>
                <div class="fr">
                    <div class="fg"><label>총수량</label><input type="text" id="f_총수량"></div>
                    <div class="fg"><label>일수량</label><input type="text" id="f_일수량"></div>
                    <div class="fg"><label>진행일수</label><input type="text" id="f_진행일수"></div>
                </div>

                <div class="section-title">유입 / 검색</div>
                <div class="fr">
                    <div class="fg"><label>유입방식</label>
                        <select id="f_유입방식"><option value="">선택</option><option>링크유입</option><option>키워드유입</option></select>
                    </div>
                    <div class="fg"><label>키워드</label><input type="text" id="f_키워드"></div>
                </div>
                <div class="fg"><label>키워드위치</label><input type="text" id="f_키워드위치"></div>

                <div class="section-title">배송 / 운영</div>
                <div class="fr">
                    <div class="fg"><label>당일발송</label><select id="f_당일발송"><option value="">선택</option><option value="Y">Y</option><option value="N">N</option></select></div>
                    <div class="fg"><label>발송마감</label><input type="text" id="f_발송마감"></div>
                </div>
                <div class="fr">
                    <div class="fg"><label>택배사</label><input type="text" id="f_택배사"></div>
                    <div class="fg"><label>3PL</label><select id="f_3PL사용"><option value="">선택</option><option value="Y">Y</option><option value="N">N</option></select></div>
                </div>
                <div class="fr">
                    <div class="fg"><label>주말작업</label><select id="f_주말작업"><option value="">선택</option><option value="Y">Y</option><option value="N">N</option></select></div>
                    <div class="fg"><label>중복허용</label><select id="f_중복허용"><option value="">선택</option><option value="Y">Y</option><option value="N">N</option></select></div>
                </div>
                <div class="fg"><label>구매가능시간</label><input type="text" id="f_구매가능시간"></div>

                <div class="section-title">리뷰</div>
                <div class="fr">
                    <div class="fg"><label>리뷰제공</label><select id="f_리뷰제공"><option value="">선택</option><option>자체작성</option><option>텍스트제공</option><option>사진제공</option></select></div>
                    <div class="fg"><label>리뷰원고수</label><input type="text" id="f_리뷰원고수"></div>
                </div>
                <div class="fg"><label>메모</label><textarea id="f_메모" rows="3"></textarea></div>
            </div>

            <div class="btn-bar">
                <a href="{{ url_for('admin.quotes') }}" class="btn-cancel">취소</a>
                <button type="submit" class="btn-save">견적서 저장</button>
            </div>
        </form>
    </main>

    <script>
    var SUPPLIERS = {{ suppliers | tojson }};
    var CAMPAIGN_FIELDS = ["상품링크","플랫폼","캠페인유형","업체명","상품명","상품금액","리뷰비","옵션","총수량","일수량","진행일수","유입방식","키워드","키워드위치","당일발송","발송마감","택배사","3PL사용","주말작업","중복허용","구매가능시간","리뷰제공","리뷰원고수","메모"];

    function switchTab(name, btn) {
        document.querySelectorAll('.tab-content').forEach(function(el) { el.classList.remove('active'); });
        document.querySelectorAll('.tab-bar button').forEach(function(el) { el.classList.remove('active'); });
        document.getElementById('tab-' + name).classList.add('active');
        btn.classList.add('active');
    }

    function loadSupplier() {
        var sid = document.getElementById('q_supplier').value;
        // 공급자 정보는 프리셋 선택만으로 충분 (미리보기에서 로드)
    }

    // ── 품목 테이블 ──
    var itemRows = [];
    function addItemRow(data) {
        data = data || { 품목: '', 규격: '', 수량: '', 단가: '' };
        var idx = itemRows.length;
        itemRows.push(data);
        var tr = document.createElement('tr');
        tr.innerHTML =
            '<td><button type="button" class="btn-del-row" onclick="delItemRow('+idx+')">&times;</button></td>' +
            '<td><input class="text-left" data-idx="'+idx+'" data-f="품목" value="'+esc(data.품목)+'" oninput="onItemChange(this)"></td>' +
            '<td><input class="text-left" data-idx="'+idx+'" data-f="규격" value="'+esc(data.규격)+'" oninput="onItemChange(this)"></td>' +
            '<td><input data-idx="'+idx+'" data-f="수량" value="'+esc(data.수량)+'" oninput="onItemChange(this)"></td>' +
            '<td><input data-idx="'+idx+'" data-f="단가" value="'+esc(data.단가)+'" oninput="onItemChange(this)"></td>' +
            '<td class="calc" id="supply_'+idx+'">0</td>' +
            '<td class="calc" id="tax_'+idx+'">0</td>' +
            '<td class="calc" id="bigo_'+idx+'">0</td>';
        document.getElementById('itemsBody').appendChild(tr);
        calcRow(idx);
    }

    function delItemRow(idx) {
        var rows = document.getElementById('itemsBody').children;
        if (rows[idx]) rows[idx].remove();
        itemRows[idx] = null;
        calcTotals();
    }

    function onItemChange(el) {
        var idx = parseInt(el.dataset.idx);
        if (itemRows[idx]) {
            itemRows[idx][el.dataset.f] = el.value;
            calcRow(idx);
        }
    }

    function calcRow(idx) {
        var r = itemRows[idx];
        if (!r) return;
        var qty = parseInt(String(r.수량).replace(/,/g, '')) || 0;
        var price = parseInt(String(r.단가).replace(/,/g, '')) || 0;
        var supply = qty * price;
        var tax = Math.round(supply * 0.1);
        var bigo = supply + tax;
        document.getElementById('supply_' + idx).textContent = fmt(supply);
        document.getElementById('tax_' + idx).textContent = fmt(tax);
        document.getElementById('bigo_' + idx).textContent = fmt(bigo);
        calcTotals();
    }

    function calcTotals() {
        var ts = 0, tt = 0, ta = 0;
        itemRows.forEach(function(r, i) {
            if (!r) return;
            var qty = parseInt(String(r.수량).replace(/,/g, '')) || 0;
            var price = parseInt(String(r.단가).replace(/,/g, '')) || 0;
            var supply = qty * price;
            var tax = Math.round(supply * 0.1);
            ts += supply; tt += tax; ta += supply + tax;
        });
        document.getElementById('totalSupply').textContent = fmt(ts);
        document.getElementById('totalTax').textContent = fmt(tt);
        document.getElementById('totalAmount').textContent = fmt(ta);
        document.getElementById('totalDisplay').textContent = fmt(ta) + ' 원';
        document.getElementById('totalKorean').textContent = numToKorean(ta) + ' 원';
    }

    function fmt(n) { return n.toLocaleString('ko-KR'); }
    function esc(s) { return String(s||'').replace(/"/g, '&quot;'); }

    function numToKorean(n) {
        if (n === 0) return '영';
        var units = ['', '만', '억', '조'];
        var digits = ['', '일', '이', '삼', '사', '오', '육', '칠', '팔', '구'];
        var smalls = ['', '십', '백', '천'];
        var result = '';
        var unitIdx = 0;
        while (n > 0) {
            var part = n % 10000;
            if (part > 0) {
                var partStr = '';
                var pi = 0;
                var p = part;
                while (p > 0) {
                    var d = p % 10;
                    if (d > 0) partStr = digits[d] + smalls[pi] + partStr;
                    p = Math.floor(p / 10);
                    pi++;
                }
                result = partStr + units[unitIdx] + result;
            }
            n = Math.floor(n / 10000);
            unitIdx++;
        }
        return result;
    }

    // ── AI 파싱 ──
    function parseRequest() {
        var raw = document.getElementById('rawText').value.trim();
        if (!raw) { alert('요청서 텍스트를 입력하세요.'); return; }
        var btn = document.getElementById('btnParse');
        var status = document.getElementById('parsingStatus');
        btn.disabled = true; status.style.display = 'block';

        fetch('/admin/api/quotes/parse', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ raw_text: raw })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            btn.disabled = false; status.style.display = 'none';
            if (!d.ok) { alert('파싱 실패: ' + (d.message || '')); return; }
            applyParsed(d.parsed);
        })
        .catch(function(e) { btn.disabled = false; status.style.display = 'none'; alert('요청 실패: ' + e.message); });
    }

    function applyParsed(parsed) {
        // 캠페인 필드
        var c = parsed.campaign || parsed;
        CAMPAIGN_FIELDS.forEach(function(key) {
            var el = document.getElementById('f_' + key);
            if (!el) return;
            var val = c[key] || '';
            if (el.tagName === 'SELECT') {
                for (var i = 0; i < el.options.length; i++) {
                    if (el.options[i].value === val || el.options[i].text === val) { el.selectedIndex = i; break; }
                }
            } else { el.value = val; }
        });

        // 견적서 필드
        var q = parsed.quote || {};
        if (q.recipient) document.getElementById('q_recipient').value = q.recipient;
        else if (c['업체명']) document.getElementById('q_recipient').value = c['업체명'];

        if (q.notes) document.getElementById('q_notes').value = q.notes;

        // 품목
        if (q.items && q.items.length) {
            document.getElementById('itemsBody').innerHTML = '';
            itemRows = [];
            q.items.forEach(function(item) { addItemRow(item); });
        }
    }

    // ── 폼 제출 ──
    document.getElementById('quoteForm').addEventListener('submit', function() {
        document.getElementById('hidRawText').value = document.getElementById('rawText').value;
        document.getElementById('hidRecipient').value = document.getElementById('q_recipient').value;
        document.getElementById('hidNotes').value = document.getElementById('q_notes').value;
        document.getElementById('hidSupplierId').value = document.getElementById('q_supplier').value;

        var campaign = {};
        CAMPAIGN_FIELDS.forEach(function(k) { var el = document.getElementById('f_' + k); if (el) campaign[k] = el.value; });
        document.getElementById('hidParsedData').value = JSON.stringify(campaign);

        var items = [];
        itemRows.forEach(function(r) { if (r) items.push(r); });
        document.getElementById('hidItems').value = JSON.stringify(items);
    });

    // 초기 빈 행 2개
    addItemRow({ 품목: '구매비', 규격: '', 수량: '', 단가: '' });
    addItemRow({ 품목: '작업비', 규격: '', 수량: '', 단가: '' });

    // 기본 공급자 자동 선택
    var defaultOpt = document.querySelector('#q_supplier option[selected]');
    if (defaultOpt) loadSupplier();
    </script>
</body>
</html>
