<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카비서 관리자 - 견적서 작성</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .form-section { margin-bottom: 32px; }
        .form-section h3 {
            font-size: 16px; font-weight: 700; color: #3c1e1e;
            margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #fee500;
        }
        .raw-textarea {
            width: 100%; min-height: 320px; padding: 16px; font-size: 14px;
            line-height: 1.8; border: 2px solid #ddd; border-radius: 8px;
            font-family: 'Noto Sans KR', sans-serif; resize: vertical;
        }
        .raw-textarea:focus { border-color: #fee500; outline: none; }
        .parsed-preview {
            background: #f9f9f9; border-radius: 8px; padding: 16px;
            margin-top: 16px; font-size: 13px; line-height: 1.8;
            border: 1px solid #eee; display: none;
        }
        .parsed-preview.active { display: block; }
        .parsed-row { display: flex; gap: 8px; padding: 4px 0; border-bottom: 1px solid #f0f0f0; }
        .parsed-label { font-weight: 600; color: #555; min-width: 120px; }
        .parsed-value { color: #333; }
        .parsed-value.empty { color: #ccc; font-style: italic; }
        .form-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }
        .parse-btn {
            background: #fee500; color: #3c1e1e; border: none; padding: 10px 24px;
            border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;
        }
        .parse-btn:hover { background: #f5d800; }
    </style>
</head>
<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-logo">카비서 관리자</a>
            <nav class="admin-nav">
                <a href="{{ url_for('admin.dashboard') }}">대시보드</a>
                <a href="{{ url_for('admin.campaigns') }}">캠페인</a>
                <a href="{{ url_for('admin.quotes') }}" class="active">견적서</a>
                <a href="{{ url_for('admin.reviews') }}">검수</a>
                <a href="{{ url_for('admin.settlement') }}">정산</a>
                <a href="{{ url_for('admin.settings') }}">설정</a>
                <a href="{{ url_for('admin.logout') }}">로그아웃</a>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <h1>견적서 작성</h1>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="admin-flash">
            {% for msg in messages %}<p>{{ msg }}</p>{% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('admin.quote_new_post') }}" class="admin-form">
            <div class="form-section">
                <h3>기본 정보</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>받는 업체명 (귀하)</label>
                        <input type="text" name="recipient" placeholder="예: 제이비">
                    </div>
                    <div class="form-group">
                        <label>업체명 (발주처)</label>
                        <input type="text" name="company" placeholder="예: 손잡이코리아">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>요청서 텍스트 붙여넣기</h3>
                <p style="color:#666;font-size:13px;margin-bottom:12px;">
                    업체에서 받은 요청서 텍스트를 아래에 붙여넣으세요. 자동으로 파싱됩니다.
                </p>
                <textarea name="raw_request" id="rawText" class="raw-textarea" placeholder="▶상품링크: https://smartstore.naver.com/...
▶당일발송(오늘출발) 제품인가요? 네
당일발송 마감시간: 오후 6시 30분
▶유입방식 택1
1. 링크 유입:
2. 키워드 유입: 방문손잡이
▶상품선택옵션(3개 이하): 01) 905 SS
▶총 구매수량: 25
▶일 구매수량: 5
▶해당 스토어 출고 택배사: 롯데
..."></textarea>

                <button type="button" class="parse-btn" id="parseBtn" style="margin-top:12px;">미리보기 파싱</button>

                <div class="parsed-preview" id="parsedPreview">
                    <h4 style="margin-bottom:12px;font-size:14px;">파싱 결과</h4>
                    <div id="parsedContent"></div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="admin-btn admin-btn-primary">견적서 생성</button>
                <a href="{{ url_for('admin.quotes') }}" class="admin-btn">취소</a>
            </div>
        </form>
    </main>

    <script>
    document.getElementById('parseBtn').addEventListener('click', function() {
        var text = document.getElementById('rawText').value;
        if (!text.trim()) { alert('텍스트를 입력하세요.'); return; }

        fetch("{{ url_for('admin.api_quote_parse') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!data.ok) return;
            var p = data.parsed;
            var labels = {
                product_link: '상품링크', same_day_ship: '당일발송', ship_deadline: '발송마감',
                entry_method: '유입방식', keyword: '키워드', current_rank: '현재순위',
                options: '옵션', total_qty: '총 구매수량', daily_qty: '일 구매수량',
                courier: '택배사', use_3pl: '3PL사용', weekend_work: '주말작업',
                review_provided: '리뷰제공', review_qty: '리뷰원고수',
            };
            var html = '';
            for (var key in labels) {
                var val = p[key];
                if (typeof val === 'boolean') val = val ? 'Y' : 'N';
                if (val === 0 || val === '') val = '';
                var cls = val ? '' : ' empty';
                html += '<div class="parsed-row"><span class="parsed-label">' + labels[key] + '</span><span class="parsed-value' + cls + '">' + (val || '(없음)') + '</span></div>';
            }
            document.getElementById('parsedContent').innerHTML = html;
            document.getElementById('parsedPreview').classList.add('active');
        });
    });
    </script>
</body>
</html>
