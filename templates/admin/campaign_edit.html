<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë¹„ì„œ ê´€ë¦¬ì - ìº í˜ì¸ ìˆ˜ì •</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .file-upload-area {
            border: 2px dashed #ddd; border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
        }
        .file-upload-area:hover { border-color: #fee500; }
        .file-upload-area.has-file { border-color: #4caf50; background: #f0faf0; }
        .file-upload-area input[type="file"] { display: none; }
        .file-upload-label { color: #888; font-size: 14px; }
        .file-upload-area.has-file .file-upload-label { color: #4caf50; font-weight: 600; }
        .current-image { margin-top: 8px; }
        .current-image img { max-width: 200px; border-radius: 8px; border: 1px solid #ddd; }

        /* í™ë³´ ì„¤ì • */
        .form-section { margin-bottom: 32px; }
        .form-section h3 {
            font-size: 16px; font-weight: 700; color: #3c1e1e;
            margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #fee500;
        }
        .promo-toggle-wrap { display: flex; align-items: center; gap: 12px; padding: 6px 0; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background: #ccc; border-radius: 26px; transition: 0.3s;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 20px; width: 20px;
            left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch input:checked + .toggle-slider { background: #fee500; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .toggle-label { font-size: 14px; font-weight: 600; color: #888; }
        .toggle-label.on { color: #3c1e1e; }
        .promo-detail { transition: opacity 0.3s; }
        .promo-detail.disabled { opacity: 0.4; pointer-events: none; }
        .promo-categories { display: flex; flex-wrap: wrap; gap: 8px 16px; padding: 8px 0; }
        .promo-cat-label {
            display: flex; align-items: center; gap: 4px; font-size: 14px;
            font-weight: 400; cursor: pointer; margin-bottom: 0;
        }
        .promo-cat-label input[type="checkbox"] { width: auto; margin: 0; }
        .promo-message-wrap { display: grid; grid-template-columns: 1fr 320px; gap: 16px; }
        @media (max-width: 768px) { .promo-message-wrap { grid-template-columns: 1fr; } }

        .kakao-preview {
            border: 1px solid #ddd; border-radius: 12px; overflow: hidden;
            background: #b2c7d9; min-height: 280px; display: flex; flex-direction: column;
        }
        .kakao-preview-header {
            background: #5b86a7; padding: 10px 14px; display: flex; align-items: center;
        }
        .kakao-preview-title { color: #fff; font-size: 14px; font-weight: 600; }
        .kakao-preview-body {
            flex: 1; padding: 14px; overflow-y: auto; display: flex; flex-direction: column;
        }
        .kakao-date {
            text-align: center; font-size: 11px; color: #fff; margin-bottom: 12px;
            background: rgba(0,0,0,0.15); border-radius: 10px; padding: 3px 10px;
            align-self: center;
        }
        .kakao-msg-row { display: flex; flex-direction: column; align-items: flex-start; }
        .kakao-profile { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .kakao-avatar {
            width: 32px; height: 32px; border-radius: 10px; background: #fee500;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700; color: #3c1e1e;
        }
        .kakao-name { font-size: 12px; color: #333; font-weight: 500; }
        .kakao-bubble {
            background: #fff; border-radius: 0 12px 12px 12px; padding: 10px 14px;
            font-size: 13px; line-height: 1.6; max-width: 260px; word-break: break-word;
            white-space: pre-wrap; box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            margin-left: 38px;
        }
    </style>
</head>
<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-logo">ì¹´ë¹„ì„œ ê´€ë¦¬ì</a>
            <nav class="admin-nav">
                <a href="{{ url_for('admin.dashboard') }}">ëŒ€ì‹œë³´ë“œ</a>
                <a href="{{ url_for('admin.campaigns') }}" class="active">ìº í˜ì¸</a>
                <a href="{{ url_for('admin.quotes') }}">ê²¬ì ì„œ</a>
                <a href="{{ url_for('admin.chat_list') }}">ëŒ€í™”ì´ë ¥</a>
                <a href="{{ url_for('admin.reviews') }}">ê²€ìˆ˜{% if pending_review_count %}<span style="background:#ef4444;color:#fff;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;">{{ pending_review_count }}</span>{% endif %}</a>
                <a href="{{ url_for('admin.settlement') }}">ì •ì‚°</a>
                <a href="{{ url_for('admin.activity_logs') }}">í™œë™ë¡œê·¸</a>
                <a href="{{ url_for('admin.reviewers') }}">ë¦¬ë·°ì–´</a>
                <a href="{{ url_for('admin.inquiries') }}">ë¬¸ì˜{% if pending_inquiry_count %}<span style="background:#ef4444;color:#fff;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;">{{ pending_inquiry_count }}</span>{% endif %}</a>
                <a href="{{ url_for('admin.spreadsheet') }}">ë°ì´í„°</a>
                <a href="{{ url_for('admin.notices') }}">ê³µì§€</a>
                <a href="{{ url_for('admin.guide') }}">ê°€ì´ë“œ</a>
                <a href="{{ url_for('admin.settings') }}">ì„¤ì •</a>
                <a href="{{ url_for('admin.logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <h1>ìº í˜ì¸ ìˆ˜ì •</h1>
        <p class="admin-subtitle">ìº í˜ì¸ID: {{ campaign.get('ìº í˜ì¸ID', '') }} | ë“±ë¡ì¼: {{ campaign.get('ë“±ë¡ì¼', '') }}</p>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="admin-flash">
            {% for msg in messages %}
            <p>{{ msg }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('admin.campaign_edit_post', campaign_id=row) }}" enctype="multipart/form-data" class="admin-form">
            <div class="form-grid">
                <div class="form-group">
                    <label>ìƒíƒœ</label>
                    <select name="ìƒíƒœ">
                        {% for s in ['ëª¨ì§‘ì¤‘', 'ì§„í–‰ì¤‘', 'ë§ˆê°', 'ì¢…ë£Œ'] %}
                        <option value="{{ s }}" {{ 'selected' if campaign.get('ìƒíƒœ', '') == s }}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>ìº í˜ì¸ëª…</label>
                    <input type="text" name="ìº í˜ì¸ëª…" value="{{ campaign.get('ìº í˜ì¸ëª…', '') }}" placeholder="ë¹„ìš°ë©´ ìƒí’ˆëª…ìœ¼ë¡œ í‘œì‹œ">
                </div>

                <div class="form-group">
                    <label>ìƒí’ˆëª…</label>
                    <input type="text" name="ìƒí’ˆëª…" value="{{ campaign.get('ìƒí’ˆëª…', '') }}">
                </div>

                <div class="form-group">
                    <label>ì—…ì²´ëª…</label>
                    <input type="text" name="ì—…ì²´ëª…" value="{{ campaign.get('ì—…ì²´ëª…', '') }}">
                </div>

                <div class="form-group">
                    <label>í”Œë«í¼</label>
                    <input type="text" name="í”Œë«í¼" value="{{ campaign.get('í”Œë«í¼', '') }}">
                </div>

                <div class="form-group">
                    <label>ìº í˜ì¸ìœ í˜•</label>
                    <select name="ìº í˜ì¸ìœ í˜•">
                        {% for t in ['ì‹¤ë°°ì†¡', 'ë¹ˆë°•ìŠ¤'] %}
                        <option value="{{ t }}" {{ 'selected' if campaign.get('ìº í˜ì¸ìœ í˜•', '') == t }}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>ê²°ì œê¸ˆì•¡</label>
                    <input type="text" name="ê²°ì œê¸ˆì•¡" value="{{ campaign.get('ê²°ì œê¸ˆì•¡', '') or campaign.get('ìƒí’ˆê¸ˆì•¡', '') }}">
                </div>

                <div class="form-group">
                    <label>ë¦¬ë·°ë¹„ (ì›)</label>
                    <input type="text" name="ë¦¬ë·°ë¹„" value="{{ campaign.get('ë¦¬ë·°ë¹„', '') }}" placeholder="ì˜ˆ: 15000">
                </div>

                <div class="form-group">
                    <label>ì´ìˆ˜ëŸ‰</label>
                    <input type="number" name="ì´ìˆ˜ëŸ‰" value="{{ campaign.get('ì´ìˆ˜ëŸ‰', '') }}">
                </div>

                <div class="form-group">
                    <label>ì¼ìˆ˜ëŸ‰</label>
                    <input type="text" name="ì¼ìˆ˜ëŸ‰" value="{{ campaign.get('ì¼ìˆ˜ëŸ‰', '') }}" placeholder="ìˆ«ì ë˜ëŠ” ë²”ìœ„(3-5)">
                </div>

                <div class="form-group">
                    <label>ì§„í–‰ì¼ìˆ˜</label>
                    <input type="number" name="ì§„í–‰ì¼ìˆ˜" value="{{ campaign.get('ì§„í–‰ì¼ìˆ˜', '') }}" min="1" placeholder="ì˜ˆ: 4">
                </div>

                <div class="form-group">
                    <label>1ì¸ ì¼ì¼ ì œí•œ</label>
                    <input type="number" name="1ì¸ì¼ì¼ì œí•œ" value="{{ campaign.get('1ì¸ì¼ì¼ì œí•œ', '') }}" min="0" placeholder="0 = ë¬´ì œí•œ">
                    <small style="color:#888;font-size:12px;">í•œ ëª…ì´ í•˜ë£¨ì— ì°¸ì—¬ ê°€ëŠ¥í•œ ìµœëŒ€ ê±´ìˆ˜ (0ì´ë©´ ì œí•œ ì—†ìŒ)</small>
                </div>

                <div class="form-group">
                    <label>ì‹œì‘ì¼</label>
                    <input type="date" name="ì‹œì‘ì¼" value="{{ campaign.get('ì‹œì‘ì¼', '') }}">
                </div>

                <div class="form-group form-group-full">
                    <label>ì¼ë³„ ì§„í–‰ì¼ì •</label>
                    {% set schedule = campaign.get('ì¼ì •', []) %}
                    {% if schedule %}
                    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
                        {% for qty in schedule %}
                        <div style="background:{{ '#e3f2fd' if loop.index0 < schedule|length else '#f5f5f5' }};border-radius:6px;padding:6px 12px;font-size:13px;text-align:center;min-width:50px;">
                            <div style="font-size:11px;color:#888;">{{ loop.index }}ì¼ì°¨</div>
                            <div style="font-weight:700;">{{ qty }}ëª…</div>
                        </div>
                        {% endfor %}
                        <div style="background:#fff3e0;border-radius:6px;padding:6px 12px;font-size:13px;text-align:center;">
                            <div style="font-size:11px;color:#888;">í•©ê³„</div>
                            <div style="font-weight:700;">{{ schedule|sum }}ëª…</div>
                        </div>
                    </div>
                    {% endif %}
                    <input type="text" name="ì¼ì •" value="{{ schedule|join(', ') }}" placeholder="ì˜ˆ: 3, 5, 4, 3, 4, 2 (ì‰¼í‘œ êµ¬ë¶„)">
                    <small style="color:#888;font-size:12px;">ì¼ìˆ˜ëŸ‰/ì§„í–‰ì¼ìˆ˜ ê¸°ë°˜ ìë™ ìƒì„±ë¨. ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥</small>
                    <button type="button" onclick="regenerateSchedule()" style="margin-top:4px;padding:4px 12px;border:1px solid #ddd;border-radius:6px;background:#f9f9f9;cursor:pointer;font-size:12px;">ì¼ì • ì¬ìƒì„±</button>
                </div>

                <div class="form-group form-group-full">
                    <label>êµ¬ë§¤ê°€ëŠ¥ì‹œê°„</label>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <select id="buyTimeStart" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;">
                            <option value="">ì‹œì‘</option>
                            {% for h in range(24) %}<option value="{{ '%02d'|format(h) }}">{{ '%02d:00'|format(h) }}</option>{% endfor %}
                        </select>
                        <span>~</span>
                        <label style="display:flex;align-items:center;gap:4px;margin:0;font-weight:400;">
                            <input type="checkbox" id="buyTimeNextDay" style="width:auto;"> ìµì¼
                        </label>
                        <select id="buyTimeEnd" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;">
                            <option value="">ì¢…ë£Œ</option>
                            {% for h in range(25) %}<option value="{{ '%02d'|format(h) }}">{{ '%02d:00'|format(h) }}</option>{% endfor %}
                        </select>
                        <button type="button" onclick="clearBuyTime()" style="padding:6px 12px;border:1px solid #ddd;border-radius:6px;background:#f9f9f9;cursor:pointer;font-size:12px;">24ì‹œê°„(ì´ˆê¸°í™”)</button>
                    </div>
                    <input type="hidden" name="êµ¬ë§¤ê°€ëŠ¥ì‹œê°„" id="buyTimeValue" value="{{ campaign.get('êµ¬ë§¤ê°€ëŠ¥ì‹œê°„', '') }}">
                    <small style="color:#888;font-size:12px;">ë¹„ìš°ë©´ 24ì‹œê°„. ì´ ì‹œê°„ì—ë§Œ ìº í˜ì¸ ë…¸ì¶œ</small>
                </div>

                <div class="form-group">
                    <label>ì¤‘ë³µí—ˆìš©</label>
                    <select name="ì¤‘ë³µí—ˆìš©">
                        <option value="" {{ 'selected' if not campaign.get('ì¤‘ë³µí—ˆìš©', '') }}>N (ê¸°ë³¸: ë¶ˆí—ˆ)</option>
                        <option value="Y" {{ 'selected' if campaign.get('ì¤‘ë³µí—ˆìš©', '') == 'Y' }}>Y (í—ˆìš©)</option>
                    </select>
                </div>

                {% if campaign.get('ë™ì‹œì§„í–‰ê·¸ë£¹', '') %}
                <div class="form-group">
                    <label>ë™ì‹œì§„í–‰ê·¸ë£¹</label>
                    <span style="font-size:13px;color:#8b5cf6;font-weight:600;">ì„¤ì •ë¨</span>
                    <small style="color:#888;font-size:12px;">ìº í˜ì¸ ëª©ë¡ì—ì„œ ì²´í¬ í›„ ë¬¶ê¸°/í•´ì œ ê°€ëŠ¥</small>
                </div>
                {% endif %}

                <div class="form-group">
                    <label>ìƒí’ˆë§í¬</label>
                    <input type="text" name="ìƒí’ˆë§í¬" value="{{ campaign.get('ìƒí’ˆë§í¬', '') }}">
                </div>

                <div class="form-group">
                    <label>ìƒí’ˆì½”ë“œ (ìë™ì¶”ì¶œ)</label>
                    {% set codes = campaign.get('ìƒí’ˆì½”ë“œ', {}) %}
                    {% if codes and codes.get('codes') %}
                    <div style="background:#f0f7ff;padding:8px 12px;border-radius:6px;font-size:13px;">
                        <span style="color:#666;">{{ codes.get('platform', '') }}:</span>
                        {% for k, v in codes.get('codes', {}).items() %}
                        <span style="margin-left:8px;"><b>{{ k }}</b>={{ v }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="color:#999;font-size:13px;">ìƒí’ˆë§í¬ ì €ì¥ ì‹œ ìë™ ì¶”ì¶œë©ë‹ˆë‹¤</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label>ì˜µì…˜ëª…</label>
                    <input type="text" name="ì˜µì…˜" value="{{ campaign.get('ì˜µì…˜', '') }}" placeholder="ì˜ˆ: 300ml / ë¸”ë™ (ì‰¼í‘œë¡œ êµ¬ë¶„)">
                </div>

                <div class="form-group">
                    <label>í‚¤ì›Œë“œ</label>
                    <input type="text" name="í‚¤ì›Œë“œ" value="{{ campaign.get('í‚¤ì›Œë“œ', '') }}">
                </div>

                <div class="form-group">
                    <label>ìœ ì…ë°©ì‹</label>
                    <input type="text" name="ìœ ì…ë°©ì‹" value="{{ campaign.get('ìœ ì…ë°©ì‹', '') }}">
                </div>

                <div class="form-group">
                    <label>ë¦¬ë·°ê¸°í•œì¼ìˆ˜</label>
                    <input type="number" name="ë¦¬ë·°ê¸°í•œì¼ìˆ˜" value="{{ campaign.get('ë¦¬ë·°ê¸°í•œì¼ìˆ˜', '') }}">
                </div>

                <div class="form-group">
                    <label>ê³µê°œì—¬ë¶€</label>
                    <select name="ê³µê°œì—¬ë¶€">
                        <option value="Y" {{ 'selected' if campaign.get('ê³µê°œì—¬ë¶€', '') != 'N' }}>Y (ê³µê°œ)</option>
                        <option value="N" {{ 'selected' if campaign.get('ê³µê°œì—¬ë¶€', '') == 'N' }}>N (ë¹„ê³µê°œ)</option>
                    </select>
                </div>

                <div class="form-group form-group-full">
                    <label>ìº í˜ì¸ ê°€ì´ë“œ</label>
                    <textarea name="ìº í˜ì¸ê°€ì´ë“œ" rows="6" placeholder="ë¦¬ë·°ì–´ì—ê²Œ ì „ë‹¬í•  êµ¬ë§¤ ê°€ì´ë“œ">{{ campaign.get('ìº í˜ì¸ê°€ì´ë“œ', '') }}</textarea>
                </div>

            </div>

            <!-- í™ë³´ ì„¤ì • -->
            <div class="form-section" style="margin-top:24px;">
                <h3>í™ë³´ ì„¤ì •</h3>
                <div class="form-grid">
                    <!-- í™ë³´ í™œì„±í™” í† ê¸€ -->
                    <div class="form-group form-group-full">
                        <label>í™ë³´ í™œì„±í™”</label>
                        <div class="promo-toggle-wrap">
                            <label class="toggle-switch">
                                <input type="checkbox" id="promoEnabled" name="í™ë³´í™œì„±" value="Y"
                                    {{ 'checked' if campaign.get('í™ë³´í™œì„±', '') == 'Y' }}>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label" id="promoStatusLabel">OFF</span>
                        </div>
                    </div>

                    <!-- ëŒ€ìƒ ì¹´í…Œê³ ë¦¬ -->
                    {% set promo_cats = (campaign.get('í™ë³´ì¹´í…Œê³ ë¦¬', '') or '').split(',') %}
                    <div class="form-group form-group-full promo-detail" id="promoDetails">
                        <label>ëŒ€ìƒ ì¹´í…Œê³ ë¦¬</label>
                        <div class="promo-categories">
                            {% for cat in promo_category_list %}
                            <label class="promo-cat-label">
                                <input type="checkbox" class="promo-cat-cb" value="{{ cat }}"
                                    {{ 'checked' if cat in promo_cats }}> {{ cat }}
                            </label>
                            {% endfor %}
                            {% set known_cats = promo_category_list %}
                            {% set etc_cats = [] %}
                            {% for c in promo_cats if c.strip() and c.strip() not in known_cats %}
                                {% if etc_cats.append(c.strip()) %}{% endif %}
                            {% endfor %}
                            <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
                                <label class="promo-cat-label" style="margin:0;">
                                    <input type="checkbox" class="promo-cat-cb" id="promoCatEtc" value=""
                                        {{ 'checked' if etc_cats }}> ê¸°íƒ€:
                                </label>
                                <input type="text" id="promoCatEtcInput" placeholder="ì§ì ‘ì…ë ¥"
                                    value="{{ etc_cats|join(', ') }}"
                                    style="width:120px;padding:4px 8px;border:1px solid #ddd;border-radius:6px;font-size:13px;">
                            </div>
                        </div>
                        <input type="hidden" name="í™ë³´ì¹´í…Œê³ ë¦¬" id="promoCategoriesValue"
                            value="{{ campaign.get('í™ë³´ì¹´í…Œê³ ë¦¬', '') }}">
                    </div>

                    <!-- í™ë³´ ì‹œê°„ëŒ€ -->
                    <div class="form-group promo-detail">
                        <label>í™ë³´ ì‹œê°„ëŒ€</label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <select name="í™ë³´ì‹œì‘ì‹œê°„" id="promoStartTime" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;">
                                {% for h in range(24) %}
                                <option value="{{ '%02d:00'|format(h) }}"
                                    {{ 'selected' if campaign.get('í™ë³´ì‹œì‘ì‹œê°„', '09:00') == '%02d:00'|format(h) }}>{{ '%02d:00'|format(h) }}</option>
                                {% endfor %}
                            </select>
                            <span>~</span>
                            <select name="í™ë³´ì¢…ë£Œì‹œê°„" id="promoEndTime" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;">
                                {% for h in range(24) %}
                                <option value="{{ '%02d:00'|format(h) }}"
                                    {{ 'selected' if campaign.get('í™ë³´ì¢…ë£Œì‹œê°„', '22:00') == '%02d:00'|format(h) }}>{{ '%02d:00'|format(h) }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- ë°œì†¡ ì£¼ê¸° -->
                    <div class="form-group promo-detail">
                        <label>ë°œì†¡ ì£¼ê¸°</label>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <input type="number" name="í™ë³´ì£¼ê¸°" id="promoCooldown"
                                value="{{ campaign.get('í™ë³´ì£¼ê¸°', '60') }}"
                                min="1" max="1440" style="width:100px;">
                            <span style="color:#666;font-size:14px;">ë¶„</span>
                        </div>
                        <small style="color:#888;font-size:12px;">ê°™ì€ ì¹´í…Œê³ ë¦¬ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ìµœì†Œ ê°„ê²©</small>
                    </div>

                    <!-- í™ë³´ ë©”ì‹œì§€ + ì¹´í†¡ ë¯¸ë¦¬ë³´ê¸° -->
                    <div class="form-group form-group-full promo-detail">
                        <label>í™ë³´ ë©”ì‹œì§€</label>
                        <div style="margin-bottom:8px;">
                            <button type="button" class="admin-btn" id="autoGenerateBtn" style="padding:6px 16px;font-size:13px;background:#fee500;border-color:#fee500;color:#3c1e1e;">ìë™ ìƒì„±</button>
                            <small style="color:#888;margin-left:8px;">í˜„ì¬ ì…ë ¥ëœ ìº í˜ì¸ ì •ë³´ë¡œ ê¸°ë³¸ í…œí”Œë¦¿ì„ ìƒì„±í•©ë‹ˆë‹¤</small>
                        </div>
                        <div class="promo-message-wrap">
                            <textarea name="í™ë³´ë©”ì‹œì§€" id="promotionMessage" rows="8" placeholder="í™ë³´ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.">{{ campaign.get('í™ë³´ë©”ì‹œì§€', '') }}</textarea>
                            <div class="kakao-preview">
                                <div class="kakao-preview-header">
                                    <span class="kakao-preview-title">ì¹´ì¹´ì˜¤í†¡ ë¯¸ë¦¬ë³´ê¸°</span>
                                </div>
                                <div class="kakao-preview-body" id="kakaoPreviewBody">
                                    <div class="kakao-date">ì˜¤ëŠ˜</div>
                                    <div class="kakao-msg-row">
                                        <div class="kakao-profile">
                                            <div class="kakao-avatar">ì¹´</div>
                                            <span class="kakao-name">ì¹´ë¹„ì„œ</span>
                                        </div>
                                        <div class="kakao-bubble" id="kakaoPreviewBubble">ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê¸°íƒ€ ì„¤ì • -->
            <div class="form-grid">
                <div class="form-group form-group-full">
                    <label>ìƒí’ˆì´ë¯¸ì§€</label>
                    {% set current_image = campaign.get('ìƒí’ˆì´ë¯¸ì§€', '') %}
                    {% if current_image %}
                    <div class="current-image">
                        <p style="font-size:12px;color:#666;margin-bottom:4px;">í˜„ì¬ ì´ë¯¸ì§€:</p>
                        <img src="{{ current_image.replace('/file/d/', '/thumbnail?id=').replace('/view', '&sz=w300') if '/file/d/' in current_image else current_image }}" alt="ìƒí’ˆì´ë¯¸ì§€" onerror="this.style.display='none'">
                    </div>
                    {% endif %}
                    <div class="file-upload-area" id="imageUploadArea" style="margin-top:8px;">
                        <input type="file" name="ìƒí’ˆì´ë¯¸ì§€" id="imageFile" accept="image/*">
                        <div class="file-upload-label" id="imageLabel">{{ 'ìƒˆ ì´ë¯¸ì§€ë¡œ êµì²´í•˜ë ¤ë©´ í´ë¦­' if current_image else 'í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš” (JPG, PNG)' }}</div>
                    </div>
                </div>

                <div class="form-group form-group-full">
                    <label>AI êµ¬ë§¤ìº¡ì³ ê²€ìˆ˜ ì§€ì¹¨</label>
                    <textarea name="AIêµ¬ë§¤ê²€ìˆ˜ì§€ì¹¨" rows="3" placeholder="ì˜ˆ: ë°˜ë“œì‹œ íŒë§¤ìë°°ì†¡ìœ¼ë¡œ êµ¬ë§¤í•´ì•¼ í•©ë‹ˆë‹¤. ë¡œì¼“ë°°ì†¡ì€ ë¶ˆê°€í•©ë‹ˆë‹¤.">{{ campaign.get('AIêµ¬ë§¤ê²€ìˆ˜ì§€ì¹¨', '') }}</textarea>
                    <small style="color:#888;">êµ¬ë§¤ë‚´ì—­ ìº¡ì³ ì—…ë¡œë“œ ì‹œ AI ê²€ìˆ˜ì— ì‚¬ìš©ë©ë‹ˆë‹¤. (ì„¤ì • í˜ì´ì§€ì˜ ê¸°ë³¸ì§€ì¹¨ì— ì¶”ê°€ë¡œ ì ìš©)</small>
                </div>
                <div class="form-group form-group-full">
                    <label>AI ë¦¬ë·°ìº¡ì³ ê²€ìˆ˜ ì§€ì¹¨</label>
                    <textarea name="AIë¦¬ë·°ê²€ìˆ˜ì§€ì¹¨" rows="3" placeholder="ì˜ˆ: ë¦¬ë·°ì— ì‚¬ì§„ì´ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. í…ìŠ¤íŠ¸ 100ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.">{{ campaign.get('AIë¦¬ë·°ê²€ìˆ˜ì§€ì¹¨', '') }}</textarea>
                    <small style="color:#888;">ë¦¬ë·° ìº¡ì³ ì—…ë¡œë“œ ì‹œ AI ê²€ìˆ˜ì— ì‚¬ìš©ë©ë‹ˆë‹¤. (ì„¤ì • í˜ì´ì§€ì˜ ê¸°ë³¸ì§€ì¹¨ì— ì¶”ê°€ë¡œ ì ìš©)</small>
                </div>

                <div class="form-group form-group-full">
                    <label>ë©”ëª¨</label>
                    <textarea name="ë©”ëª¨" rows="3">{{ campaign.get('ë©”ëª¨', '') }}</textarea>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="admin-btn admin-btn-primary">ì €ì¥</button>
                <a href="{{ url_for('admin.campaigns') }}" class="admin-btn">ì·¨ì†Œ</a>
            </div>
        </form>
    </main>
    <script>
    function updateBuyTime() {
        var s = document.getElementById('buyTimeStart').value;
        var e = document.getElementById('buyTimeEnd').value;
        var nd = document.getElementById('buyTimeNextDay').checked;
        var val = '';
        if (s && e) {
            val = s + ':00~' + (nd ? 'ìµì¼' : '') + e + ':00';
        }
        document.getElementById('buyTimeValue').value = val;
    }
    function clearBuyTime() {
        document.getElementById('buyTimeStart').value = '';
        document.getElementById('buyTimeEnd').value = '';
        document.getElementById('buyTimeNextDay').checked = false;
        document.getElementById('buyTimeValue').value = '';
    }
    document.getElementById('buyTimeStart').addEventListener('change', updateBuyTime);
    document.getElementById('buyTimeEnd').addEventListener('change', updateBuyTime);
    document.getElementById('buyTimeNextDay').addEventListener('change', updateBuyTime);

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ
    (function() {
        var area = document.getElementById('imageUploadArea');
        var fileInput = document.getElementById('imageFile');
        var label = document.getElementById('imageLabel');
        area.addEventListener('click', function() { fileInput.click(); });
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                label.textContent = this.files[0].name;
                area.classList.add('has-file');
            } else {
                label.textContent = 'í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš” (JPG, PNG)';
                area.classList.remove('has-file');
            }
        });
    })();

    // ê¸°ì¡´ ê°’ íŒŒì‹±í•´ì„œ ë“œë¡­ë‹¤ìš´ì— ì„¸íŒ…
    (function() {
        var raw = document.getElementById('buyTimeValue').value.trim();
        if (!raw) return;
        var nd = raw.indexOf('ìµì¼') >= 0;
        var clean = raw.replace('ìµì¼', '').replace(/\s/g, '');
        var m = clean.match(/(\d{1,2}):(\d{2})[~\-](\d{1,2}):(\d{2})/);
        if (m) {
            document.getElementById('buyTimeStart').value = ('0' + m[1]).slice(-2);
            document.getElementById('buyTimeEnd').value = ('0' + m[3]).slice(-2);
            document.getElementById('buyTimeNextDay').checked = nd;
        }
    })();

    // ì¼ì • ì¬ìƒì„±
    function regenerateSchedule() {
        var total = parseInt(document.querySelector('[name="ì´ìˆ˜ëŸ‰"]').value) || 0;
        var dailyStr = (document.querySelector('[name="ì¼ìˆ˜ëŸ‰"]').value || '').trim();
        var days = parseInt(document.querySelector('[name="ì§„í–‰ì¼ìˆ˜"]').value) || 0;
        if (!total || !days || !dailyStr) { alert('ì´ìˆ˜ëŸ‰, ì¼ìˆ˜ëŸ‰, ì§„í–‰ì¼ìˆ˜ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.'); return; }

        var lo, hi;
        var m = dailyStr.match(/^(\d+)\s*[-~]\s*(\d+)$/);
        if (m) { lo = parseInt(m[1]); hi = parseInt(m[2]); }
        else { lo = hi = parseInt(dailyStr) || 0; }
        if (lo <= 0 || hi < lo) { alert('ì¼ìˆ˜ëŸ‰ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

        var schedule = [], remaining = total;
        for (var i = 0; i < days; i++) {
            if (i === days - 1) { schedule.push(Math.max(0, remaining)); }
            else {
                var left = days - i - 1;
                var minT = Math.max(lo, remaining - hi * left);
                var maxT = Math.min(hi, remaining - lo * left);
                if (minT > maxT) minT = maxT = Math.max(1, Math.round(remaining / (left + 1)));
                var val = Math.floor(Math.random() * (maxT - minT + 1)) + minT;
                val = Math.min(val, remaining);
                schedule.push(val);
                remaining -= val;
            }
        }
        document.querySelector('[name="ì¼ì •"]').value = schedule.join(', ');
        alert('ì¼ì • ì¬ìƒì„±: ' + schedule.join(', ') + ' (í•©ê³„: ' + schedule.reduce(function(a,b){return a+b;},0) + 'ëª…)');
    }

    // í™ë³´ ë©”ì‹œì§€ ìë™ ìƒì„±
    document.getElementById('autoGenerateBtn').addEventListener('click', function() {
        var productName = document.querySelector('[name="ìƒí’ˆëª…"]').value || '(ìƒí’ˆëª…)';
        var productPrice = document.querySelector('[name="ê²°ì œê¸ˆì•¡"]').value || 'í™•ì¸í•„ìš”';
        var campaignType = document.querySelector('[name="ìº í˜ì¸ìœ í˜•"]').value || 'ì‹¤ë°°ì†¡';
        var totalQty = document.querySelector('[name="ì´ìˆ˜ëŸ‰"]').value || '0';

        var msg = 'ğŸ“¢ ì²´í—˜ë‹¨ ëª¨ì§‘\n\n'
            + productName + '\n'
            + 'ğŸ’° ê²°ì œê¸ˆì•¡: ' + productPrice + 'ì›\n'
            + 'ğŸ“¦ ' + campaignType + '\n'
            + 'ğŸ‘¥ ' + totalQty + 'ëª… ëª¨ì§‘\n\n'
            + 'ğŸ‘‰ ì‹ ì²­í•˜ê¸°';

        document.getElementById('promotionMessage').value = msg;
        updateKakaoPreview();
    });

    // í™ë³´ í™œì„±í™” í† ê¸€
    (function() {
        var promoEnabled = document.getElementById('promoEnabled');
        var promoStatusLabel = document.getElementById('promoStatusLabel');
        var promoDetails = document.querySelectorAll('.promo-detail');

        function updatePromoState() {
            var on = promoEnabled.checked;
            promoStatusLabel.textContent = on ? 'ON' : 'OFF';
            promoStatusLabel.classList.toggle('on', on);
            promoDetails.forEach(function(el) {
                el.classList.toggle('disabled', !on);
            });
        }
        promoEnabled.addEventListener('change', updatePromoState);
        updatePromoState();

        // ì¹´í…Œê³ ë¦¬ ì²´í¬ë°•ìŠ¤ â†’ hidden input ë™ê¸°í™”
        var catCheckboxes = document.querySelectorAll('.promo-cat-cb');
        var catEtcInput = document.getElementById('promoCatEtcInput');
        var catEtcCb = document.getElementById('promoCatEtc');
        var catHidden = document.getElementById('promoCategoriesValue');

        function updatePromoCategories() {
            var cats = [];
            catCheckboxes.forEach(function(cb) {
                if (cb.checked) {
                    if (cb.id === 'promoCatEtc') {
                        var v = catEtcInput.value.trim();
                        if (v) cats.push(v);
                    } else {
                        cats.push(cb.value);
                    }
                }
            });
            catHidden.value = cats.join(',');
        }
        catCheckboxes.forEach(function(cb) { cb.addEventListener('change', updatePromoCategories); });
        catEtcInput.addEventListener('input', function() {
            if (this.value.trim()) catEtcCb.checked = true;
            updatePromoCategories();
        });

        // ì¹´ì¹´ì˜¤í†¡ ë¯¸ë¦¬ë³´ê¸°
        var promoTextarea = document.getElementById('promotionMessage');
        var kakaoBubble = document.getElementById('kakaoPreviewBubble');

        window.updateKakaoPreview = function() {
            var text = promoTextarea.value.trim();
            if (text) {
                kakaoBubble.textContent = text;
            } else {
                kakaoBubble.textContent = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.';
            }
        };
        promoTextarea.addEventListener('input', window.updateKakaoPreview);
        // ì´ˆê¸° ë¡œë“œ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        window.updateKakaoPreview();
    })();

    // í¼ ì œì¶œ ì „ êµ¬ë§¤ì‹œê°„ ê°’ í™•ì¸
    document.querySelector('form').addEventListener('submit', function() {
        updateBuyTime();
    });
    </script>
</body>
</html>
