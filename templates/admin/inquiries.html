<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카비서 관리자 - 문의 관리</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
    .admin-status-badge.대기 { background: #fef3c7; color: #92400e; }
    .admin-status-badge.완료 { background: #d1fae5; color: #065f46; }
    </style>
</head>
<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-logo">카비서 관리자</a>
            <nav class="admin-nav">
                <a href="{{ url_for('admin.dashboard') }}">대시보드</a>
                <a href="{{ url_for('admin.campaigns') }}">캠페인</a>
                <a href="{{ url_for('admin.overview') }}">전체현황</a>
                <a href="{{ url_for('admin.chat_list') }}">대화이력</a>
                <a href="{{ url_for('admin.reviews') }}">검수</a>
                <a href="{{ url_for('admin.settlement') }}">정산</a>
                <a href="{{ url_for('admin.activity_logs') }}">활동로그</a>
                <a href="{{ url_for('admin.reviewers') }}">리뷰어</a>
                <a href="{{ url_for('admin.inquiries') }}" class="active">문의{% if pending_inquiry_count %}<span style="background:#ef4444;color:#fff;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;">{{ pending_inquiry_count }}</span>{% endif %}</a>
                <a href="{{ url_for('admin.spreadsheet') }}">데이터</a>
                <a href="{{ url_for('admin.guide') }}">가이드</a>
                <a href="{{ url_for('admin.logout') }}">로그아웃</a>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <h1>문의 관리 {% if pending_inquiry_count %}<span style="color:#ef4444;font-size:16px;">(대기 {{ pending_inquiry_count }}건)</span>{% endif %}</h1>

        <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">
            <label for="statusFilter" style="font-weight:600;">상태:</label>
            <select id="statusFilter" onchange="filterStatus(this.value)" style="padding:0.4rem 0.8rem; border:1px solid #d1d5db; border-radius:6px;">
                <option value="" {% if not status_filter %}selected{% endif %}>전체</option>
                <option value="대기" {% if status_filter == '대기' %}selected{% endif %}>대기</option>
                <option value="완료" {% if status_filter == '완료' %}selected{% endif %}>완료</option>
            </select>
        </div>

        <div class="admin-table-wrap">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width:50px;">ID</th>
                        <th>날짜</th>
                        <th>이름</th>
                        <th>연락처</th>
                        <th>문의내용</th>
                        <th>상태</th>
                        <th style="width:80px;">긴급</th>
                        <th style="width:80px;">답변</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in inquiries %}
                    <tr>
                        <td>{{ item.id }}</td>
                        <td>{{ item.created_at.strftime('%m/%d %H:%M') if item.created_at else '' }}</td>
                        <td>{{ item.reviewer_name }}</td>
                        <td>{{ item.reviewer_phone }}</td>
                        <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="{{ item.message }}">{{ item.message[:50] }}{% if item.message|length > 50 %}...{% endif %}</td>
                        <td><span class="admin-status-badge {{ item.status }}">{{ item.status }}</span></td>
                        <td>{% if item.is_urgent %}<span style="color:#ef4444;font-weight:700;">긴급</span>{% endif %}</td>
                        <td>
                            {% if item.status == '대기' %}
                            <button class="btn btn-sm btn-primary reply-btn" data-idx="{{ loop.index0 }}">답변</button>
                            {% else %}
                            <button class="btn btn-sm view-btn" data-idx="{{ loop.index0 }}" style="background:#e5e7eb;border:none;padding:2px 8px;border-radius:4px;cursor:pointer;font-size:12px;">보기</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not inquiries %}
                    <tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:2rem;">문의가 없습니다.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- 답변 모달 -->
    <div id="replyModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
        <div style="background:#fff;border-radius:12px;padding:24px;max-width:520px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h3 style="margin:0;" id="replyTitle">문의 답변</h3>
                <button onclick="closeReplyModal()" style="border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
            </div>

            <div style="margin-bottom:12px;">
                <label style="font-weight:600;display:block;margin-bottom:4px;">문의 내용:</label>
                <div id="inquiryMessage" style="background:#f3f4f6;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:120px;overflow-y:auto;"></div>
            </div>

            <div id="contextArea" style="margin-bottom:12px;display:none;">
                <label style="font-weight:600;display:block;margin-bottom:4px;">대화 맥락:</label>
                <div id="inquiryContext" style="background:#f9fafb;padding:12px;border-radius:8px;font-size:12px;white-space:pre-wrap;max-height:150px;overflow-y:auto;color:#6b7280;"></div>
            </div>

            <div style="margin-bottom:16px;">
                <label style="font-weight:600;display:block;margin-bottom:4px;">답변:</label>
                <textarea id="replyText" rows="4" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;resize:vertical;box-sizing:border-box;" placeholder="답변 내용을 입력해주세요..."></textarea>
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button onclick="closeReplyModal()" style="padding:8px 16px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;">취소</button>
                <button onclick="submitReply()" style="padding:8px 16px;border:none;border-radius:6px;background:#3b82f6;color:#fff;cursor:pointer;font-weight:600;">답변 발송</button>
            </div>
        </div>
    </div>

    <script>
    var INQUIRIES = [
        {% for item in inquiries %}
        {
            "id": {{ item.id }},
            "reviewer_name": {{ (item.reviewer_name or '')|tojson }},
            "message": {{ (item.message or '')|tojson }},
            "context": {{ (item.context or '')|tojson }},
            "admin_reply": {{ (item.admin_reply or '')|tojson }},
            "status": {{ (item.status or '')|tojson }}
        }{{ ',' if not loop.last }}
        {% endfor %}
    ];

    var _replyInquiryId = 0;

    function filterStatus(val) {
        var url = '/admin/inquiries';
        if (val) url += '?status=' + val;
        location.href = url;
    }

    function openReplyModal(idx) {
        var item = INQUIRIES[idx];
        if (!item) return;

        _replyInquiryId = item.id;
        document.getElementById('replyTitle').textContent = (item.reviewer_name || '') + ' 문의 답변';
        document.getElementById('inquiryMessage').textContent = item.message || '';
        document.getElementById('replyText').value = '';

        var ctxArea = document.getElementById('contextArea');
        var ctx = item.context || '';
        if (ctx.trim()) {
            document.getElementById('inquiryContext').textContent = ctx;
            ctxArea.style.display = 'block';
        } else {
            ctxArea.style.display = 'none';
        }

        document.getElementById('replyModal').style.display = 'flex';
    }

    function closeReplyModal() {
        document.getElementById('replyModal').style.display = 'none';
    }

    function viewReply(idx) {
        var item = INQUIRIES[idx];
        if (!item) return;
        alert('답변 내용:\n\n' + (item.admin_reply || ''));
    }

    function submitReply() {
        var reply = document.getElementById('replyText').value.trim();
        if (!reply) { alert('답변 내용을 입력해주세요.'); return; }

        fetch('/admin/api/inquiry/reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ inquiry_id: _replyInquiryId, reply: reply })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            closeReplyModal();
            if (d.ok) {
                alert('답변 완료! ' + (d.message || ''));
                location.reload();
            } else {
                alert('실패: ' + (d.message || '알 수 없는 오류'));
            }
        })
        .catch(function(e) {
            closeReplyModal();
            alert('에러: ' + e.message);
        });
    }

    // 이벤트 위임으로 버튼 클릭 처리
    document.addEventListener('click', function(e) {
        var btn = e.target.closest('.reply-btn');
        if (btn) {
            openReplyModal(parseInt(btn.dataset.idx));
            return;
        }
        var vbtn = e.target.closest('.view-btn');
        if (vbtn) {
            viewReply(parseInt(vbtn.dataset.idx));
            return;
        }
    });

    // 모달 바깥 클릭 닫기
    document.getElementById('replyModal').addEventListener('click', function(e) {
        if (e.target === this) closeReplyModal();
    });
    </script>
</body>
</html>
