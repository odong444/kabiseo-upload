<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë¹„ì„œ ê´€ë¦¬ì - ìº í˜ì¸ ì‹ ê·œ ë“±ë¡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .form-section { margin-bottom: 32px; }
        .form-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: #3c1e1e;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #fee500;
        }
        .hidden { display: none !important; }
        .radio-group { display: flex; gap: 16px; align-items: center; padding: 10px 0; }
        .radio-group label { display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer; margin-bottom: 0; }
        .radio-group input[type="radio"] { width: auto; margin: 0; }
        .dup-days-input { display: inline-block; width: 80px; margin: 0 6px; }
        .calc-hint {
            font-size: 12px; color: #888; margin-top: 6px;
            background: #f9f9f9; padding: 8px 12px; border-radius: 6px;
        }
        .file-upload-area {
            border: 2px dashed #ddd; border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
        }
        .file-upload-area:hover { border-color: #fee500; }
        .file-upload-area.has-file { border-color: #4caf50; background: #f0faf0; }
        .file-upload-area input[type="file"] { display: none; }
        .file-upload-label { color: #888; font-size: 14px; }
        .file-upload-area.has-file .file-upload-label { color: #4caf50; font-weight: 600; }
        .preview-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .preview-modal.active { display: flex; }
        .preview-content {
            background: #fff; border-radius: 12px; padding: 24px; max-width: 500px;
            width: 90%; max-height: 80vh; overflow-y: auto; position: relative;
        }
        .preview-close {
            position: absolute; top: 12px; right: 16px; font-size: 24px;
            cursor: pointer; color: #999; background: none; border: none;
        }
        .preview-section { margin-bottom: 20px; }
        .preview-section h4 { font-size: 14px; color: #3c1e1e; margin-bottom: 8px; }
        .preview-card {
            background: #f9f9f9; border-radius: 8px; padding: 16px;
            border-left: 4px solid #fee500; font-size: 13px; line-height: 1.6;
        }
        .preview-recruit {
            background: #f0f7ff; border-radius: 8px; padding: 16px;
            font-size: 13px; line-height: 1.6; white-space: pre-wrap;
        }
        .form-actions { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
        .admin-btn-preview {
            background: #fee500; color: #3c1e1e; border-color: #fee500; font-weight: 600;
        }
        .admin-btn-preview:hover { background: #f5d800; }
    </style>
</head>
<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-logo">ì¹´ë¹„ì„œ ê´€ë¦¬ì</a>
            <nav class="admin-nav">
                <a href="{{ url_for('admin.dashboard') }}">ëŒ€ì‹œë³´ë“œ</a>
                <a href="{{ url_for('admin.campaigns') }}" class="active">ìº í˜ì¸</a>
                <a href="{{ url_for('admin.overview') }}">ì „ì²´í˜„í™©</a>
                <a href="{{ url_for('admin.chat_list') }}">ëŒ€í™”ì´ë ¥</a>
                <a href="{{ url_for('admin.reviews') }}">ê²€ìˆ˜</a>
                <a href="{{ url_for('admin.settlement') }}">ì •ì‚°</a>
                <a href="{{ url_for('admin.activity_logs') }}">í™œë™ë¡œê·¸</a>
                <a href="{{ url_for('admin.reviewers') }}">ë¦¬ë·°ì–´</a>
                <a href="{{ url_for('admin.guide') }}">ê°€ì´ë“œ</a>
                <a href="{{ url_for('admin.logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <h1>ìº í˜ì¸ ì‹ ê·œ ë“±ë¡</h1>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="admin-flash">
            {% for msg in messages %}
            <p>{{ msg }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form id="campaignForm" method="POST" action="{{ url_for('admin.campaign_new_post') }}" enctype="multipart/form-data" class="admin-form">

            <!-- ìº í˜ì¸ ì •ë³´ -->
            <div class="form-section">
                <h3>ìº í˜ì¸ ì •ë³´</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ìº í˜ì¸ì œëª© (ìƒí’ˆëª…) *</label>
                        <input type="text" name="ìƒí’ˆëª…" required placeholder="ì˜ˆ: ë“¤ê¸°ë¦„ 300ml">
                    </div>
                    <div class="form-group">
                        <label>ì—…ì²´ëª… *</label>
                        <input type="text" name="ì—…ì²´ëª…" required placeholder="ì˜ˆ: ê±´ê°•í•œë“¤ë…˜">
                    </div>
                    <div class="form-group">
                        <label>í”Œë«í¼ *</label>
                        <select name="í”Œë«í¼" id="platformSelect" required>
                            <option value="ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</option>
                            <option value="ì¿ íŒ¡">ì¿ íŒ¡</option>
                            <option value="ì˜¤ëŠ˜ì˜ì§‘">ì˜¤ëŠ˜ì˜ì§‘</option>
                            <option value="11ë²ˆê°€">11ë²ˆê°€</option>
                            <option value="ì§€ë§ˆì¼“">ì§€ë§ˆì¼“</option>
                            <option value="ì˜¬ë¦¬ë¸Œì˜">ì˜¬ë¦¬ë¸Œì˜</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="platformCustomWrap">
                        <label>í”Œë«í¼ ì§ì ‘ì…ë ¥</label>
                        <input type="text" id="platformCustom" placeholder="í”Œë«í¼ëª… ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ìº í˜ì¸ìœ í˜• *</label>
                        <select name="ìº í˜ì¸ìœ í˜•" required>
                            <option value="ì‹¤ë°°ì†¡">ì‹¤ë°°ì†¡</option>
                            <option value="ë¹ˆë°•ìŠ¤">ë¹ˆë°•ìŠ¤</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìƒí’ˆê¸ˆì•¡</label>
                        <input type="text" name="ìƒí’ˆê¸ˆì•¡" placeholder="ì˜ˆ: 29,000">
                    </div>
                    <div class="form-group">
                        <label>ë¦¬ì›Œë“œ (ë¦¬ë·°ë¹„)</label>
                        <input type="text" name="ë¦¬ë·°ë¹„" placeholder="ì˜ˆ: 15,000">
                    </div>
                    <div class="form-group form-group-full">
                        <label>ìƒí’ˆì´ë¯¸ì§€</label>
                        <div class="file-upload-area" id="imageUploadArea">
                            <input type="file" name="ìƒí’ˆì´ë¯¸ì§€" id="imageFile" accept="image/*">
                            <div class="file-upload-label" id="imageLabel">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš” (JPG, PNG)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìš´ì˜ ì„¤ì • -->
            <div class="form-section">
                <h3>ìš´ì˜ ì„¤ì •</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ì´ ëª¨ì§‘ì¸ì› *</label>
                        <input type="number" name="ì´ìˆ˜ëŸ‰" id="totalCount" required min="1" placeholder="ì˜ˆ: 20">
                    </div>
                    <div class="form-group">
                        <label>í•˜ë£¨ì§„í–‰ëŸ‰</label>
                        <input type="text" name="ì¼ìˆ˜ëŸ‰" id="dailyCount" placeholder="ìˆ«ì(ì˜ˆ: 5) ë˜ëŠ” ë²”ìœ„(ì˜ˆ: 3-5)">
                    </div>
                    <div class="form-group">
                        <label>ì§„í–‰ì¼ìˆ˜</label>
                        <input type="number" name="ì§„í–‰ì¼ìˆ˜" id="dayCount" min="1" placeholder="ì˜ˆ: 4">
                    </div>
                    <div class="form-group form-group-full">
                        <div class="calc-hint hidden" id="calcHint"></div>
                    </div>
                    <div class="form-group">
                        <label>ëª¨ì§‘ ë° êµ¬ë§¤ì§„í–‰ì‹œê°„</label>
                        <input type="text" name="êµ¬ë§¤ê°€ëŠ¥ì‹œê°„" placeholder="ì˜ˆ: 18:00 ~ ìµì¼ 07:00">
                    </div>
                    <div class="form-group form-group-full">
                        <label>ì¤‘ë³µì§„í–‰ ê°€ëŠ¥ì—¬ë¶€</label>
                        <div class="radio-group">
                            <label><input type="radio" name="ì¤‘ë³µì§„í–‰" value="Y" checked> ê°€ëŠ¥</label>
                            <label><input type="radio" name="ì¤‘ë³µì§„í–‰" value="N"> ë¶ˆê°€ëŠ¥</label>
                            <label>
                                <input type="radio" name="ì¤‘ë³µì§„í–‰" value="í…€" id="dupTermRadio"> ì¼ì •ê¸°ê°„ í…€
                                <input type="number" class="dup-days-input hidden" id="dupDaysInput" min="1" placeholder="ì¼">
                                <span class="hidden" id="dupDaysLabel">ì¼ í›„ ê°€ëŠ¥</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group form-group-full">
                        <label>ìº í˜ì¸ ê°€ì´ë“œ</label>
                        <textarea name="ìº í˜ì¸ê°€ì´ë“œ" rows="6" placeholder="ë¦¬ë·°ì–´ì—ê²Œ ì „ë‹¬í•  êµ¬ë§¤ ê°€ì´ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.&#10;&#10;ì˜ˆì‹œ:&#10;1. ë„¤ì´ë²„ì—ì„œ 'ë“¤ê¸°ë¦„ êµ­ì‚°' ê²€ìƒ‰&#10;2. 'ê±´ê°•í•œë“¤ë…˜' ìŠ¤í† ì–´ ì°¾ê¸°&#10;3. ìƒí’ˆ í˜ì´ì§€ì—ì„œ 3ë¶„ ì´ìƒ ì²´ë¥˜&#10;4. ì˜µì…˜: 300ml ì„ íƒ í›„ êµ¬ë§¤&#10;5. ê²°ì œ ì‹œ ë„¤ì´ë²„í˜ì´ ì‚¬ìš©"></textarea>
                    </div>
                </div>
            </div>

            <!-- ìˆ¨ê²¨ì§„ í•„ë“œ: ì¤‘ë³µí—ˆìš© ì‹¤ì œê°’ -->
            <input type="hidden" name="ì¤‘ë³µí—ˆìš©" id="dupAllowValue" value="Y">

            <div class="form-actions">
                <button type="button" class="admin-btn admin-btn-preview" id="previewBtn">ë¯¸ë¦¬ë³´ê¸°</button>
                <button type="submit" class="admin-btn admin-btn-primary">ë“±ë¡</button>
                <a href="{{ url_for('admin.campaigns') }}" class="admin-btn">ì·¨ì†Œ</a>
            </div>
        </form>
    </main>

    <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <button class="preview-close" id="previewClose">&times;</button>
            <h3 style="margin-bottom: 16px;">ìº í˜ì¸ ë¯¸ë¦¬ë³´ê¸°</h3>

            <div class="preview-section">
                <h4>ì±„íŒ… ìº í˜ì¸ ì¹´ë“œ</h4>
                <div class="preview-card" id="previewCard">
                    ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </div>
            </div>

            <div class="preview-section">
                <h4>ëª¨ì§‘ê¸€</h4>
                <div class="preview-recruit" id="previewRecruit">
                    ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // í”Œë«í¼ "ê¸°íƒ€" í† ê¸€
        const platformSelect = document.getElementById('platformSelect');
        const platformCustomWrap = document.getElementById('platformCustomWrap');
        const platformCustom = document.getElementById('platformCustom');

        platformSelect.addEventListener('change', function() {
            if (this.value === 'ê¸°íƒ€') {
                platformCustomWrap.classList.remove('hidden');
                platformCustom.focus();
            } else {
                platformCustomWrap.classList.add('hidden');
                platformCustom.value = '';
            }
        });

        // ì¤‘ë³µì§„í–‰ í…€ í† ê¸€
        const dupRadios = document.querySelectorAll('input[name="ì¤‘ë³µì§„í–‰"]');
        const dupDaysInput = document.getElementById('dupDaysInput');
        const dupDaysLabel = document.getElementById('dupDaysLabel');
        const dupAllowValue = document.getElementById('dupAllowValue');

        dupRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                if (this.value === 'í…€') {
                    dupDaysInput.classList.remove('hidden');
                    dupDaysLabel.classList.remove('hidden');
                    dupDaysInput.focus();
                } else {
                    dupDaysInput.classList.add('hidden');
                    dupDaysLabel.classList.add('hidden');
                    dupDaysInput.value = '';
                }
                updateDupValue();
            });
        });

        dupDaysInput.addEventListener('input', updateDupValue);

        function updateDupValue() {
            const selected = document.querySelector('input[name="ì¤‘ë³µì§„í–‰"]:checked').value;
            if (selected === 'í…€') {
                const days = dupDaysInput.value || '30';
                dupAllowValue.value = 'í…€:' + days;
            } else {
                dupAllowValue.value = selected;
            }
        }

        // í•˜ë£¨ì§„í–‰ëŸ‰ + ì§„í–‰ì¼ìˆ˜ = ë°°ë¶„ ê³„ì‚°
        const totalCountEl = document.getElementById('totalCount');
        const dailyCountEl = document.getElementById('dailyCount');
        const dayCountEl = document.getElementById('dayCount');
        const calcHint = document.getElementById('calcHint');

        [totalCountEl, dailyCountEl, dayCountEl].forEach(function(el) {
            el.addEventListener('input', updateCalcHint);
        });

        function updateCalcHint() {
            const total = parseInt(totalCountEl.value) || 0;
            const dailyStr = dailyCountEl.value.trim();
            const days = parseInt(dayCountEl.value) || 0;

            if (!total || !dailyStr || !days) {
                calcHint.classList.add('hidden');
                return;
            }

            // ë²”ìœ„ ì…ë ¥ (ì˜ˆ: 3-5)
            const rangeMatch = dailyStr.match(/^(\d+)\s*[-~]\s*(\d+)$/);
            let distribution = [];

            if (rangeMatch) {
                const lo = parseInt(rangeMatch[1]);
                const hi = parseInt(rangeMatch[2]);
                let remaining = total;
                for (let i = 0; i < days; i++) {
                    if (i === days - 1) {
                        distribution.push(Math.max(0, remaining));
                    } else {
                        const avg = remaining / (days - i);
                        let val = Math.round(avg);
                        val = Math.max(lo, Math.min(hi, val));
                        val = Math.min(val, remaining);
                        distribution.push(val);
                        remaining -= val;
                    }
                }
                const sum = distribution.reduce(function(a, b) { return a + b; }, 0);
                calcHint.innerHTML = 'ì˜ˆìƒ ë°°ë¶„ (' + lo + '~' + hi + 'ëª…/ì¼): ' + distribution.join(', ') + ' = <b>' + sum + 'ëª…</b>' +
                    (sum !== total ? ' <span style="color:#e53e3e">(ì´ ëª¨ì§‘ì¸ì› ' + total + 'ëª…ê³¼ ë¶ˆì¼ì¹˜)</span>' : ' âœ…');
            } else {
                const daily = parseInt(dailyStr);
                if (!daily) { calcHint.classList.add('hidden'); return; }
                let remaining = total;
                for (let i = 0; i < days; i++) {
                    const val = Math.min(daily, remaining);
                    distribution.push(val);
                    remaining -= val;
                }
                const sum = distribution.reduce(function(a, b) { return a + b; }, 0);
                calcHint.innerHTML = 'ì˜ˆìƒ ë°°ë¶„ (' + daily + 'ëª…/ì¼): ' + distribution.join(', ') + ' = <b>' + sum + 'ëª…</b>' +
                    (sum !== total ? ' <span style="color:#e53e3e">(ì´ ëª¨ì§‘ì¸ì› ' + total + 'ëª…ê³¼ ë¶ˆì¼ì¹˜)</span>' : ' âœ…');
            }
            calcHint.classList.remove('hidden');
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageFile = document.getElementById('imageFile');
        const imageLabel = document.getElementById('imageLabel');

        imageUploadArea.addEventListener('click', function() { imageFile.click(); });
        imageFile.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                imageLabel.textContent = this.files[0].name;
                imageUploadArea.classList.add('has-file');
            } else {
                imageLabel.textContent = 'í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš” (JPG, PNG)';
                imageUploadArea.classList.remove('has-file');
            }
        });

        // í¼ submit ì‹œ í”Œë«í¼ ê¸°íƒ€ ê°’ ëŒ€ì²´
        document.getElementById('campaignForm').addEventListener('submit', function() {
            if (platformSelect.value === 'ê¸°íƒ€' && platformCustom.value.trim()) {
                platformSelect.value = '';
                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'í”Œë«í¼';
                hiddenInput.value = platformCustom.value.trim();
                this.appendChild(hiddenInput);
            }
        });

        // ë¯¸ë¦¬ë³´ê¸°
        const previewBtn = document.getElementById('previewBtn');
        const previewModal = document.getElementById('previewModal');
        const previewClose = document.getElementById('previewClose');
        const previewCard = document.getElementById('previewCard');
        const previewRecruit = document.getElementById('previewRecruit');

        previewBtn.addEventListener('click', function() {
            const formData = {
                ìƒí’ˆëª…: document.querySelector('[name="ìƒí’ˆëª…"]').value,
                ì—…ì²´ëª…: document.querySelector('[name="ì—…ì²´ëª…"]').value,
                í”Œë«í¼: platformSelect.value === 'ê¸°íƒ€' ? platformCustom.value : platformSelect.value,
                ì´ìˆ˜ëŸ‰: document.querySelector('[name="ì´ìˆ˜ëŸ‰"]').value,
                ìƒí’ˆê¸ˆì•¡: document.querySelector('[name="ìƒí’ˆê¸ˆì•¡"]').value,
                ë¦¬ë·°ë¹„: document.querySelector('[name="ë¦¬ë·°ë¹„"]').value,
                êµ¬ë§¤ê°€ëŠ¥ì‹œê°„: document.querySelector('[name="êµ¬ë§¤ê°€ëŠ¥ì‹œê°„"]').value,
                ìº í˜ì¸ê°€ì´ë“œ: document.querySelector('[name="ìº í˜ì¸ê°€ì´ë“œ"]').value,
                ì¤‘ë³µí—ˆìš©: dupAllowValue.value,
            };

            fetch("{{ url_for('admin.api_campaign_preview') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.card) {
                    var c = data.card;
                    var html = '<div style="margin-bottom:8px;font-weight:700;font-size:15px;">' + (c.name || '') + '</div>';
                    html += '<div>ğŸª ' + (c.store || '') + '</div>';
                    html += '<div>ğŸ” ' + (c.method || 'ë¯¸ì •') + '</div>';
                    html += '<div>ğŸ‘¥ ë‚¨ì€ ' + (c.remaining || 0) + 'ìë¦¬</div>';
                    if (c.price) html += '<div>ğŸ’° ' + c.price + 'ì›</div>';
                    previewCard.innerHTML = html;
                }
                if (data.recruit_text) {
                    previewRecruit.textContent = data.recruit_text;
                }
                previewModal.classList.add('active');
            })
            .catch(function(err) {
                alert('ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: ' + err.message);
            });
        });

        previewClose.addEventListener('click', function() { previewModal.classList.remove('active'); });
        previewModal.addEventListener('click', function(e) {
            if (e.target === previewModal) previewModal.classList.remove('active');
        });
    })();
    </script>
</body>
</html>
