{% extends "base.html" %}
{% block title %}캠페인 목록 - 카비서{% endblock %}
{% block head %}
<script src="{{ url_for('static', filename='js/reviewer.js') }}"></script>
<style>
.campaign-schedule { padding: 0 16px 10px; }
.sch-label { font-size: 11px; color: #64748b; font-weight: 600; display: block; margin-bottom: 4px; }
.sch-blocks { display: flex; gap: 3px; flex-wrap: wrap; }
.sch-block {
    display: flex; flex-direction: column; align-items: center;
    background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 4px;
    padding: 2px 6px; min-width: 34px; font-size: 11px;
}
.sch-day { color: #94a3b8; font-size: 10px; }
.sch-qty { font-weight: 700; color: #334155; }
.sch-block.sch-today { background: #dbeafe; border-color: #3b82f6; }
.sch-block.sch-today .sch-day { color: #2563eb; }
.sch-block.sch-today .sch-qty { color: #1d4ed8; }
.sch-block.sch-past { opacity: 0.4; }
</style>
{% endblock %}
{% block content %}
<div class="page-content">
    <h1 class="page-title">캠페인 목록</h1>
    <p class="page-subtitle">참여하고 싶은 캠페인을 선택하세요</p>

    <div id="campaignList" class="campaign-list">
        <div class="loading">불러오는 중...</div>
    </div>
</div>

{% endblock %}

{% block nav %}
<nav class="bottom-nav">
    <a href="/campaigns" class="nav-item active">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">캠페인</span>
    </a>
    <a href="/my" class="nav-item">
        <span class="nav-icon">&#x1f4dd;</span>
        <span class="nav-label">내작업</span>
    </a>
    <a href="/upload" class="nav-item">
        <span class="nav-icon">&#x1f4f7;</span>
        <span class="nav-label">리뷰제출</span>
    </a>
</nav>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const user = Reviewer.getUser();

    async function loadCampaigns() {
        const data = await Reviewer.apiGet('/api/campaigns');
        const container = document.getElementById('campaignList');

        if (!data || data.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>현재 참여 가능한 캠페인이 없습니다.</p></div>';
            return;
        }

        let html = '';
        for (const card of data) {
            const closed = card.closed;
            const closedClass = closed ? 'campaign-card-closed' : '';
            const cid = card.campaign_id || '';
            const hasHistory = card.my_history && card.my_history.length > 0;

            html += `<div class="campaign-card ${closedClass}" data-id="${cid}">
                <div class="campaign-card-header">
                    <div class="campaign-card-title-row" style="flex:1; min-width:0;">
                        <span class="campaign-card-name">${card.name}</span>
                        ${closed
                            ? `<span class="campaign-closed">${card.closed_reason || '마감'}</span>`
                            : card.urgent
                                ? '<span class="campaign-urgent">마감임박</span>'
                                : `<span class="campaign-remain-badge">${card.remaining}자리</span>`
                        }
                    </div>
                    ${closed
                        ? ''
                        : `<a href="/c/${cid}" class="campaign-apply-btn">신청</a>`
                    }
                </div>
                <div class="campaign-card-detail-row">
                    <span class="campaign-card-store">${card.store || ''}</span>
                    ${card.product_price ? `<span class="campaign-card-price">${Reviewer.formatNumber(card.product_price)}원</span>` : ''}
                    ${card.review_fee ? `<span class="campaign-card-fee">리뷰비 ${Reviewer.formatNumber(card.review_fee)}원</span>` : ''}
                </div>
                ${card.buy_time ? `<div class="campaign-card-time ${card.buy_time_closed ? 'closed' : ''}">구매시간 ${card.buy_time}</div>` : ''}
                ${renderSchedule(card.schedule, card.start_date)}
                ${hasHistory ? renderHistory(card.my_history, cid) : ''}
            </div>`;
        }
        container.innerHTML = html;
    }

    function renderSchedule(schedule, startDate) {
        if (!schedule || schedule.length === 0) return '';
        const today = new Date();
        today.setHours(today.getHours() + 9); // UTC→KST
        const todayStr = today.toISOString().slice(0, 10);

        let dayIndex = -1;
        if (startDate) {
            const sd = new Date(startDate + 'T00:00:00+09:00');
            const diff = Math.floor((today - sd) / 86400000);
            dayIndex = diff;
        }

        let blocks = '';
        for (let i = 0; i < schedule.length; i++) {
            let cls = '';
            if (dayIndex >= 0) {
                if (i < dayIndex) cls = 'sch-past';
                else if (i === dayIndex) cls = 'sch-today';
            }
            // 날짜 계산
            let dateLabel = `${i+1}일차`;
            if (startDate) {
                const d = new Date(startDate + 'T00:00:00+09:00');
                d.setDate(d.getDate() + i);
                dateLabel = `${d.getMonth()+1}/${d.getDate()}`;
            }
            blocks += `<span class="sch-block ${cls}"><span class="sch-day">${dateLabel}</span><span class="sch-qty">${schedule[i]}</span></span>`;
        }
        return `<div class="campaign-schedule"><span class="sch-label">모집일정</span><div class="sch-blocks">${blocks}</div></div>`;
    }

    function renderHistory(history, cid) {
        if (!history || history.length === 0) return '';
        const items = history.map(h => {
            const st = h.status;
            let action = '';
            if (h.progress_id) {
                if (['신청','가이드전달','구매캡쳐대기'].includes(st)) {
                    action = `<a href="/task/${h.progress_id}" class="history-action-btn">구매제출</a>`;
                }
            }
            return `<div class="my-history-row">
                <span>${h.id}</span><span class="my-history-status">${st}</span>${action}
            </div>`;
        }).join('');
        return `<div class="campaign-card-my"><div class="campaign-card-my-title">내 진행</div>${items}</div>`;
    }

    loadCampaigns();
})();
</script>
{% endblock %}
