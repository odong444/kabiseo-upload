{% extends "base.html" %}
{% block title %}{{ title }} - 카비서{% endblock %}

{% block content %}
<div class="page-content">
    <h1 class="page-title">{{ title }}</h1>

    {% if items %}
    <p class="page-subtitle">'{{ query }}' 님의 제출 대상 ({{ items|length }}건)</p>

    <!-- Sticky top bar -->
    <div class="upload-sticky" id="uploadStickyBar">
        <div class="sticky-left">
            <span class="sticky-icon">&#128248;</span>
            <span class="sticky-label">사진 등록: <strong id="stickyCount">0</strong>건</span>
        </div>
        <button type="button" class="sticky-submit-btn" id="stickySubmitBtn" disabled onclick="batchUpload()">
            0건 일괄 제출하기
        </button>
    </div>

    <!-- Batch progress overlay -->
    <div class="batch-overlay" id="batchOverlay" style="display:none;">
        <div class="batch-overlay-content">
            <div class="batch-overlay-title" id="overlayTitle">업로드 중...</div>
            <div class="progress-bar-wrap">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            </div>
            <div class="progress-text" id="progressText">준비 중...</div>
        </div>
    </div>

    <!-- Confirmation modal -->
    <div class="confirm-overlay" id="confirmOverlay" style="display:none;">
        <div class="confirm-dialog">
            <p class="confirm-message" id="confirmMessage"></p>
            <div class="confirm-actions">
                <button type="button" class="confirm-btn confirm-btn-submit" id="confirmSubmitBtn" onclick="doUpload()">제출하기</button>
                <button type="button" class="confirm-btn confirm-btn-cancel" onclick="closeConfirm()">취소</button>
            </div>
        </div>
    </div>

    <div class="item-list" id="itemList">
        {% for item in items %}
        {% set remark = item.get('비고', '') %}
        {% set is_rejected = remark.startswith('반려') %}
        <div class="item-card{{ ' rejected' if is_rejected else '' }}" data-row="{{ item['_row_idx'] }}" data-campaign="{{ item.get('캠페인ID', '') }}" id="card-{{ item['_row_idx'] }}">
            <div class="item-info">
                <div class="item-product">{{ item.get('제품명', '') }}</div>
                <div class="item-detail">아이디: {{ item.get('아이디', '') }}</div>
                <div class="item-detail">주문번호: {{ item.get('주문번호', '') or '-' }}</div>
                <div class="item-detail">수취인: {{ item.get('수취인명', '') }} / {{ item.get('연락처', '') }}</div>
                <div class="item-detail">구매일: {{ item.get('구매일', '') or item.get('날짜', '') }}</div>
                {% if is_rejected %}
                <div class="item-reject-notice">&#9888; 반려: {{ remark[3:].strip() if remark|length > 3 else '리뷰 사진을 다시 확인해주세요.' }}</div>
                {% endif %}
            </div>
            <div class="upload-controls">
                <!-- File selection area (not yet selected) -->
                <div class="file-select-area" id="selectArea-{{ item['_row_idx'] }}">
                    <label class="file-select-label">
                        <input type="file" name="capture" accept="image/*" class="file-input"
                            onchange="onFileSelect(this, this.closest('.item-card'))">
                        <span class="file-select-btn">&#128247; 사진 선택</span>
                    </label>
                </div>
                <!-- AI 검수 결과 -->
                <div class="ai-check-area" id="aiCheck-{{ item['_row_idx'] }}" style="display:none;"></div>
                <!-- File selected indicator (hidden by default) -->
                <div class="file-selected-area" id="selectedArea-{{ item['_row_idx'] }}" style="display:none;">
                    <span class="file-selected-info">
                        <span class="file-selected-check">&#9989;</span>
                        <span class="file-selected-text" id="selectedText-{{ item['_row_idx'] }}">1장 등록됨</span>
                    </span>
                    <span class="file-selected-actions">
                        <button type="button" class="file-action-btn file-action-change" onclick="changeFile(this.closest('.item-card'))">변경</button>
                        <button type="button" class="file-action-btn file-action-remove" onclick="removeFile(this.closest('.item-card'))">삭제</button>
                    </span>
                </div>
                <!-- Upload result (shown after submit) -->
                <div class="upload-result" id="result-{{ item['_row_idx'] }}" style="display:none;"></div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <div class="empty-state">
        <p>'{{ query }}' 님 앞으로 제출할 항목이 없어요.</p>
        <p>이름 또는 예금주명을 다시 확인해주세요.</p>
    </div>
    {% endif %}

    <a href="{{ url_for('upload_' + capture_type) }}" class="back-link">&#8592; 다시 검색</a>
</div>

<script>
const CAPTURE_TYPE = "{{ capture_type }}";

/**
 * Handle file selection on an item card + AI 사전검수.
 */
async function onFileSelect(input, cardEl) {
    if (!input.files || !input.files.length) return;

    const row = cardEl.dataset.row;
    const campaignId = cardEl.dataset.campaign || '';
    const selectArea = document.getElementById('selectArea-' + row);
    const selectedArea = document.getElementById('selectedArea-' + row);
    const selectedText = document.getElementById('selectedText-' + row);
    const aiCheck = document.getElementById('aiCheck-' + row);

    // AI 사전검수
    aiCheck.style.display = 'block';
    aiCheck.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:8px;font-size:13px;color:#888;"><div class="reviewer-spinner-sm" style="width:16px;height:16px;border-width:2px;"></div> AI 검수중...</div>';
    selectArea.style.display = 'none';

    const formData = new FormData();
    formData.append('capture', input.files[0]);
    formData.append('capture_type', CAPTURE_TYPE);
    formData.append('campaign_id', campaignId);

    try {
        const resp = await fetch('/api/verify-capture', { method: 'POST', body: formData });
        const result = await resp.json();

        if (result.ok && result.result === '자동반려') {
            aiCheck.innerHTML = '<div class="ai-result ai-reject"><strong>반려</strong><p>' + result.reason + '</p><p class="ai-warn-note">이 캡쳐로는 제출할 수 없습니다. 다시 캡쳐해주세요.</p></div>';
            input.value = '';
            selectArea.style.display = 'block';
            cardEl.classList.add('ai-blocked');
            updateStickyBar();
            return;
        } else if (result.ok && result.result === '확인요청') {
            aiCheck.innerHTML = '<div class="ai-result ai-warn"><strong>담당자 2차검수 필요</strong><p>' + result.reason + '</p><p class="ai-warn-note">제출은 가능하지만, 담당자 확인이 필요합니다.</p></div>';
        } else if (result.ok && result.result === 'AI검수통과') {
            aiCheck.innerHTML = '<div class="ai-result ai-pass">AI 검수 통과</div>';
        } else {
            aiCheck.style.display = 'none';
        }
    } catch(e) {
        aiCheck.style.display = 'none';
    }

    // Show selected state
    const fileName = input.files[0].name;
    selectedText.textContent = '1장 등록됨';
    selectedText.title = fileName;
    selectedArea.style.display = 'flex';
    cardEl.classList.remove('ai-blocked');

    updateStickyBar();
}

/**
 * Trigger a file change (re-select) on a card.
 */
function changeFile(cardEl) {
    const fileInput = cardEl.querySelector('.file-input');
    fileInput.click();
}

/**
 * Remove the selected file from a card.
 */
function removeFile(cardEl) {
    const row = cardEl.dataset.row;
    const fileInput = cardEl.querySelector('.file-input');
    const selectArea = document.getElementById('selectArea-' + row);
    const selectedArea = document.getElementById('selectedArea-' + row);
    const aiCheck = document.getElementById('aiCheck-' + row);

    // Reset the file input
    fileInput.value = '';

    // Show select area, hide selected area and AI result
    selectArea.style.display = 'block';
    selectedArea.style.display = 'none';
    if (aiCheck) { aiCheck.style.display = 'none'; aiCheck.innerHTML = ''; }
    cardEl.classList.remove('ai-blocked');

    updateStickyBar();
}

/**
 * Get all cards that have files selected (and are not already uploaded).
 */
function getSelectedCards() {
    const cards = document.querySelectorAll('.item-card:not(.uploaded):not(.ai-blocked)');
    const selected = [];
    cards.forEach(card => {
        const input = card.querySelector('.file-input');
        if (input && input.files && input.files.length > 0) {
            selected.push(card);
        }
    });
    return selected;
}

/**
 * Update the sticky bar count and button state.
 */
function updateStickyBar() {
    const selected = getSelectedCards();
    const count = selected.length;
    const countEl = document.getElementById('stickyCount');
    const btn = document.getElementById('stickySubmitBtn');

    if (countEl) countEl.textContent = count;

    if (btn) {
        if (count === 0) {
            btn.disabled = true;
            btn.textContent = '0건 일괄 제출하기';
            btn.classList.remove('active');
        } else {
            btn.disabled = false;
            btn.textContent = count + '건 일괄 제출하기';
            btn.classList.add('active');
        }
    }
}

/**
 * Show confirmation dialog before batch upload.
 */
function batchUpload() {
    const cards = getSelectedCards();
    if (cards.length === 0) return;

    const overlay = document.getElementById('confirmOverlay');
    const message = document.getElementById('confirmMessage');
    message.textContent = cards.length + '건의 사진을 제출하시겠어요?';
    overlay.style.display = 'flex';
}

/**
 * Close confirmation dialog.
 */
function closeConfirm() {
    document.getElementById('confirmOverlay').style.display = 'none';
}

/**
 * Execute the actual batch upload after confirmation (병렬 처리, 최대 3개 동시).
 */
async function doUpload() {
    closeConfirm();

    const cards = getSelectedCards();
    if (cards.length === 0) return;

    const total = cards.length;
    let done = 0;
    let success = 0;
    const CONCURRENCY = 1;

    const overlay = document.getElementById('batchOverlay');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const overlayTitle = document.getElementById('overlayTitle');
    const stickyBtn = document.getElementById('stickySubmitBtn');

    overlay.style.display = 'flex';
    overlayTitle.textContent = '업로드 중...';
    progressFill.style.width = '0%';
    progressText.textContent = '0/' + total + ' 업로드중...';
    stickyBtn.disabled = true;
    stickyBtn.textContent = '업로드 중...';

    function updateProgress() {
        progressFill.style.width = ((done / total) * 100) + '%';
        progressText.textContent = done + '/' + total + ' 업로드중...';
    }

    async function uploadOne(card) {
        const row = card.dataset.row;
        const fileInput = card.querySelector('.file-input');
        const resultDiv = document.getElementById('result-' + row);
        const selectArea = document.getElementById('selectArea-' + row);
        const selectedArea = document.getElementById('selectedArea-' + row);

        if (!fileInput.files.length) { done++; updateProgress(); return; }

        card.classList.add('uploading');

        const formData = new FormData();
        formData.append('capture', fileInput.files[0]);
        formData.append('capture_type', CAPTURE_TYPE);
        formData.append('row', row);

        try {
            const resp = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await resp.json();

            if (data.ok) {
                success++;
                selectArea.style.display = 'none';
                selectedArea.style.display = 'none';
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<span class="result-success">&#9989; 제출 완료</span>';
                card.classList.add('uploaded');
            } else {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<span class="result-fail">&#10060; ' + (data.message || '제출 실패') + '</span>';
            }
        } catch (e) {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="result-fail">&#10060; 네트워크 오류</span>';
        }

        card.classList.remove('uploading');
        done++;
        updateProgress();
    }

    // 병렬 업로드 (최대 CONCURRENCY개 동시)
    const queue = [...cards];
    async function worker() {
        while (queue.length > 0) {
            const card = queue.shift();
            await uploadOne(card);
        }
    }
    const workers = [];
    for (let i = 0; i < Math.min(CONCURRENCY, total); i++) {
        workers.push(worker());
    }
    await Promise.all(workers);

    progressFill.style.width = '100%';
    overlayTitle.textContent = '완료!';
    progressText.textContent = '완료! ' + success + '/' + total + '건 제출 성공';

    setTimeout(() => {
        overlay.style.display = 'none';
        updateStickyBar();
    }, 2000);
}

// Initial update
document.addEventListener('DOMContentLoaded', function() {
    updateStickyBar();
});
</script>
{% endblock %}

{% block nav %}
<nav class="bottom-nav">
    <a href="/campaigns" class="nav-item">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">캠페인</span>
    </a>
    <a href="/my" class="nav-item">
        <span class="nav-icon">&#x1f4dd;</span>
        <span class="nav-label">내작업</span>
    </a>
    <a href="/upload" class="nav-item active">
        <span class="nav-icon">&#x1f4f7;</span>
        <span class="nav-label">리뷰제출</span>
    </a>
</nav>
{% endblock %}
