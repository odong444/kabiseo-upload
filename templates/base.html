<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}카비서{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block head %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    {% block header %}
    <header class="app-header">
        <div class="header-inner">
            <a href="/" class="logo">카비서</a>
            {% block header_right %}
            <button class="header-logout-btn" id="headerLogoutBtn" style="display:none;" onclick="if(confirm('로그아웃하시겠습니까?')){localStorage.removeItem('kabiseo_user');localStorage.removeItem('kabiseo_chat_last_read');window.location.href='/';}">로그아웃</button>
            {% endblock %}
        </div>
    </header>
    {% endblock %}

    <main class="app-main">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="flash-messages">
            {% for msg in messages %}
            <div class="flash">{{ msg }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    {% block nav %}{% endblock %}

    <!-- 플로팅 채팅 버튼 + 모달 -->
    <button class="chat-float-btn" id="chatFloatBtn" onclick="toggleChatModal()">
        <span class="chat-float-icon">&#x1f4ac;</span>
        <span class="chat-float-badge" id="chatFloatBadge" style="display:none;"></span>
    </button>
    <div class="chat-modal-overlay" id="chatModalOverlay" style="display:none;" onclick="closeChatModal()">
        <div class="chat-modal" onclick="event.stopPropagation()">
            <div class="chat-modal-header">
                <span class="chat-modal-title">문의</span>
                <button class="chat-modal-close" onclick="closeChatModal()">&times;</button>
            </div>
            <iframe id="chatIframe" class="chat-modal-iframe" src="about:blank"></iframe>
        </div>
    </div>
    <script>
    (function() {
        var saved = localStorage.getItem('kabiseo_user');
        var logoutBtn = document.getElementById('headerLogoutBtn');
        if (!saved) {
            var btn = document.getElementById('chatFloatBtn');
            if (btn) btn.style.display = 'none';
            return;
        }
        if (logoutBtn) logoutBtn.style.display = '';

        // 읽지 않은 메시지 확인
        var chatUnread = 0;
        var badge = document.getElementById('chatFloatBadge');

        function updateBadge() {
            if (chatUnread > 0) {
                badge.textContent = chatUnread > 99 ? '99+' : chatUnread;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // 페이지 로드 시 unread 체크
        try {
            var user = JSON.parse(saved);
            var lastRead = localStorage.getItem('kabiseo_chat_last_read') || '0';
            fetch('/api/chat/unread?name=' + encodeURIComponent(user.name) + '&phone=' + encodeURIComponent(user.phone) + '&last_read=' + lastRead)
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    chatUnread = d.count || 0;
                    updateBadge();
                })
                .catch(function() {});
        } catch(e) {}

        // iframe에서 새 메시지 알림 수신
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'kabiseo_chat_msg') {
                var overlay = document.getElementById('chatModalOverlay');
                if (overlay.style.display === 'none') {
                    chatUnread++;
                    updateBadge();
                }
            }
        });

        // 모달 열기/닫기
        window.toggleChatModal = function() {
            var overlay = document.getElementById('chatModalOverlay');
            var iframe = document.getElementById('chatIframe');
            if (overlay.style.display === 'none') {
                overlay.style.display = 'flex';
                if (iframe.src === 'about:blank') {
                    iframe.src = '/chat?embed=1';
                }
                document.body.style.overflow = 'hidden';
                // 뱃지 클리어 + last_read 갱신
                chatUnread = 0;
                updateBadge();
                localStorage.setItem('kabiseo_chat_last_read', String(Date.now() / 1000));
            } else {
                window.closeChatModal();
            }
        };
        window.closeChatModal = function() {
            document.getElementById('chatModalOverlay').style.display = 'none';
            document.body.style.overflow = '';
            // 닫을 때도 last_read 갱신
            localStorage.setItem('kabiseo_chat_last_read', String(Date.now() / 1000));
        };
    })();
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
