<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}카비서{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block head %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    {% block header %}
    <header class="app-header">
        <div class="header-inner">
            <a href="/" class="logo">카비서</a>
            {% block header_right %}
            <button class="header-logout-btn" id="headerLogoutBtn" style="display:none;" onclick="if(confirm('로그아웃하시겠습니까?')){localStorage.removeItem('kabiseo_user');localStorage.removeItem('kabiseo_chat_last_read');window.location.href='/';}">로그아웃</button>
            {% endblock %}
        </div>
    </header>
    {% endblock %}

    <!-- 채팅 안내 상단 배너 -->
    <div class="chat-top-banner" id="chatTopBanner" style="display:none;" onclick="toggleChatModal()">
        <span class="chat-top-text">&#x1f4ac; 수정/문의는 채팅으로 바로 해결!</span>
        <button class="chat-top-close" onclick="event.stopPropagation();closeChatBanner()">&times;</button>
    </div>

    <!-- 공지 팝업 -->
    <div id="noticeOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1100;justify-content:center;align-items:center;">
        <div style="background:#fff;border-radius:16px;padding:28px 24px 20px;max-width:360px;width:85%;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,0.2);animation:noticePopIn 0.25s ease-out;">
            <div style="font-size:22px;margin-bottom:10px;">&#x1f4e2;</div>
            <div id="noticeBannerTitle" style="font-size:16px;font-weight:700;color:#1e293b;margin-bottom:8px;"></div>
            <div id="noticeBannerContent" style="font-size:14px;color:#4b5563;line-height:1.6;white-space:pre-line;margin-bottom:20px;"></div>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button onclick="dismissNotice('once')" style="background:#f3f4f6;color:#4b5563;border:none;border-radius:10px;padding:10px 20px;font-size:13px;font-weight:600;cursor:pointer;">한번만 보기</button>
                <button onclick="dismissNotice('forever')" style="background:#3b82f6;color:#fff;border:none;border-radius:10px;padding:10px 20px;font-size:13px;font-weight:600;cursor:pointer;">다시 보지 않기</button>
            </div>
        </div>
    </div>
    <style>
    @keyframes noticePopIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>

    <main class="app-main">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="flash-messages">
            {% for msg in messages %}
            <div class="flash">{{ msg }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    {% block nav %}{% endblock %}

    <!-- 채팅 안내 말풍선 -->
    <div class="chat-tooltip" id="chatTooltip" style="display:none;" onclick="this.style.display='none';localStorage.setItem('kabiseo_chat_tooltip_seen','1');">
        수정/문의 채팅으로 바로 해결!
    </div>
    <style>
    .chat-tooltip {
        position: fixed; bottom: 130px; right: 24px; z-index: 999;
        background: #1e40af; color: #fff; padding: 8px 14px; border-radius: 8px;
        font-size: 13px; font-weight: 600; cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        animation: tooltipFadeIn 0.3s ease;
    }
    .chat-tooltip::after {
        content: ''; position: absolute; bottom: -6px; right: 20px;
        width: 0; height: 0;
        border-left: 6px solid transparent; border-right: 6px solid transparent;
        border-top: 6px solid #1e40af;
    }
    @keyframes tooltipFadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .chat-top-banner {
        position: sticky; top: 0; z-index: 900;
        display: flex; align-items: center; justify-content: center;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: #fff; padding: 10px 40px 10px 16px;
        font-size: 14px; font-weight: 600; cursor: pointer;
        animation: bannerSlideDown 0.3s ease;
    }
    .chat-top-banner:active { background: linear-gradient(135deg, #1e3a8a, #2563eb); }
    .chat-top-text { text-align: center; }
    .chat-top-close {
        position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
        background: none; border: none; color: rgba(255,255,255,0.7);
        font-size: 20px; cursor: pointer; padding: 4px 8px; line-height: 1;
    }
    .chat-top-close:hover { color: #fff; }
    @keyframes bannerSlideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    </style>

    <!-- 플로팅 채팅 버튼 + 모달 -->
    <button class="chat-float-btn" id="chatFloatBtn" onclick="toggleChatModal()">
        <span class="chat-float-icon">&#x1f4ac;</span>
        <span class="chat-float-badge" id="chatFloatBadge" style="display:none;"></span>
    </button>
    <div class="chat-modal-overlay" id="chatModalOverlay" style="display:none;" onclick="closeChatModal()">
        <div class="chat-modal" onclick="event.stopPropagation()">
            <div class="chat-modal-header">
                <span class="chat-modal-title">문의</span>
                <button class="chat-modal-close" onclick="closeChatModal()">&times;</button>
            </div>
            <iframe id="chatIframe" class="chat-modal-iframe" src="about:blank"></iframe>
        </div>
    </div>
    <script>
    (function() {
        var saved = localStorage.getItem('kabiseo_user');
        var logoutBtn = document.getElementById('headerLogoutBtn');
        if (!saved) {
            var btn = document.getElementById('chatFloatBtn');
            if (btn) btn.style.display = 'none';
            return;
        }
        if (logoutBtn) logoutBtn.style.display = '';

        // 상단 채팅 안내 배너 (닫아도 3분 후 다시 표시)
        var banner = document.getElementById('chatTopBanner');
        var bannerHideUntil = parseInt(localStorage.getItem('kabiseo_chat_banner_hide') || '0');
        if (banner) {
            if (Date.now() > bannerHideUntil) {
                banner.style.display = 'flex';
            } else {
                // 남은 시간 후 다시 표시
                setTimeout(function() { banner.style.display = 'flex'; }, bannerHideUntil - Date.now());
            }
        }
        window.closeChatBanner = function() {
            var b = document.getElementById('chatTopBanner');
            if (b) b.style.display = 'none';
            localStorage.setItem('kabiseo_chat_banner_hide', String(Date.now() + 180000)); // 3분
        };

        // 채팅 안내 말풍선 (첫 방문 시)
        if (!localStorage.getItem('kabiseo_chat_tooltip_seen')) {
            var tooltip = document.getElementById('chatTooltip');
            if (tooltip) {
                tooltip.style.display = 'block';
                setTimeout(function() {
                    if (tooltip.style.display !== 'none') {
                        tooltip.style.opacity = '0';
                        tooltip.style.transition = 'opacity 0.5s';
                        setTimeout(function() { tooltip.style.display = 'none'; }, 500);
                        localStorage.setItem('kabiseo_chat_tooltip_seen', '1');
                    }
                }, 5000);
            }
        }

        // 읽지 않은 메시지 확인
        var chatUnread = 0;
        var badge = document.getElementById('chatFloatBadge');

        function updateBadge() {
            if (chatUnread > 0) {
                badge.textContent = chatUnread > 99 ? '99+' : chatUnread;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // 페이지 로드 시 unread 체크 + 공지 로드
        try {
            var user = JSON.parse(saved);
            var lastRead = localStorage.getItem('kabiseo_chat_last_read') || '0';
            fetch('/api/chat/unread?name=' + encodeURIComponent(user.name) + '&phone=' + encodeURIComponent(user.phone) + '&last_read=' + lastRead)
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    chatUnread = d.count || 0;
                    updateBadge();
                })
                .catch(function() {});

            // 공지 배너 로드
            fetch('/api/notices/active?name=' + encodeURIComponent(user.name) + '&phone=' + encodeURIComponent(user.phone))
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (!d.notices || !d.notices.length) return;
                    var dismissed = JSON.parse(localStorage.getItem('kabiseo_dismissed_notices') || '{}');
                    var notice = null;
                    for (var i = 0; i < d.notices.length; i++) {
                        var nid = d.notices[i].id;
                        if (!dismissed[nid] && !window._noticeSessionDismissed[nid]) { notice = d.notices[i]; break; }
                    }
                    if (!notice) return;
                    document.getElementById('noticeBannerTitle').textContent = notice.title;
                    document.getElementById('noticeBannerContent').textContent = notice.content || '';
                    var nb = document.getElementById('noticeOverlay');
                    nb.dataset.noticeId = notice.id;
                    nb.style.display = 'flex';
                })
                .catch(function() {});
        } catch(e) {}

        window._noticeSessionDismissed = {};
        window.dismissNotice = function(mode) {
            var nb = document.getElementById('noticeOverlay');
            var nid = nb.dataset.noticeId;
            if (nid && mode === 'forever') {
                var dismissed = JSON.parse(localStorage.getItem('kabiseo_dismissed_notices') || '{}');
                dismissed[nid] = Date.now();
                localStorage.setItem('kabiseo_dismissed_notices', JSON.stringify(dismissed));
            } else if (nid) {
                window._noticeSessionDismissed[nid] = true;
            }
            nb.style.display = 'none';
        };

        // iframe에서 새 메시지 알림 수신
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'kabiseo_chat_msg') {
                var overlay = document.getElementById('chatModalOverlay');
                if (overlay.style.display === 'none') {
                    chatUnread++;
                    updateBadge();
                }
            }
        });

        // 모달 열기/닫기
        window.toggleChatModal = function() {
            var overlay = document.getElementById('chatModalOverlay');
            var iframe = document.getElementById('chatIframe');
            if (overlay.style.display === 'none') {
                overlay.style.display = 'flex';
                if (iframe.src === 'about:blank') {
                    iframe.src = '/chat?embed=1';
                }
                document.body.style.overflow = 'hidden';
                // 뱃지 클리어 + last_read 갱신 (+10초 버퍼로 동시 메시지 누락 방지)
                chatUnread = 0;
                updateBadge();
                localStorage.setItem('kabiseo_chat_last_read', String(Date.now() / 1000 + 10));
            } else {
                window.closeChatModal();
            }
        };
        window.closeChatModal = function() {
            document.getElementById('chatModalOverlay').style.display = 'none';
            document.body.style.overflow = '';
            // 닫을 때 last_read 갱신 (+10초 버퍼)
            localStorage.setItem('kabiseo_chat_last_read', String(Date.now() / 1000 + 10));
        };
    })();
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
