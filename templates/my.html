{% extends "base.html" %}
{% block title %}내 작업 - 카비서{% endblock %}
{% block head %}
<script src="{{ url_for('static', filename='js/reviewer.js') }}"></script>
{% endblock %}

{% block content %}
<div class="page-content">
    <h1 class="page-title">내 작업</h1>
    <div id="myItems" class="loading">불러오는 중...</div>
</div>

<!-- 리뷰 가이드 모달 -->
<div id="guideModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1100;justify-content:center;align-items:center;" onclick="closeGuideModal()">
    <div style="background:#fff;border-radius:16px;padding:0;max-width:420px;width:90%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 12px 40px rgba(0,0,0,0.2);animation:guidePopIn 0.2s ease-out;" onclick="event.stopPropagation()">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e5e7eb;">
            <span style="font-size:16px;font-weight:700;color:#1e293b;">리뷰 가이드</span>
            <button onclick="closeGuideModal()" style="background:none;border:none;font-size:22px;color:#9ca3af;cursor:pointer;padding:0 4px;line-height:1;">&times;</button>
        </div>
        <div id="guideModalBody" style="padding:20px;overflow-y:auto;flex:1;"></div>
    </div>
</div>
<style>
@keyframes guidePopIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
{% endblock %}

{% block nav %}
<nav class="bottom-nav">
    <a href="/campaigns" class="nav-item">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">캠페인</span>
    </a>
    <a href="/my" class="nav-item active">
        <span class="nav-icon">&#x1f4dd;</span>
        <span class="nav-label">내작업</span>
    </a>
    <a href="/upload" class="nav-item">
        <span class="nav-icon">&#x1f4f7;</span>
        <span class="nav-label">리뷰제출</span>
    </a>
</nav>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const user = Reviewer.requireLogin();
    if (!user) return;

    async function load() {
        const data = await Reviewer.apiGet('/api/my');
        const container = document.getElementById('myItems');

        if (!data.items || data.items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>진행 중인 작업이 없습니다.</p>
                    <a href="/campaigns" class="btn btn-primary" style="margin-top:12px">캠페인 보기</a>
                </div>
            `;
            return;
        }

        // 캠페인별 그룹화
        const groups = {};
        for (const item of data.items) {
            const key = item.campaign_id || item.id;
            if (!groups[key]) groups[key] = [];
            groups[key].push(item);
        }

        const inProgress = [];
        const completed = [];

        for (const [cid, items] of Object.entries(groups)) {
            const allDone = items.every(i => i.status === '입금완료');
            if (allDone) {
                completed.push(items);
            } else {
                inProgress.push(items);
            }
        }

        let html = '';

        if (inProgress.length > 0) {
            html += '<h2 class="section-title">진행중</h2>';
            for (const group of inProgress) {
                html += renderGroup(group);
            }
        }

        if (completed.length > 0) {
            html += '<h2 class="section-title">완료</h2>';
            for (const group of completed) {
                html += renderGroup(group, true);
            }
        }

        container.innerHTML = html;
    }

    // 리뷰 가이드 모달
    window.showReviewGuide = async function(progressId) {
        const modal = document.getElementById('guideModal');
        const body = document.getElementById('guideModalBody');
        body.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">불러오는 중...</div>';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        try {
            const data = await Reviewer.apiGet('/api/task/' + progressId);
            const c = data.campaign || {};
            let html = '';
            if (c.campaign_guide) {
                html += '<div style="line-height:1.7;white-space:pre-line;font-size:14px;color:#374151;">' + c.campaign_guide.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
            }
            if (c.extra_info) {
                html += '<div style="margin-top:16px;padding:12px;background:#fef3c7;border-radius:8px;font-size:13px;color:#92400e;white-space:pre-line;"><strong>추가 안내사항</strong><br>' + c.extra_info.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
            }
            if (!html) {
                html = '<div style="text-align:center;color:#9ca3af;padding:20px;">등록된 리뷰 가이드가 없습니다.</div>';
            }
            body.innerHTML = html;
        } catch(e) {
            body.innerHTML = '<div style="text-align:center;color:#ef4444;padding:20px;">가이드를 불러올 수 없습니다.</div>';
        }
    };
    window.closeGuideModal = function() {
        document.getElementById('guideModal').style.display = 'none';
        document.body.style.overflow = '';
    };

    function renderGroup(items, done = false) {
        const first = items[0];
        const hasRejected = items.some(i => i.remark && i.remark.startsWith('반려'));

        // 아이디별 상태 행
        let idsHtml = '';
        for (const item of items) {
            let actionBtn = '';
            switch (item.status) {
                case '신청':
                case '가이드전달':
                    actionBtn = `<a href="/task/${item.id}" class="btn btn-primary btn-xs">제출</a><button class="btn btn-danger btn-xs" style="margin-left:4px" onclick="cancelApply(${item.id})">취소</button>`;
                    break;
                case '구매캡쳐대기':
                    actionBtn = `<a href="/task/${item.id}" class="btn btn-primary btn-xs">제출</a>`;
                    break;
                case '리뷰대기':
                    actionBtn = '<span class="my-status-text-sm">리뷰대기</span>';
                    break;
                case '리뷰제출':
                    actionBtn = '<span class="my-status-text-sm">검수중</span>';
                    break;
                case '입금대기':
                    actionBtn = '<span class="my-status-text-sm">입금대기</span>';
                    break;
                case '입금완료':
                    actionBtn = '<span class="my-status-text-sm done">완료</span>';
                    break;
            }
            const remarkHtml = item.remark && item.remark.startsWith('반려')
                ? `<span class="id-remark">${item.remark}</span>` : '';

            idsHtml += `
                <div class="id-row">
                    <span class="id-name">${item.store_id}</span>
                    ${Reviewer.statusBadge(item.status)}
                    ${remarkHtml}
                    <span class="id-action">${actionBtn}</span>
                </div>`;
        }

        // 가이드 보기 버튼 (한 번만)
        const needsGuide = items.some(i => ['신청', '가이드전달', '구매캡쳐대기'].includes(i.status));
        const needsReviewGuide = items.some(i => ['리뷰대기', '리뷰제출'].includes(i.status));
        const canCancel = items.every(i => ['신청', '가이드전달'].includes(i.status));
        let actionBtns = '';
        if (needsGuide) {
            actionBtns += `<a href="/task/${first.id}" class="btn btn-primary btn-sm" style="flex:1">가이드 보기</a>`;
        }
        if (needsReviewGuide) {
            actionBtns += `<button class="btn btn-sm" style="flex:1;background:#dbeafe;color:#1d4ed8;border:1px solid #93c5fd;font-weight:600;" onclick="showReviewGuide(${first.id})">리뷰 가이드</button>`;
        }
        if (canCancel) {
            actionBtns += `<button class="btn btn-sm" style="flex:0 0 auto;margin-left:8px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;" onclick="cancelApply(${first.id})">신청취소</button>`;
        }

        return `
            <div class="status-card ${done ? 'completed' : ''} ${hasRejected ? 'rejected' : ''}">
                <div class="status-card-header">
                    <span class="product-name">${first.product_name}</span>
                </div>
                <div class="status-card-body">
                    <div class="info-row"><span class="label">업체</span><span>${first.store_name || ''}</span></div>
                    <div class="info-row"><span class="label">날짜</span><span>${first.date}</span></div>
                    ${first.review_fee ? `<div class="info-row"><span class="label">리뷰비</span><span>${Reviewer.formatNumber(first.review_fee)}원</span></div>` : ''}
                    <div class="id-list-section">
                        <span class="label">아이디 (${items.length})</span>
                        ${idsHtml}
                    </div>
                </div>
                <div class="my-item-action" style="display:flex;gap:0">${actionBtns}</div>
            </div>
        `;
    }

    window.cancelApply = async function(progressId) {
        if (!confirm('신청을 취소하시겠습니까?')) return;
        try {
            const res = await fetch('/api/task/' + progressId + '/cancel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: user.name, phone: user.phone})
            });
            const d = await res.json();
            if (d.ok) {
                alert('취소되었습니다.');
                load();
            } else {
                alert(d.error || '취소 실패');
            }
        } catch(e) {
            alert('취소 중 오류가 발생했습니다.');
        }
    };

    load();
})();
</script>
{% endblock %}
