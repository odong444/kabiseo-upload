{% extends "base.html" %}
{% block title %}내 작업 - 카비서{% endblock %}
{% block head %}
<script src="{{ url_for('static', filename='js/reviewer.js') }}"></script>
{% endblock %}

{% block content %}
<div class="page-content">
    <h1 class="page-title">내 작업</h1>
    <div id="myItems" class="loading">불러오는 중...</div>
</div>
{% endblock %}

{% block nav %}
<nav class="bottom-nav">
    <a href="/campaigns" class="nav-item">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">캠페인</span>
    </a>
    <a href="/my" class="nav-item active">
        <span class="nav-icon">&#x1f4dd;</span>
        <span class="nav-label">내작업</span>
    </a>
    <a href="/upload" class="nav-item">
        <span class="nav-icon">&#x1f4f7;</span>
        <span class="nav-label">리뷰제출</span>
    </a>
    <a href="/chat" class="nav-item">
        <span class="nav-icon">&#x1f4ac;</span>
        <span class="nav-label">문의</span>
    </a>
</nav>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const user = Reviewer.requireLogin();
    if (!user) return;

    async function load() {
        const data = await Reviewer.apiGet('/api/my');
        const container = document.getElementById('myItems');

        if (!data.items || data.items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>진행 중인 작업이 없습니다.</p>
                    <a href="/campaigns" class="btn btn-primary" style="margin-top:12px">캠페인 보기</a>
                </div>
            `;
            return;
        }

        // 캠페인별 그룹화
        const groups = {};
        for (const item of data.items) {
            const key = item.campaign_id || item.id;
            if (!groups[key]) groups[key] = [];
            groups[key].push(item);
        }

        const inProgress = [];
        const completed = [];

        for (const [cid, items] of Object.entries(groups)) {
            const allDone = items.every(i => i.status === '입금완료');
            if (allDone) {
                completed.push(items);
            } else {
                inProgress.push(items);
            }
        }

        let html = '';

        if (inProgress.length > 0) {
            html += '<h2 class="section-title">진행중</h2>';
            for (const group of inProgress) {
                html += renderGroup(group);
            }
        }

        if (completed.length > 0) {
            html += '<h2 class="section-title">완료</h2>';
            for (const group of completed) {
                html += renderGroup(group, true);
            }
        }

        container.innerHTML = html;
    }

    function renderGroup(items, done = false) {
        const first = items[0];
        const hasRejected = items.some(i => i.remark && i.remark.startsWith('반려'));

        // 아이디별 상태 행
        let idsHtml = '';
        for (const item of items) {
            let actionBtn = '';
            switch (item.status) {
                case '신청':
                case '가이드전달':
                case '구매캡쳐대기':
                    actionBtn = `<a href="/task/${item.id}" class="btn btn-primary btn-xs">제출</a>`;
                    break;
                case '리뷰대기':
                    actionBtn = '<span class="my-status-text-sm">리뷰대기</span>';
                    break;
                case '리뷰제출':
                    actionBtn = '<span class="my-status-text-sm">검수중</span>';
                    break;
                case '입금대기':
                    actionBtn = '<span class="my-status-text-sm">입금대기</span>';
                    break;
                case '입금완료':
                    actionBtn = '<span class="my-status-text-sm done">완료</span>';
                    break;
            }
            const remarkHtml = item.remark && item.remark.startsWith('반려')
                ? `<span class="id-remark">${item.remark}</span>` : '';

            idsHtml += `
                <div class="id-row">
                    <span class="id-name">${item.store_id}</span>
                    ${Reviewer.statusBadge(item.status)}
                    ${remarkHtml}
                    <span class="id-action">${actionBtn}</span>
                </div>`;
        }

        // 가이드 보기 버튼 (한 번만)
        const needsGuide = items.some(i => ['신청', '가이드전달', '구매캡쳐대기'].includes(i.status));
        const guideBtn = needsGuide
            ? `<a href="/task/${first.id}" class="btn btn-primary btn-sm" style="width:100%">가이드 보기</a>`
            : '';

        return `
            <div class="status-card ${done ? 'completed' : ''} ${hasRejected ? 'rejected' : ''}">
                <div class="status-card-header">
                    <span class="product-name">${first.product_name}</span>
                </div>
                <div class="status-card-body">
                    <div class="info-row"><span class="label">업체</span><span>${first.store_name || ''}</span></div>
                    <div class="info-row"><span class="label">날짜</span><span>${first.date}</span></div>
                    ${first.review_fee ? `<div class="info-row"><span class="label">리뷰비</span><span>${Reviewer.formatNumber(first.review_fee)}원</span></div>` : ''}
                    <div class="id-list-section">
                        <span class="label">아이디 (${items.length})</span>
                        ${idsHtml}
                    </div>
                </div>
                <div class="my-item-action">${guideBtn}</div>
            </div>
        `;
    }

    load();
})();
</script>
{% endblock %}
