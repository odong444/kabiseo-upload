{% extends "base.html" %}
{% block title %}카비서 - 진행현황{% endblock %}

{% block content %}
<div class="page-content">
    <h1 class="page-title">내 진행현황</h1>

    <div id="statusLoading" class="loading">불러오는 중...</div>
    <div id="statusContent" style="display:none;">
        <div id="inProgressSection"></div>
        <div id="completedSection"></div>
        <div id="emptyState" class="empty-state" style="display:none;">
            <p>진행 중인 체험단이 없습니다.</p>
            <a href="/campaigns" class="btn btn-primary">캠페인 보기</a>
        </div>
    </div>
</div>

<script>
(function() {
    const saved = localStorage.getItem('kabiseo_user');
    if (!saved) { window.location.href = '/'; return; }
    const user = JSON.parse(saved);

    const statusEmoji = {
        '가이드전달': '<span class="status-dot yellow"></span>',
        '양식접수': '<span class="status-dot blue"></span>',
        '리뷰대기': '<span class="status-dot orange"></span>',
        '리뷰완료': '<span class="status-dot green"></span>',
        '정산완료': '<span class="status-dot done"></span>',
        '취소': '<span class="status-dot cancel"></span>'
    };

    fetch(`/api/status?name=${encodeURIComponent(user.name)}&phone=${encodeURIComponent(user.phone)}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('statusLoading').style.display = 'none';
            document.getElementById('statusContent').style.display = 'block';

            const ip = data.in_progress || [];
            const cp = data.completed || [];

            if (ip.length === 0 && cp.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            if (ip.length > 0) {
                let html = '<h2 class="section-title">진행중</h2>';
                ip.forEach(item => {
                    const dot = statusEmoji[item['상태']] || '';
                    const remark = item['비고'] || '';
                    const isRejected = remark.startsWith('반려');
                    const rejectReason = isRejected ? remark.replace(/^반려[:：]?\s*/, '') : '';
                    html += `<div class="status-card${isRejected ? ' rejected' : ''}">
                        <div class="status-card-header">
                            <span class="product-name">${item['제품명'] || ''}</span>
                            <span class="status-badge">${isRejected ? '<span class="status-dot cancel"></span> 반려' : dot + ' ' + (item['상태'] || '')}</span>
                        </div>
                        <div class="status-card-body">
                            <div class="info-row"><span class="label">아이디</span><span>${item['아이디'] || ''}</span></div>
                            ${item['구매일'] ? `<div class="info-row"><span class="label">구매일</span><span>${item['구매일']}</span></div>` : ''}
                            ${item['리뷰기한'] ? `<div class="info-row"><span class="label">리뷰기한</span><span>${item['리뷰기한']}</span></div>` : ''}
                            ${isRejected ? `<div class="info-row reject-notice"><span class="label">반려 사유</span><span>${rejectReason || '리뷰 사진을 다시 확인해주세요.'}</span></div>` : ''}
                        </div>
                        ${isRejected ? `<a href="/upload" class="btn btn-primary btn-sm">리뷰 다시 제출하기</a>` :
                          (item['상태'] === '양식접수' || item['상태'] === '리뷰대기' || item['상태'] === '구매내역제출') ?
                            `<a href="/upload" class="btn btn-primary btn-sm">사진 제출하기</a>` : ''}
                    </div>`;
                });
                document.getElementById('inProgressSection').innerHTML = html;
            }

            if (cp.length > 0) {
                let html = '<h2 class="section-title">완료</h2>';
                cp.forEach(item => {
                    html += `<div class="status-card completed">
                        <div class="status-card-header">
                            <span class="product-name">${item['제품명'] || ''}</span>
                            <span class="status-badge"><span class="status-dot done"></span> ${item['상태'] || ''}</span>
                        </div>
                        <div class="status-card-body">
                            <div class="info-row"><span class="label">아이디</span><span>${item['아이디'] || ''}</span></div>
                            ${item['입금액'] ? `<div class="info-row"><span class="label">입금액</span><span>${Number(item['입금금액']).toLocaleString()}원</span></div>` : ''}
                        </div>
                    </div>`;
                });
                document.getElementById('completedSection').innerHTML = html;
            }
        })
        .catch(err => {
            document.getElementById('statusLoading').textContent = '불러오기 실패. 새로고침 해주세요.';
        });
})();
</script>
{% endblock %}

{% block nav %}
<nav class="bottom-nav">
    <a href="/campaigns" class="nav-item">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">캠페인</span>
    </a>
    <a href="/my" class="nav-item">
        <span class="nav-icon">&#x1f4dd;</span>
        <span class="nav-label">내작업</span>
    </a>
    <a href="/upload" class="nav-item">
        <span class="nav-icon">&#x1f4f7;</span>
        <span class="nav-label">리뷰제출</span>
    </a>
</nav>
{% endblock %}
