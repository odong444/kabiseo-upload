{% extends "base.html" %}
{% block title %}구매 가이드 - 카비서{% endblock %}
{% block head %}
<script src="{{ url_for('static', filename='js/reviewer.js') }}"></script>
<style>
.id-tabs { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
.id-tab {
    padding: 6px 14px; border: 1px solid #ddd; border-radius: 20px;
    font-size: 13px; cursor: pointer; background: #fff; color: #555;
}
.id-tab.active { background: #fee500; border-color: #e6cf00; font-weight: 700; color: #3c1e1e; }
.id-tab.done { background: #e8f5e9; border-color: #a5d6a7; color: #2e7d32; }
.id-form-panel { display: none; }
.id-form-panel.active { display: block; }
.id-status-bar {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 12px; background: #f5f5f5; border-radius: 8px; margin-bottom: 12px;
    font-size: 13px;
}
.id-status-bar .sid { font-weight: 700; }
.bank-presets { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.bank-preset-btn {
    padding: 6px 12px; border: 1px solid #ddd; border-radius: 8px;
    font-size: 12px; cursor: pointer; background: #fff; color: #333;
    line-height: 1.4; text-align: left;
}
.bank-preset-btn:hover { border-color: #fee500; background: #fffde7; }
.bank-preset-btn .bp-bank { font-weight: 700; }
.bank-preset-btn .bp-account { color: #666; }
.photo-set-gallery { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
.photo-set-item { flex: 0 0 auto; }
.photo-set-item img {
    width: 120px; height: 120px; object-fit: cover;
    border-radius: 8px; border: 1px solid #ddd; cursor: pointer;
}
.photo-set-item img:hover { border-color: #fee500; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

/* 라이트박스 */
.lightbox-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9); z-index: 9999;
    justify-content: center; align-items: center;
    cursor: zoom-out; -webkit-tap-highlight-color: transparent;
}
.lightbox-overlay.open { display: flex; }
.lightbox-img-wrap {
    position: relative; overflow: hidden;
    width: 95vw; height: 90vh;
    display: flex; justify-content: center; align-items: center;
    touch-action: none;
}
.lightbox-overlay img {
    max-width: 100%; max-height: 100%; object-fit: contain;
    border-radius: 8px; user-select: none; -webkit-user-select: none;
    transform-origin: 0 0; transition: none; will-change: transform;
}
.lightbox-zoom-controls {
    position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 8px; z-index: 10000;
}
.lightbox-zoom-btn {
    width: 40px; height: 40px; border-radius: 50%; border: none;
    background: rgba(255,255,255,0.25); color: #fff; font-size: 22px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    line-height: 1;
}
.lightbox-zoom-btn:hover { background: rgba(255,255,255,0.4); }
.lightbox-zoom-level {
    color: #fff; font-size: 13px; display: flex; align-items: center;
    background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 12px;
}
.lightbox-close {
    position: fixed; top: 12px; right: 16px;
    color: #fff; font-size: 32px; cursor: pointer; z-index: 10000;
    background: none; border: none; line-height: 1;
}
.lightbox-nav {
    position: fixed; top: 50%; transform: translateY(-50%);
    color: #fff; font-size: 36px; cursor: pointer; z-index: 10000;
    background: rgba(255,255,255,0.15); border: none; border-radius: 50%;
    width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
}
.lightbox-nav:hover { background: rgba(255,255,255,0.3); }
.lightbox-nav.prev { left: 12px; }
.lightbox-nav.next { right: 12px; }
.lightbox-counter {
    position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
    color: #fff; font-size: 14px; z-index: 10000; background: rgba(0,0,0,0.5);
    padding: 4px 12px; border-radius: 12px;
}
.detail-image img { cursor: zoom-in; }
</style>
{% endblock %}

{% block content %}
<div class="page-content">
    <div id="taskContainer" class="loading">불러오는 중...</div>
</div>
{% endblock %}

{% block nav %}
<nav class="bottom-nav">
    <a href="/campaigns" class="nav-item">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">캠페인</span>
    </a>
    <a href="/my" class="nav-item">
        <span class="nav-icon">&#x1f4dd;</span>
        <span class="nav-label">내작업</span>
    </a>
    <a href="/upload" class="nav-item">
        <span class="nav-icon">&#x1f4f7;</span>
        <span class="nav-label">리뷰제출</span>
    </a>
</nav>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const progressId = {{ progress_id }};
    const user = Reviewer.requireLogin();
    if (!user) return;

    let taskData = null;
    let selectedFiles = {}; // per sibling id

    function driveToThumb(url) {
        if (!url) return url;
        var m = url.match(/\/file\/d\/([^\/]+)/);
        if (m) return 'https://drive.google.com/thumbnail?id=' + m[1] + '&sz=w400';
        return url;
    }

    function driveToFull(url) {
        if (!url) return url;
        var m = url.match(/\/file\/d\/([^\/]+)/);
        if (m) return 'https://drive.google.com/thumbnail?id=' + m[1] + '&sz=w1200';
        return url;
    }

    // ── 라이트박스 (줌 지원) ──
    var _lbImages = [];
    var _lbIndex = 0;
    var _lbScale = 1;
    var _lbPanX = 0, _lbPanY = 0;
    var _lbDragging = false;
    var _lbDragStart = {x:0, y:0, panX:0, panY:0};
    var _lbPinchDist = 0;
    var _lbLastTap = 0;

    function _lbClamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

    function _lbApplyTransform() {
        var img = document.getElementById('lightboxImg');
        if (!img) return;
        if (_lbScale <= 1) { _lbPanX = 0; _lbPanY = 0; }
        img.style.transform = 'translate(' + _lbPanX + 'px,' + _lbPanY + 'px) scale(' + _lbScale + ')';
        img.style.transformOrigin = 'center center';
        var lvl = document.getElementById('lightboxZoomLevel');
        if (lvl) lvl.textContent = Math.round(_lbScale * 100) + '%';
        // 줌 상태일 때 nav/스와이프 숨김
        var isZoomed = _lbScale > 1.05;
        document.querySelectorAll('.lightbox-nav').forEach(function(b) { b.style.display = isZoomed ? 'none' : (_lbImages.length > 1 ? '' : 'none'); });
    }

    function _lbResetZoom() {
        _lbScale = 1; _lbPanX = 0; _lbPanY = 0;
        _lbApplyTransform();
    }

    function _lbZoomTo(newScale, cx, cy) {
        var wrap = document.getElementById('lightboxImgWrap');
        if (!wrap) return;
        newScale = _lbClamp(newScale, 1, 5);
        if (cx !== undefined && cy !== undefined) {
            var rect = wrap.getBoundingClientRect();
            var ox = cx - rect.left - rect.width / 2;
            var oy = cy - rect.top - rect.height / 2;
            _lbPanX = _lbPanX - ox * (newScale / _lbScale - 1);
            _lbPanY = _lbPanY - oy * (newScale / _lbScale - 1);
        }
        _lbScale = newScale;
        if (_lbScale <= 1) { _lbPanX = 0; _lbPanY = 0; }
        _lbApplyTransform();
    }

    window.openLightbox = function(images, startIndex) {
        _lbImages = images;
        _lbIndex = startIndex || 0;
        var overlay = document.getElementById('lightboxOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'lightboxOverlay';
            overlay.className = 'lightbox-overlay';
            overlay.innerHTML = '<button class="lightbox-close">&times;</button>'
                + '<button class="lightbox-nav prev">&#8249;</button>'
                + '<div class="lightbox-img-wrap" id="lightboxImgWrap"><img id="lightboxImg" src="" alt=""></div>'
                + '<button class="lightbox-nav next">&#8250;</button>'
                + '<div class="lightbox-zoom-controls">'
                +   '<button class="lightbox-zoom-btn" id="lbZoomOut">&#8722;</button>'
                +   '<div class="lightbox-zoom-level" id="lightboxZoomLevel">100%</div>'
                +   '<button class="lightbox-zoom-btn" id="lbZoomIn">&#43;</button>'
                + '</div>'
                + '<div class="lightbox-counter" id="lightboxCounter"></div>';
            document.body.appendChild(overlay);

            var wrap = document.getElementById('lightboxImgWrap');
            var img = document.getElementById('lightboxImg');

            // 배경 클릭 닫기 (줌 안 된 상태만)
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay && _lbScale <= 1.05) closeLightbox();
            });
            overlay.querySelector('.lightbox-close').addEventListener('click', closeLightbox);
            overlay.querySelector('.lightbox-nav.prev').addEventListener('click', function(e) { e.stopPropagation(); lbPrev(); });
            overlay.querySelector('.lightbox-nav.next').addEventListener('click', function(e) { e.stopPropagation(); lbNext(); });

            // 줌 버튼
            document.getElementById('lbZoomIn').addEventListener('click', function(e) { e.stopPropagation(); _lbZoomTo(_lbScale + 0.5); });
            document.getElementById('lbZoomOut').addEventListener('click', function(e) { e.stopPropagation(); _lbZoomTo(_lbScale - 0.5); });

            // 더블탭/더블클릭 줌 토글
            wrap.addEventListener('click', function(e) {
                var now = Date.now();
                if (now - _lbLastTap < 300) {
                    e.stopPropagation();
                    if (_lbScale > 1.05) { _lbResetZoom(); }
                    else { _lbZoomTo(2.5, e.clientX, e.clientY); }
                }
                _lbLastTap = now;
            });

            // 마우스 드래그 (줌 상태)
            wrap.addEventListener('mousedown', function(e) {
                if (_lbScale <= 1.05) return;
                _lbDragging = true;
                _lbDragStart = {x: e.clientX, y: e.clientY, panX: _lbPanX, panY: _lbPanY};
                wrap.style.cursor = 'grabbing';
                e.preventDefault();
            });
            window.addEventListener('mousemove', function(e) {
                if (!_lbDragging) return;
                _lbPanX = _lbDragStart.panX + (e.clientX - _lbDragStart.x);
                _lbPanY = _lbDragStart.panY + (e.clientY - _lbDragStart.y);
                _lbApplyTransform();
            });
            window.addEventListener('mouseup', function() {
                _lbDragging = false;
                if (wrap) wrap.style.cursor = '';
            });

            // 마우스 휠 줌
            wrap.addEventListener('wheel', function(e) {
                e.preventDefault(); e.stopPropagation();
                var delta = e.deltaY > 0 ? -0.3 : 0.3;
                _lbZoomTo(_lbScale + delta, e.clientX, e.clientY);
            }, {passive: false});

            // 터치: 핀치 줌 + 드래그
            var _touches = {};
            wrap.addEventListener('touchstart', function(e) {
                for (var i = 0; i < e.changedTouches.length; i++) {
                    var t = e.changedTouches[i];
                    _touches[t.identifier] = {x: t.clientX, y: t.clientY};
                }
                var keys = Object.keys(_touches);
                if (keys.length === 2) {
                    var t1 = _touches[keys[0]], t2 = _touches[keys[1]];
                    _lbPinchDist = Math.hypot(t2.x - t1.x, t2.y - t1.y);
                } else if (keys.length === 1 && _lbScale > 1.05) {
                    _lbDragging = true;
                    _lbDragStart = {x: e.touches[0].clientX, y: e.touches[0].clientY, panX: _lbPanX, panY: _lbPanY};
                }
            }, {passive: true});

            wrap.addEventListener('touchmove', function(e) {
                var keys = Object.keys(_touches);
                if (keys.length === 2 && e.touches.length === 2) {
                    e.preventDefault();
                    var t1 = e.touches[0], t2 = e.touches[1];
                    var dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
                    if (_lbPinchDist > 0) {
                        var ratio = dist / _lbPinchDist;
                        var cx = (t1.clientX + t2.clientX) / 2;
                        var cy = (t1.clientY + t2.clientY) / 2;
                        _lbZoomTo(_lbScale * ratio, cx, cy);
                        _lbPinchDist = dist;
                    }
                } else if (_lbDragging && _lbScale > 1.05 && e.touches.length === 1) {
                    e.preventDefault();
                    _lbPanX = _lbDragStart.panX + (e.touches[0].clientX - _lbDragStart.x);
                    _lbPanY = _lbDragStart.panY + (e.touches[0].clientY - _lbDragStart.y);
                    _lbApplyTransform();
                }
            }, {passive: false});

            wrap.addEventListener('touchend', function(e) {
                for (var i = 0; i < e.changedTouches.length; i++) {
                    delete _touches[e.changedTouches[i].identifier];
                }
                if (Object.keys(_touches).length < 2) _lbPinchDist = 0;
                if (Object.keys(_touches).length === 0) _lbDragging = false;
                // 줌 안 된 상태에서 스와이프 → 이전/다음
                if (_lbScale <= 1.05 && e.changedTouches.length === 1 && Object.keys(_touches).length === 0) {
                    var ct = e.changedTouches[0];
                    var startT = _lbDragStart;
                    if (startT && startT.x) {
                        var dx = ct.clientX - startT.x;
                        if (dx > 50) lbPrev();
                        else if (dx < -50) lbNext();
                    }
                }
            });
        }
        _lbResetZoom();
        lbShow();
        overlay.classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        var overlay = document.getElementById('lightboxOverlay');
        if (overlay) overlay.classList.remove('open');
        document.body.style.overflow = '';
        _lbResetZoom();
    }

    function lbShow() {
        var img = document.getElementById('lightboxImg');
        var counter = document.getElementById('lightboxCounter');
        if (!img) return;
        _lbResetZoom();
        img.src = _lbImages[_lbIndex];
        counter.textContent = (_lbIndex + 1) + ' / ' + _lbImages.length;
        var prevBtn = document.querySelector('.lightbox-nav.prev');
        var nextBtn = document.querySelector('.lightbox-nav.next');
        prevBtn.style.display = _lbImages.length > 1 ? '' : 'none';
        nextBtn.style.display = _lbImages.length > 1 ? '' : 'none';
        counter.style.display = _lbImages.length > 1 ? '' : 'none';
    }

    function lbPrev() { if (_lbScale > 1.05) return; _lbIndex = (_lbIndex - 1 + _lbImages.length) % _lbImages.length; lbShow(); }
    function lbNext() { if (_lbScale > 1.05) return; _lbIndex = (_lbIndex + 1) % _lbImages.length; lbShow(); }

    document.addEventListener('keydown', function(e) {
        if (!document.getElementById('lightboxOverlay') || !document.getElementById('lightboxOverlay').classList.contains('open')) return;
        if (e.key === 'Escape') closeLightbox();
        else if (e.key === 'ArrowLeft') lbPrev();
        else if (e.key === 'ArrowRight') lbNext();
        else if (e.key === '+' || e.key === '=') _lbZoomTo(_lbScale + 0.5);
        else if (e.key === '-') _lbZoomTo(_lbScale - 0.5);
        else if (e.key === '0') _lbResetZoom();
    });

    function linkify(text) {
        if (!text) return '';
        return text.replace(/\n/g, '<br>').replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" style="color:#4a90d9;word-break:break-all;">$1</a>');
    }

    async function load() {
        taskData = await Reviewer.apiCall(`/api/task/${progressId}`);
        const container = document.getElementById('taskContainer');

        if (taskData.error) {
            container.innerHTML = '<div class="empty-state"><p>건을 찾을 수 없습니다.</p><a href="/my" class="back-link">내 작업으로</a></div>';
            return;
        }

        const siblings = taskData.siblings || [];
        const pendingSiblings = siblings.filter(s => ['신청', '가이드전달', '구매캡쳐대기'].includes(s.status));
        const allDone = pendingSiblings.length === 0;

        if (allDone) {
            // 모든 아이디 구매완료
            let sibHtml = siblings.map(s => {
                let action = '';
                if (s.status === '리뷰대기') action = `<a href="/task/${s.id}/review" class="btn btn-primary btn-xs">리뷰제출</a>`;
                return `<div class="id-status-bar"><span class="sid">${s.store_id}</span>${Reviewer.statusBadge(s.status)} ${action}</div>`;
            }).join('');

            container.innerHTML = `
                <div class="task-done">
                    <h2>구매 완료</h2>
                    <p>${taskData.product_name}</p>
                    ${sibHtml}
                    <div class="chat-cta" onclick="toggleChatModal()" style="margin-top:16px;">
                        <span class="chat-cta-icon">&#x1f4ac;</span>
                        <span class="chat-cta-text">잘못 입력하셨나요? 채팅으로 바로 수정!</span>
                        <span class="chat-cta-arrow">&#x203A;</span>
                    </div>
                    <a href="/my" class="back-link" style="margin-top:12px;display:block">내 작업으로</a>
                </div>
            `;
            return;
        }

        renderTask();
    }

    function renderTask() {
        const container = document.getElementById('taskContainer');
        const c = taskData.campaign || {};
        const prev = taskData.prev_info || {};
        const siblings = taskData.siblings || [{ id: taskData.id, store_id: taskData.store_id, status: taskData.status }];

        // === 가이드 섹션 (공통 1회) ===
        let guideHtml = '';

        // === 상품 정보 ===
        let productInfo = '';
        if (c.product_name) productInfo += `<div class="task-guide-row"><span class="label">상품명</span><span class="value" style="font-weight:600;">${c.product_name}</span></div>`;
        if (c.platform) productInfo += `<div class="task-guide-row"><span class="label">플랫폼</span><span class="value">${c.platform}</span></div>`;
        var codes = c.product_codes;
        if (codes && codes.codes) {
            var codeEntries = Object.entries(codes.codes);
            if (codeEntries.length > 0) {
                codeEntries.forEach(function(entry) {
                    productInfo += `<div class="task-guide-row"><span class="label">${entry[0]}</span><span class="value" style="font-family:monospace;font-weight:600;letter-spacing:0.5px;">${entry[1]}</span></div>`;
                });
            }
        }
        if (productInfo) {
            guideHtml += `<div class="task-guide-section"><h3>상품 정보</h3><div class="task-guide-details">${productInfo}</div></div>`;
        }

        if (c.campaign_guide) {
            guideHtml += `<div class="task-guide-section">
                <h3>캠페인 가이드</h3>
                <div class="task-guide-content">${linkify(c.campaign_guide)}</div>
            </div>`;
        }

        let guideDetails = '';
        if (c.keyword) guideDetails += `<div class="task-guide-row"><span class="label">키워드</span><span class="value">${c.keyword}</span></div>`;
        if (c.options) guideDetails += `<div class="task-guide-row"><span class="label">옵션</span><span class="value">${c.options}</span></div>`;
        if (c.payment_amount) guideDetails += `<div class="task-guide-row"><span class="label">결제금액</span><span class="value">${Reviewer.formatNumber(c.payment_amount)}원</span></div>`;
        if (c.dwell_time) guideDetails += `<div class="task-guide-row"><span class="label">체류시간</span><span class="value">${c.dwell_time}</span></div>`;
        if (c.entry_method) guideDetails += `<div class="task-guide-row"><span class="label">유입방식</span><span class="value">${c.entry_method}</span></div>`;
        if (c.bookmark_required === 'Y') guideDetails += `<div class="task-guide-row"><span class="label">상품찜</span><span class="value highlight">필수</span></div>`;
        if (c.alert_required === 'Y') guideDetails += `<div class="task-guide-row"><span class="label">알림받기</span><span class="value highlight">필수</span></div>`;
        if (c.ship_memo_required === 'Y') {
            guideDetails += `<div class="task-guide-row"><span class="label">배송메모</span><span class="value highlight">${c.ship_memo_content || '필수'}</span></div>`;
        }
        if (guideDetails) {
            guideHtml += `<div class="task-guide-section"><h3>구매 안내</h3><div class="task-guide-details">${guideDetails}</div></div>`;
        }

        if (c.extra_info) {
            guideHtml += `<div class="task-guide-section">
                <h3>추가 안내</h3>
                <div class="task-guide-content">${linkify(c.extra_info)}</div>
            </div>`;
        }

        // === 참고 사진 세트 ===
        const photoSet = taskData.photo_set || [];
        if (photoSet.length > 0) {
            var photoFullUrls = photoSet.map(function(u) { return driveToFull(u); });
            // window에 저장해서 onclick에서 접근 가능하게
            window._photoSetUrls = photoFullUrls;
            let photosHtml = '<div class="photo-set-gallery">';
            photoSet.forEach(function(url, idx) {
                photosHtml += `<div class="photo-set-item">
                        <img src="${driveToThumb(url)}" alt="참고사진 ${idx+1}" onclick="openLightbox(window._photoSetUrls, ${idx})" onerror="this.parentNode.style.display='none'">
                </div>`;
            });
            photosHtml += '</div>';
            guideHtml += `<div class="task-guide-section">
                <h3>참고 사진 (${photoSet.length}장)</h3>
                <p style="color:#b45309;font-size:13px;font-weight:600;margin:0 0 8px;background:#fef3c7;padding:8px 12px;border-radius:6px;">리뷰용 사진입니다. 저장 후 리뷰에 사용해주세요.<br><span style="font-weight:500;color:#92400e;font-size:12px;">사진을 누르면 크게 볼 수 있습니다.</span></p>
                ${photosHtml}
            </div>`;
        }

        // === 아이디별 탭 + 양식 ===
        const pendingSiblings = siblings.filter(s => ['신청', '가이드전달', '구매캡쳐대기'].includes(s.status));
        const doneSiblings = siblings.filter(s => !['신청', '가이드전달', '구매캡쳐대기'].includes(s.status));

        let tabsHtml = '';
        let panelsHtml = '';

        if (pendingSiblings.length > 1) {
            // 탭 표시
            tabsHtml = '<div class="id-tabs">';
            for (let i = 0; i < pendingSiblings.length; i++) {
                const s = pendingSiblings[i];
                tabsHtml += `<div class="id-tab ${i === 0 ? 'active' : ''}" onclick="switchTab(${i})">${s.store_id}</div>`;
            }
            // 완료된 아이디 탭도 표시
            for (const s of doneSiblings) {
                tabsHtml += `<div class="id-tab done">${s.store_id} (${s.status})</div>`;
            }
            tabsHtml += '</div>';
        }

        for (let i = 0; i < pendingSiblings.length; i++) {
            const s = pendingSiblings[i];
            const sid = s.id;
            panelsHtml += `
            <div class="id-form-panel ${i === 0 ? 'active' : ''}" data-panel="${i}">
                <div class="id-status-bar">
                    <span class="sid">${s.store_id}</span>
                    ${Reviewer.statusBadge(s.status)}
                    ${s.remark && s.remark.startsWith('반려') ? `<span style="color:#e74c3c;font-size:12px;">${s.remark}</span>` : ''}
                </div>

                <div class="task-capture-section">
                    <h3>구매 캡쳐 업로드</h3>
                    <p class="task-capture-hint">주문 상세 화면을 캡쳐해주세요.</p>
                    <div class="task-capture-upload">
                        <label class="file-select-label">
                            <input type="file" accept="image/*" class="file-input" onchange="onFileSelect(this, ${sid})">
                            <span id="fileBtn_${sid}" class="file-select-btn">캡쳐 선택</span>
                        </label>
                        <div id="preview_${sid}" style="display:none"></div>
                    </div>
                    <div id="aiResult_${sid}" style="display:none"></div>
                </div>

                <div id="formSection_${sid}" class="task-form-section" style="display:none">
                    <h3>구매 정보</h3>
                    <div class="form-group">
                        <label>주문번호</label>
                        <input type="text" id="fOrder_${sid}" placeholder="주문번호" value="${s.order_number || ''}">
                    </div>
                    <div class="form-group">
                        <label>수취인명</label>
                        <input type="text" id="fRecipient_${sid}" placeholder="수취인명" value="${s.recipient_name || prev['수취인명'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>연락처</label>
                        <input type="tel" id="fPhone_${sid}" placeholder="수취인 연락처" value="${s.phone || prev['연락처'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>주소</label>
                        <input type="text" id="fAddress_${sid}" placeholder="배송지 주소" value="${s.address || prev['주소'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>결제금액</label>
                        <input type="text" id="fAmount_${sid}" placeholder="결제금액" value="${s.payment_amount || c.payment_amount || ''}">
                    </div>
                    <div class="task-divider"></div>
                    <h4 class="task-form-subtitle">계좌 정보</h4>
                    ${bankPresetsHtml(sid)}
                    <div class="form-group">
                        <label>은행</label>
                        <input type="text" id="fBank_${sid}" placeholder="은행명" value="${s.bank || prev['은행'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>계좌번호</label>
                        <input type="text" id="fAccount_${sid}" placeholder="계좌번호" value="${s.account || prev['계좌'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>예금주</label>
                        <input type="text" id="fDepositor_${sid}" placeholder="예금주" value="${s.depositor || prev['예금주'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>닉네임</label>
                        <input type="text" id="fNickname_${sid}" placeholder="닉네임" value="${s.nickname || ''}">
                    </div>
                    <button type="button" class="btn btn-primary btn-full" onclick="submitPurchase(${sid})">
                        ${s.store_id} 구매완료 제출
                    </button>
                </div>
            </div>`;
        }

        // 신청 취소 버튼 (모든 sibling이 신청/가이드전달일 때만)
        const canCancel = siblings.every(s => ['신청', '가이드전달'].includes(s.status));
        let cancelHtml = '';
        if (canCancel) {
            cancelHtml = `<div style="text-align:center;margin-top:12px;">
                <button class="btn btn-sm" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;font-size:13px;" onclick="cancelTask()">신청 취소</button>
            </div>`;
        }

        // 카운트다운 타이머 계산
        let timerHtml = '';
        if (taskData.created_at && taskData.timeout_seconds) {
            timerHtml = `<div id="deadlineTimer" class="task-deadline-timer"></div>`;
        }

        container.innerHTML = `
            <a href="/my" class="back-link-top">&lt; 내 작업</a>

            ${timerHtml}

            <div class="task-header">
                <h2 class="task-title">${taskData.product_name}</h2>
                <p class="task-subtitle">${taskData.store_name || ''}</p>
            </div>

            ${c.product_image ? `<div class="detail-image"><img src="${driveToThumb(c.product_image)}" alt="상품 이미지" onclick="openLightbox(['${driveToFull(c.product_image)}'], 0)" onerror="this.parentNode.style.display='none'"></div>` : ''}

            ${guideHtml}

            <div class="chat-cta" onclick="toggleChatModal()">
                <span class="chat-cta-icon">&#x1f4ac;</span>
                <span class="chat-cta-text">수정/문의는 채팅으로 바로 해결!</span>
                <span class="chat-cta-arrow">&#x203A;</span>
            </div>

            ${cancelHtml}

            <div class="task-divider"></div>

            ${pendingSiblings.length > 1 ? `<p style="font-size:13px;color:#666;margin-bottom:8px;">${pendingSiblings.length}개 아이디 각각 제출해주세요.</p>` : ''}
            ${tabsHtml}
            ${panelsHtml}
        `;

        // 카운트다운 타이머 시작
        if (taskData.created_at && taskData.timeout_seconds) {
            startDeadlineTimer(taskData.created_at, taskData.timeout_seconds);
        }
    }

    function startDeadlineTimer(createdAt, timeoutSec) {
        const timerEl = document.getElementById('deadlineTimer');
        if (!timerEl) return;

        const createdMs = new Date(createdAt).getTime();
        let deadlineMs = createdMs + timeoutSec * 1000;
        let extending = false;

        function getDeadlineStr() {
            const d = new Date(deadlineMs);
            return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
        }

        async function extendTime() {
            if (extending) return;
            extending = true;
            try {
                const firstSibling = taskData.siblings.find(s => ['가이드전달','구매캡쳐대기'].includes(s.status));
                if (!firstSibling) return;
                const res = await Reviewer.apiPost(`/api/task/${firstSibling.id}/extend-time`);
                if (res.ok) {
                    deadlineMs += 600000; // +10분
                    Reviewer.toast('시간이 10분 연장되었습니다.', 'success');
                } else {
                    Reviewer.toast(res.error || '연장 실패', 'error');
                }
            } catch(e) {
                Reviewer.toast('연장 요청 실패', 'error');
            }
            extending = false;
        }

        function update() {
            const now = Date.now();
            const remainMs = deadlineMs - now;

            if (remainMs <= 0) {
                timerEl.innerHTML = '<span class="timer-expired">제출 시간 초과</span>';
                timerEl.className = 'task-deadline-timer timer-danger';
                return;
            }

            const mins = Math.floor(remainMs / 60000);
            const secs = Math.floor((remainMs % 60000) / 1000);
            const timeStr = mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
            const deadlineStr = getDeadlineStr();

            let extendBtn = '';
            if (remainMs <= 300000) {
                extendBtn = ` <button class="timer-extend-btn" onclick="window._extendTime()">+10분 연장</button>`;
            }

            timerEl.innerHTML = `<span class="timer-icon">&#x23F1;</span> 양식 제출 마감 <strong>${timeStr}</strong> 남음 <span class="timer-deadline">(${deadlineStr}까지)</span>${extendBtn}`;

            if (remainMs <= 300000) {
                timerEl.className = 'task-deadline-timer timer-danger';
            } else if (remainMs <= 600000) {
                timerEl.className = 'task-deadline-timer timer-warning';
            } else {
                timerEl.className = 'task-deadline-timer timer-normal';
            }
        }

        window._extendTime = extendTime;
        update();
        setInterval(update, 1000);
    }

    function bankPresetsHtml(sid) {
        const presets = taskData.bank_presets || [];
        if (presets.length === 0) return '';
        let btns = presets.map((p, i) =>
            `<button type="button" class="bank-preset-btn" onclick="applyBankPreset(${sid}, ${i})">
                <span class="bp-bank">${p['은행']}</span> <span class="bp-account">${p['계좌']}</span><br>
                <span class="bp-depositor">${p['예금주']}</span>
            </button>`
        ).join('');
        return `<div class="bank-presets">${btns}</div>`;
    }

    window.applyBankPreset = function(sid, idx) {
        const p = (taskData.bank_presets || [])[idx];
        if (!p) return;
        document.getElementById(`fBank_${sid}`).value = p['은행'];
        document.getElementById(`fAccount_${sid}`).value = p['계좌'];
        document.getElementById(`fDepositor_${sid}`).value = p['예금주'];
        Reviewer.toast('계좌 정보 적용됨', 'success');
    };

    window.switchTab = function(idx) {
        document.querySelectorAll('.id-tab:not(.done)').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.id-form-panel').forEach((p, i) => p.classList.toggle('active', i === idx));
    };

    window.onFileSelect = function(input, sid) {
        const file = input.files[0];
        if (!file) return;
        selectedFiles[sid] = file;

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(`preview_${sid}`).innerHTML =
                `<img src="${e.target.result}" class="capture-preview">`;
            document.getElementById(`preview_${sid}`).style.display = 'block';
        };
        reader.readAsDataURL(file);

        document.getElementById(`fileBtn_${sid}`).textContent = file.name;
        runAiVerify(file, sid);
    };

    async function runAiVerify(file, sid) {
        const aiResult = document.getElementById(`aiResult_${sid}`);
        aiResult.style.display = 'block';
        aiResult.innerHTML = `<div class="ai-verifying">
            <div class="reviewer-spinner-sm"></div>
            <span>AI 검수중...</span>
        </div>`;

        const formData = new FormData();
        formData.append('capture', file);
        formData.append('capture_type', 'purchase');
        formData.append('campaign_id', taskData.campaign_id);

        const result = await Reviewer.apiPostForm('/api/verify-capture', formData);

        if (!result.ok) {
            aiResult.innerHTML = `<div class="ai-result ai-error">AI 검수 실패: ${result.error || '알 수 없는 오류'}</div>`;
            document.getElementById(`formSection_${sid}`).style.display = 'block';
            return;
        }

        if (result.result === 'AI검수통과') {
            aiResult.innerHTML = `<div class="ai-result ai-pass">AI 검수 통과</div>`;
        } else if (result.result === '자동반려') {
            aiResult.innerHTML = `<div class="ai-result ai-reject">
                <strong>반려</strong>
                <p>${result.reason}</p>
                <p class="ai-warn-note">이 캡쳐로는 제출할 수 없습니다. 다시 캡쳐해주세요.</p>
            </div>`;
            // 자동반려 시 파일 선택 초기화, 폼 미표시
            selectedFiles[sid] = null;
            document.getElementById(`capture_${sid}`).value = '';
            document.getElementById(`preview_${sid}`).style.display = 'none';
            return;
        } else if (result.result === '확인요청') {
            aiResult.innerHTML = `<div class="ai-result ai-warn">
                <strong>담당자 2차검수 필요</strong>
                <p>${result.reason}</p>
                <p class="ai-warn-note">제출은 가능하지만, 담당자 확인이 필요합니다.</p>
            </div>`;
        } else {
            aiResult.innerHTML = `<div class="ai-result ai-error">검수 오류: ${result.reason}</div>`;
        }

        // 파싱 데이터 자동입력
        if (result.parsed) {
            const p = result.parsed;
            if (p['주문번호']) document.getElementById(`fOrder_${sid}`).value = p['주문번호'];
            if (p['수취인명']) document.getElementById(`fRecipient_${sid}`).value = p['수취인명'];
            if (p['수취인연락처']) { const el = document.getElementById(`fPhone_${sid}`); if (el) el.value = p['수취인연락처']; }
            if (p['결제금액']) document.getElementById(`fAmount_${sid}`).value = p['결제금액'];
            if (p['주소']) document.getElementById(`fAddress_${sid}`).value = p['주소'];
        }

        document.getElementById(`formSection_${sid}`).style.display = 'block';
    }

    window.submitPurchase = async function(sid) {
        if (!selectedFiles[sid]) {
            Reviewer.toast('캡쳐를 먼저 선택해주세요.', 'error');
            return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '제출 중...';

        const formData = new FormData();
        formData.append('capture', selectedFiles[sid]);
        formData.append('recipient_name', document.getElementById(`fRecipient_${sid}`).value.trim());
        formData.append('phone', document.getElementById(`fPhone_${sid}`).value.trim());
        formData.append('bank', document.getElementById(`fBank_${sid}`).value.trim());
        formData.append('account', document.getElementById(`fAccount_${sid}`).value.trim());
        formData.append('depositor', document.getElementById(`fDepositor_${sid}`).value.trim());
        formData.append('address', document.getElementById(`fAddress_${sid}`).value.trim());
        formData.append('order_number', document.getElementById(`fOrder_${sid}`).value.trim());
        formData.append('payment_amount', document.getElementById(`fAmount_${sid}`).value.trim());
        formData.append('nickname', document.getElementById(`fNickname_${sid}`).value.trim());

        const result = await Reviewer.apiPostForm(`/api/task/${sid}/purchase`, formData);

        if (result.ok) {
            Reviewer.toast('구매 캡쳐 제출 완료!', 'success');
            setTimeout(() => { window.location.reload(); }, 1200);
        } else {
            Reviewer.toast(result.error || '제출 실패', 'error');
            btn.disabled = false;
            btn.textContent = '구매완료 제출';
        }
    };

    window.cancelTask = async function() {
        if (!confirm('신청을 취소하시겠습니까?')) return;
        try {
            const res = await fetch('/api/task/' + progressId + '/cancel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: user.name, phone: user.phone})
            });
            const d = await res.json();
            if (d.ok) {
                alert('취소되었습니다.');
                location.href = '/my';
            } else {
                alert(d.error || '취소 실패');
            }
        } catch(e) {
            alert('취소 중 오류가 발생했습니다.');
        }
    };

    load();
})();
</script>
{% endblock %}
