{% extends "base.html" %}
{% block title %}구매 가이드 - 카비서{% endblock %}
{% block head %}
<script src="{{ url_for('static', filename='js/reviewer.js') }}"></script>
{% endblock %}

{% block content %}
<div class="page-content">
    <div id="taskContainer" class="loading">불러오는 중...</div>
</div>
{% endblock %}

{% block nav %}
<nav class="bottom-nav">
    <a href="/campaigns" class="nav-item">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">캠페인</span>
    </a>
    <a href="/my" class="nav-item">
        <span class="nav-icon">&#x1f4dd;</span>
        <span class="nav-label">내작업</span>
    </a>
    <a href="/upload" class="nav-item">
        <span class="nav-icon">&#x1f4f7;</span>
        <span class="nav-label">사진제출</span>
    </a>
    <a href="/chat" class="nav-item">
        <span class="nav-icon">&#x1f4ac;</span>
        <span class="nav-label">문의</span>
    </a>
</nav>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const progressId = {{ progress_id }};
    const user = Reviewer.requireLogin();
    if (!user) return;

    let taskData = null;

    async function load() {
        taskData = await Reviewer.apiCall(`/api/task/${progressId}`);
        const container = document.getElementById('taskContainer');

        if (taskData.error) {
            container.innerHTML = '<div class="empty-state"><p>건을 찾을 수 없습니다.</p><a href="/my" class="back-link">내 작업으로</a></div>';
            return;
        }

        // 이미 구매완료인 경우
        if (['리뷰대기', '리뷰제출', '입금대기', '입금완료'].includes(taskData.status)) {
            container.innerHTML = `
                <div class="task-done">
                    <h2>구매 완료</h2>
                    <p>${taskData.product_name} (${taskData.store_id})</p>
                    <p>현재 상태: ${taskData.status}</p>
                    ${taskData.status === '리뷰대기'
                        ? `<a href="/task/${progressId}/review" class="btn btn-primary btn-full" style="margin-top:16px">리뷰 캡쳐 제출</a>`
                        : ''}
                    <a href="/my" class="back-link">내 작업으로</a>
                </div>
            `;
            return;
        }

        renderTask();
    }

    function renderTask() {
        const container = document.getElementById('taskContainer');
        const c = taskData.campaign || {};
        const prev = taskData.prev_info || {};

        // 가이드 섹션
        let guideHtml = '';
        if (c.campaign_guide) {
            guideHtml += `<div class="task-guide-section">
                <h3>캠페인 가이드</h3>
                <div class="task-guide-content">${c.campaign_guide.replace(/\n/g, '<br>')}</div>
            </div>`;
        }

        if (c.product_link) {
            guideHtml += `<div class="task-guide-section">
                <h3>상품 링크</h3>
                <a href="${c.product_link}" target="_blank" class="task-product-link">${c.product_link}</a>
            </div>`;
        }

        let guideDetails = '';
        if (c.keyword) guideDetails += `<div class="task-guide-row"><span class="label">키워드</span><span class="value">${c.keyword}</span></div>`;
        if (c.options) guideDetails += `<div class="task-guide-row"><span class="label">옵션</span><span class="value">${c.options}</span></div>`;
        if (c.payment_amount) guideDetails += `<div class="task-guide-row"><span class="label">결제금액</span><span class="value">${Reviewer.formatNumber(c.payment_amount)}원</span></div>`;
        if (c.dwell_time) guideDetails += `<div class="task-guide-row"><span class="label">체류시간</span><span class="value">${c.dwell_time}</span></div>`;
        if (c.entry_method) guideDetails += `<div class="task-guide-row"><span class="label">유입방식</span><span class="value">${c.entry_method}</span></div>`;
        if (c.bookmark_required === 'Y') guideDetails += `<div class="task-guide-row"><span class="label">상품찜</span><span class="value highlight">필수</span></div>`;
        if (c.alert_required === 'Y') guideDetails += `<div class="task-guide-row"><span class="label">알림받기</span><span class="value highlight">필수</span></div>`;
        if (c.ship_memo_required === 'Y') {
            guideDetails += `<div class="task-guide-row"><span class="label">배송메모</span><span class="value highlight">${c.ship_memo_content || '필수'}</span></div>`;
        }
        if (guideDetails) {
            guideHtml += `<div class="task-guide-section"><h3>구매 안내</h3><div class="task-guide-details">${guideDetails}</div></div>`;
        }

        if (c.extra_info) {
            guideHtml += `<div class="task-guide-section">
                <h3>추가 안내</h3>
                <div class="task-guide-content">${c.extra_info.replace(/\n/g, '<br>')}</div>
            </div>`;
        }

        container.innerHTML = `
            <a href="/my" class="back-link-top">&lt; 내 작업</a>

            <div class="task-header">
                <h2 class="task-title">${taskData.product_name}</h2>
                <p class="task-subtitle">${taskData.store_name || ''} | ${taskData.store_id}</p>
                ${Reviewer.statusBadge(taskData.status)}
            </div>

            ${guideHtml}

            <div class="task-divider"></div>

            <div class="task-capture-section">
                <h3>구매 캡쳐 업로드</h3>
                <p class="task-capture-hint">주문 상세 화면을 캡쳐해주세요. AI가 자동으로 정보를 추출합니다.</p>

                <div class="task-capture-upload">
                    <label class="file-select-label">
                        <input type="file" id="captureFile" accept="image/*" class="file-input" onchange="onFileSelect(this)">
                        <span id="fileSelectBtn" class="file-select-btn">캡쳐 선택</span>
                    </label>
                    <div id="filePreview" style="display:none"></div>
                </div>

                <div id="aiResult" style="display:none"></div>
            </div>

            <div id="formSection" class="task-form-section" style="display:none">
                <h3>구매 정보</h3>
                <p class="task-form-hint">AI가 자동입력한 정보를 확인하고, 계좌정보를 입력해주세요.</p>

                <div class="form-group">
                    <label>주문번호</label>
                    <input type="text" id="fOrderNumber" placeholder="주문번호" value="${taskData.order_number || ''}">
                </div>
                <div class="form-group">
                    <label>수취인명</label>
                    <input type="text" id="fRecipientName" placeholder="수취인명" value="${taskData.recipient_name || prev['수취인명'] || ''}">
                </div>
                <div class="form-group">
                    <label>주소</label>
                    <input type="text" id="fAddress" placeholder="배송지 주소" value="${taskData.address || prev['주소'] || ''}">
                </div>
                <div class="form-group">
                    <label>결제금액</label>
                    <input type="text" id="fPaymentAmount" placeholder="결제금액" value="${taskData.payment_amount || c.payment_amount || ''}">
                </div>

                <div class="task-divider"></div>
                <h4 class="task-form-subtitle">계좌 정보 (직접 입력)</h4>

                <div class="form-group">
                    <label>은행</label>
                    <input type="text" id="fBank" placeholder="은행명" value="${taskData.bank || prev['은행'] || ''}">
                </div>
                <div class="form-group">
                    <label>계좌번호</label>
                    <input type="text" id="fAccount" placeholder="계좌번호" value="${taskData.account || prev['계좌'] || ''}">
                </div>
                <div class="form-group">
                    <label>예금주</label>
                    <input type="text" id="fDepositor" placeholder="예금주" value="${taskData.depositor || prev['예금주'] || ''}">
                </div>
                <div class="form-group">
                    <label>닉네임</label>
                    <input type="text" id="fNickname" placeholder="쿠팡/네이버 닉네임" value="${taskData.nickname || ''}">
                </div>

                <button type="button" id="submitPurchase" class="btn btn-primary btn-full" onclick="submitPurchase()">
                    구매완료 제출
                </button>
            </div>
        `;
    }

    let selectedFile = null;

    window.onFileSelect = function(input) {
        const file = input.files[0];
        if (!file) return;
        selectedFile = file;

        // 미리보기
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('filePreview').innerHTML =
                `<img src="${e.target.result}" class="capture-preview">`;
            document.getElementById('filePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);

        document.getElementById('fileSelectBtn').textContent = file.name;

        // AI 검수 실행
        runAiVerify(file);
    };

    async function runAiVerify(file) {
        const aiResult = document.getElementById('aiResult');
        aiResult.style.display = 'block';
        aiResult.innerHTML = `<div class="ai-verifying">
            <div class="reviewer-spinner-sm"></div>
            <span>AI 검수중...</span>
        </div>`;

        const formData = new FormData();
        formData.append('capture', file);
        formData.append('capture_type', 'purchase');
        formData.append('campaign_id', taskData.campaign_id);

        const result = await Reviewer.apiPostForm('/api/verify-capture', formData);

        if (!result.ok) {
            aiResult.innerHTML = `<div class="ai-result ai-error">AI 검수 실패: ${result.error || '알 수 없는 오류'}</div>`;
            // 폼은 보여주되 경고 표시
            document.getElementById('formSection').style.display = 'block';
            return;
        }

        if (result.result === 'AI검수통과') {
            aiResult.innerHTML = `<div class="ai-result ai-pass">AI 검수 통과</div>`;
        } else if (result.result === '확인요청') {
            aiResult.innerHTML = `<div class="ai-result ai-warn">
                <strong>담당자 2차검수 필요</strong>
                <p>${result.reason}</p>
                <p class="ai-warn-note">제출은 가능하지만, 담당자 확인이 필요합니다.</p>
            </div>`;
        } else {
            aiResult.innerHTML = `<div class="ai-result ai-error">검수 오류: ${result.reason}</div>`;
        }

        // 파싱 데이터 자동입력
        if (result.parsed) {
            const parsed = result.parsed;
            if (parsed['주문번호']) document.getElementById('fOrderNumber').value = parsed['주문번호'];
            if (parsed['수취인명']) document.getElementById('fRecipientName').value = parsed['수취인명'];
            if (parsed['결제금액']) document.getElementById('fPaymentAmount').value = parsed['결제금액'];
        }

        // 폼 표시
        document.getElementById('formSection').style.display = 'block';
    }

    window.submitPurchase = async function() {
        if (!selectedFile) {
            Reviewer.toast('캡쳐를 먼저 선택해주세요.', 'error');
            return;
        }

        const btn = document.getElementById('submitPurchase');
        btn.disabled = true;
        btn.textContent = '제출 중...';

        const formData = new FormData();
        formData.append('capture', selectedFile);
        formData.append('recipient_name', document.getElementById('fRecipientName').value.trim());
        formData.append('phone', document.getElementById('fRecipientName').value.trim() ? (taskData.phone || '') : '');
        formData.append('bank', document.getElementById('fBank').value.trim());
        formData.append('account', document.getElementById('fAccount').value.trim());
        formData.append('depositor', document.getElementById('fDepositor').value.trim());
        formData.append('address', document.getElementById('fAddress').value.trim());
        formData.append('order_number', document.getElementById('fOrderNumber').value.trim());
        formData.append('payment_amount', document.getElementById('fPaymentAmount').value.trim());
        formData.append('nickname', document.getElementById('fNickname').value.trim());

        const result = await Reviewer.apiPostForm(`/api/task/${progressId}/purchase`, formData);

        if (result.ok) {
            Reviewer.toast('구매 캡쳐 제출 완료!', 'success');
            setTimeout(() => { window.location.reload(); }, 1200);
        } else {
            Reviewer.toast(result.error || '제출 실패', 'error');
            btn.disabled = false;
            btn.textContent = '구매완료 제출';
        }
    };

    load();
})();
</script>
{% endblock %}
