{% extends "base.html" %}
{% block title %}구매 가이드 - 카비서{% endblock %}
{% block head %}
<script src="{{ url_for('static', filename='js/reviewer.js') }}"></script>
<style>
.id-tabs { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
.id-tab {
    padding: 6px 14px; border: 1px solid #ddd; border-radius: 20px;
    font-size: 13px; cursor: pointer; background: #fff; color: #555;
}
.id-tab.active { background: #fee500; border-color: #e6cf00; font-weight: 700; color: #3c1e1e; }
.id-tab.done { background: #e8f5e9; border-color: #a5d6a7; color: #2e7d32; }
.id-form-panel { display: none; }
.id-form-panel.active { display: block; }
.id-status-bar {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 12px; background: #f5f5f5; border-radius: 8px; margin-bottom: 12px;
    font-size: 13px;
}
.id-status-bar .sid { font-weight: 700; }
.bank-presets { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.bank-preset-btn {
    padding: 6px 12px; border: 1px solid #ddd; border-radius: 8px;
    font-size: 12px; cursor: pointer; background: #fff; color: #333;
    line-height: 1.4; text-align: left;
}
.bank-preset-btn:hover { border-color: #fee500; background: #fffde7; }
.bank-preset-btn .bp-bank { font-weight: 700; }
.bank-preset-btn .bp-account { color: #666; }
</style>
{% endblock %}

{% block content %}
<div class="page-content">
    <div id="taskContainer" class="loading">불러오는 중...</div>
</div>
{% endblock %}

{% block nav %}
<nav class="bottom-nav">
    <a href="/campaigns" class="nav-item">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">캠페인</span>
    </a>
    <a href="/my" class="nav-item">
        <span class="nav-icon">&#x1f4dd;</span>
        <span class="nav-label">내작업</span>
    </a>
    <a href="/upload" class="nav-item">
        <span class="nav-icon">&#x1f4f7;</span>
        <span class="nav-label">리뷰제출</span>
    </a>
    <a href="/chat" class="nav-item">
        <span class="nav-icon">&#x1f4ac;</span>
        <span class="nav-label">문의</span>
    </a>
</nav>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const progressId = {{ progress_id }};
    const user = Reviewer.requireLogin();
    if (!user) return;

    let taskData = null;
    let selectedFiles = {}; // per sibling id

    async function load() {
        taskData = await Reviewer.apiCall(`/api/task/${progressId}`);
        const container = document.getElementById('taskContainer');

        if (taskData.error) {
            container.innerHTML = '<div class="empty-state"><p>건을 찾을 수 없습니다.</p><a href="/my" class="back-link">내 작업으로</a></div>';
            return;
        }

        const siblings = taskData.siblings || [];
        const pendingSiblings = siblings.filter(s => ['신청', '가이드전달', '구매캡쳐대기'].includes(s.status));
        const allDone = pendingSiblings.length === 0;

        if (allDone) {
            // 모든 아이디 구매완료
            let sibHtml = siblings.map(s => {
                let action = '';
                if (s.status === '리뷰대기') action = `<a href="/task/${s.id}/review" class="btn btn-primary btn-xs">리뷰제출</a>`;
                return `<div class="id-status-bar"><span class="sid">${s.store_id}</span>${Reviewer.statusBadge(s.status)} ${action}</div>`;
            }).join('');

            container.innerHTML = `
                <div class="task-done">
                    <h2>구매 완료</h2>
                    <p>${taskData.product_name}</p>
                    ${sibHtml}
                    <a href="/my" class="back-link" style="margin-top:16px;display:block">내 작업으로</a>
                </div>
            `;
            return;
        }

        renderTask();
    }

    function renderTask() {
        const container = document.getElementById('taskContainer');
        const c = taskData.campaign || {};
        const prev = taskData.prev_info || {};
        const siblings = taskData.siblings || [{ id: taskData.id, store_id: taskData.store_id, status: taskData.status }];

        // === 가이드 섹션 (공통 1회) ===
        let guideHtml = '';
        if (c.campaign_guide) {
            guideHtml += `<div class="task-guide-section">
                <h3>캠페인 가이드</h3>
                <div class="task-guide-content">${c.campaign_guide.replace(/\n/g, '<br>')}</div>
            </div>`;
        }

        if (c.product_link) {
            guideHtml += `<div class="task-guide-section">
                <h3>상품 링크</h3>
                <a href="${c.product_link}" target="_blank" class="task-product-link">${c.product_link}</a>
            </div>`;
        }

        let guideDetails = '';
        if (c.keyword) guideDetails += `<div class="task-guide-row"><span class="label">키워드</span><span class="value">${c.keyword}</span></div>`;
        if (c.options) guideDetails += `<div class="task-guide-row"><span class="label">옵션</span><span class="value">${c.options}</span></div>`;
        if (c.payment_amount) guideDetails += `<div class="task-guide-row"><span class="label">결제금액</span><span class="value">${Reviewer.formatNumber(c.payment_amount)}원</span></div>`;
        if (c.dwell_time) guideDetails += `<div class="task-guide-row"><span class="label">체류시간</span><span class="value">${c.dwell_time}</span></div>`;
        if (c.entry_method) guideDetails += `<div class="task-guide-row"><span class="label">유입방식</span><span class="value">${c.entry_method}</span></div>`;
        if (c.bookmark_required === 'Y') guideDetails += `<div class="task-guide-row"><span class="label">상품찜</span><span class="value highlight">필수</span></div>`;
        if (c.alert_required === 'Y') guideDetails += `<div class="task-guide-row"><span class="label">알림받기</span><span class="value highlight">필수</span></div>`;
        if (c.ship_memo_required === 'Y') {
            guideDetails += `<div class="task-guide-row"><span class="label">배송메모</span><span class="value highlight">${c.ship_memo_content || '필수'}</span></div>`;
        }
        if (guideDetails) {
            guideHtml += `<div class="task-guide-section"><h3>구매 안내</h3><div class="task-guide-details">${guideDetails}</div></div>`;
        }

        if (c.extra_info) {
            guideHtml += `<div class="task-guide-section">
                <h3>추가 안내</h3>
                <div class="task-guide-content">${c.extra_info.replace(/\n/g, '<br>')}</div>
            </div>`;
        }

        // === 아이디별 탭 + 양식 ===
        const pendingSiblings = siblings.filter(s => ['신청', '가이드전달', '구매캡쳐대기'].includes(s.status));
        const doneSiblings = siblings.filter(s => !['신청', '가이드전달', '구매캡쳐대기'].includes(s.status));

        let tabsHtml = '';
        let panelsHtml = '';

        if (pendingSiblings.length > 1) {
            // 탭 표시
            tabsHtml = '<div class="id-tabs">';
            for (let i = 0; i < pendingSiblings.length; i++) {
                const s = pendingSiblings[i];
                tabsHtml += `<div class="id-tab ${i === 0 ? 'active' : ''}" onclick="switchTab(${i})">${s.store_id}</div>`;
            }
            // 완료된 아이디 탭도 표시
            for (const s of doneSiblings) {
                tabsHtml += `<div class="id-tab done">${s.store_id} (${s.status})</div>`;
            }
            tabsHtml += '</div>';
        }

        for (let i = 0; i < pendingSiblings.length; i++) {
            const s = pendingSiblings[i];
            const sid = s.id;
            panelsHtml += `
            <div class="id-form-panel ${i === 0 ? 'active' : ''}" data-panel="${i}">
                <div class="id-status-bar">
                    <span class="sid">${s.store_id}</span>
                    ${Reviewer.statusBadge(s.status)}
                    ${s.remark && s.remark.startsWith('반려') ? `<span style="color:#e74c3c;font-size:12px;">${s.remark}</span>` : ''}
                </div>

                <div class="task-capture-section">
                    <h3>구매 캡쳐 업로드</h3>
                    <p class="task-capture-hint">주문 상세 화면을 캡쳐해주세요.</p>
                    <div class="task-capture-upload">
                        <label class="file-select-label">
                            <input type="file" accept="image/*" class="file-input" onchange="onFileSelect(this, ${sid})">
                            <span id="fileBtn_${sid}" class="file-select-btn">캡쳐 선택</span>
                        </label>
                        <div id="preview_${sid}" style="display:none"></div>
                    </div>
                    <div id="aiResult_${sid}" style="display:none"></div>
                </div>

                <div id="formSection_${sid}" class="task-form-section" style="display:none">
                    <h3>구매 정보</h3>
                    <div class="form-group">
                        <label>주문번호</label>
                        <input type="text" id="fOrder_${sid}" placeholder="주문번호" value="${s.order_number || ''}">
                    </div>
                    <div class="form-group">
                        <label>수취인명</label>
                        <input type="text" id="fRecipient_${sid}" placeholder="수취인명" value="${s.recipient_name || prev['수취인명'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>주소</label>
                        <input type="text" id="fAddress_${sid}" placeholder="배송지 주소" value="${s.address || prev['주소'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>결제금액</label>
                        <input type="text" id="fAmount_${sid}" placeholder="결제금액" value="${s.payment_amount || c.payment_amount || ''}">
                    </div>
                    <div class="task-divider"></div>
                    <h4 class="task-form-subtitle">계좌 정보</h4>
                    ${bankPresetsHtml(sid)}
                    <div class="form-group">
                        <label>은행</label>
                        <input type="text" id="fBank_${sid}" placeholder="은행명" value="${s.bank || prev['은행'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>계좌번호</label>
                        <input type="text" id="fAccount_${sid}" placeholder="계좌번호" value="${s.account || prev['계좌'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>예금주</label>
                        <input type="text" id="fDepositor_${sid}" placeholder="예금주" value="${s.depositor || prev['예금주'] || ''}">
                    </div>
                    <div class="form-group">
                        <label>닉네임</label>
                        <input type="text" id="fNickname_${sid}" placeholder="닉네임" value="${s.nickname || ''}">
                    </div>
                    <button type="button" class="btn btn-primary btn-full" onclick="submitPurchase(${sid})">
                        ${s.store_id} 구매완료 제출
                    </button>
                </div>
            </div>`;
        }

        container.innerHTML = `
            <a href="/my" class="back-link-top">&lt; 내 작업</a>

            <div class="task-header">
                <h2 class="task-title">${taskData.product_name}</h2>
                <p class="task-subtitle">${taskData.store_name || ''}</p>
            </div>

            ${guideHtml}

            <div class="task-divider"></div>

            ${pendingSiblings.length > 1 ? `<p style="font-size:13px;color:#666;margin-bottom:8px;">${pendingSiblings.length}개 아이디 각각 제출해주세요.</p>` : ''}
            ${tabsHtml}
            ${panelsHtml}
        `;
    }

    function bankPresetsHtml(sid) {
        const presets = taskData.bank_presets || [];
        if (presets.length === 0) return '';
        let btns = presets.map((p, i) =>
            `<button type="button" class="bank-preset-btn" onclick="applyBankPreset(${sid}, ${i})">
                <span class="bp-bank">${p['은행']}</span> <span class="bp-account">${p['계좌']}</span><br>
                <span class="bp-depositor">${p['예금주']}</span>
            </button>`
        ).join('');
        return `<div class="bank-presets">${btns}</div>`;
    }

    window.applyBankPreset = function(sid, idx) {
        const p = (taskData.bank_presets || [])[idx];
        if (!p) return;
        document.getElementById(`fBank_${sid}`).value = p['은행'];
        document.getElementById(`fAccount_${sid}`).value = p['계좌'];
        document.getElementById(`fDepositor_${sid}`).value = p['예금주'];
        Reviewer.toast('계좌 정보 적용됨', 'success');
    };

    window.switchTab = function(idx) {
        document.querySelectorAll('.id-tab:not(.done)').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.id-form-panel').forEach((p, i) => p.classList.toggle('active', i === idx));
    };

    window.onFileSelect = function(input, sid) {
        const file = input.files[0];
        if (!file) return;
        selectedFiles[sid] = file;

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(`preview_${sid}`).innerHTML =
                `<img src="${e.target.result}" class="capture-preview">`;
            document.getElementById(`preview_${sid}`).style.display = 'block';
        };
        reader.readAsDataURL(file);

        document.getElementById(`fileBtn_${sid}`).textContent = file.name;
        runAiVerify(file, sid);
    };

    async function runAiVerify(file, sid) {
        const aiResult = document.getElementById(`aiResult_${sid}`);
        aiResult.style.display = 'block';
        aiResult.innerHTML = `<div class="ai-verifying">
            <div class="reviewer-spinner-sm"></div>
            <span>AI 검수중...</span>
        </div>`;

        const formData = new FormData();
        formData.append('capture', file);
        formData.append('capture_type', 'purchase');
        formData.append('campaign_id', taskData.campaign_id);

        const result = await Reviewer.apiPostForm('/api/verify-capture', formData);

        if (!result.ok) {
            aiResult.innerHTML = `<div class="ai-result ai-error">AI 검수 실패: ${result.error || '알 수 없는 오류'}</div>`;
            document.getElementById(`formSection_${sid}`).style.display = 'block';
            return;
        }

        if (result.result === 'AI검수통과') {
            aiResult.innerHTML = `<div class="ai-result ai-pass">AI 검수 통과</div>`;
        } else if (result.result === '확인요청') {
            aiResult.innerHTML = `<div class="ai-result ai-warn">
                <strong>담당자 2차검수 필요</strong>
                <p>${result.reason}</p>
                <p class="ai-warn-note">제출은 가능하지만, 담당자 확인이 필요합니다.</p>
            </div>`;
        } else {
            aiResult.innerHTML = `<div class="ai-result ai-error">검수 오류: ${result.reason}</div>`;
        }

        // 파싱 데이터 자동입력
        if (result.parsed) {
            const p = result.parsed;
            if (p['주문번호']) document.getElementById(`fOrder_${sid}`).value = p['주문번호'];
            if (p['수취인명']) document.getElementById(`fRecipient_${sid}`).value = p['수취인명'];
            if (p['결제금액']) document.getElementById(`fAmount_${sid}`).value = p['결제금액'];
            if (p['주소']) document.getElementById(`fAddress_${sid}`).value = p['주소'];
        }

        document.getElementById(`formSection_${sid}`).style.display = 'block';
    }

    window.submitPurchase = async function(sid) {
        if (!selectedFiles[sid]) {
            Reviewer.toast('캡쳐를 먼저 선택해주세요.', 'error');
            return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '제출 중...';

        const formData = new FormData();
        formData.append('capture', selectedFiles[sid]);
        formData.append('recipient_name', document.getElementById(`fRecipient_${sid}`).value.trim());
        formData.append('phone', taskData.phone || '');
        formData.append('bank', document.getElementById(`fBank_${sid}`).value.trim());
        formData.append('account', document.getElementById(`fAccount_${sid}`).value.trim());
        formData.append('depositor', document.getElementById(`fDepositor_${sid}`).value.trim());
        formData.append('address', document.getElementById(`fAddress_${sid}`).value.trim());
        formData.append('order_number', document.getElementById(`fOrder_${sid}`).value.trim());
        formData.append('payment_amount', document.getElementById(`fAmount_${sid}`).value.trim());
        formData.append('nickname', document.getElementById(`fNickname_${sid}`).value.trim());

        const result = await Reviewer.apiPostForm(`/api/task/${sid}/purchase`, formData);

        if (result.ok) {
            Reviewer.toast('구매 캡쳐 제출 완료!', 'success');
            setTimeout(() => { window.location.reload(); }, 1200);
        } else {
            Reviewer.toast(result.error || '제출 실패', 'error');
            btn.disabled = false;
            btn.textContent = '구매완료 제출';
        }
    };

    load();
})();
</script>
{% endblock %}
