<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¹´ë¹„ì„œ í™ë³´ ê´€ë¦¬</title>
  <link rel="stylesheet" href="/static/campaign.css">
  <style>
    /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
    .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 22px; transition: .3s; }
    .toggle-slider:before { content: ""; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .3s; }
    .toggle-switch input:checked + .toggle-slider { background: #2ECC71; }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); }

    /* ì¹´í…Œê³ ë¦¬ ì¹© */
    .cat-chip { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin: 2px; background: #F5F5F5; color: #555; }
    .cat-chip.removable { padding-right: 6px; }
    .cat-chip .chip-remove { display: inline-block; margin-left: 4px; cursor: pointer; font-size: 14px; line-height: 1; vertical-align: middle; opacity: 0.6; }
    .cat-chip .chip-remove:hover { opacity: 1; }

    /* ìš°ì„ ìˆœìœ„ ë±ƒì§€ */
    .priority-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .priority-1 { background: #FFEBEE; color: #C62828; }
    .priority-2 { background: #E3F2FD; color: #1565C0; }
    .priority-3 { background: #FFF8E1; color: #F57F17; }

    /* ê²°ê³¼ ë±ƒì§€ */
    .result-success { color: #2E7D32; font-weight: 600; }
    .result-fail { color: #C62828; font-weight: 600; }

    /* ì ‘ê¸°/í¼ì¹˜ê¸° */
    .collapsible-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
    .collapsible-header .toggle-icon { font-size: 12px; color: #999; transition: transform 0.2s; }
    .collapsible-header.open .toggle-icon { transform: rotate(90deg); }
    .collapsible-body { overflow: hidden; transition: max-height 0.3s ease; }
    .collapsible-body.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; }

    /* ì²´í¬ë°•ìŠ¤ ê·¸ë¦¬ë“œ */
    .checkbox-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .checkbox-grid label { display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer; padding: 4px 8px; border: 1px solid #E5E0D5; border-radius: 6px; transition: background 0.15s; }
    .checkbox-grid label:hover { background: #FFF8E1; }
    .checkbox-grid input[type="checkbox"]:checked + span { font-weight: 600; }

    /* ì‹œê°„ ì„ íƒ ì˜ì—­ */
    .time-range { display: flex; align-items: center; gap: 6px; }
    .time-range select { width: auto; min-width: 80px; }

    /* ì¸ë¼ì¸ ìˆ˜ì • ëª¨ë‹¬ ëŒ€ì‹  ì¸ë¼ì¸ í¼ */
    .edit-row { background: #FFFDE7; }
    .edit-row td { padding: 8px !important; }
    .edit-row input, .edit-row select { font-size: 12px; padding: 4px 6px; }

    /* ì±„íŒ…ë°© ìœ í˜• ë±ƒì§€ */
    .type-badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .type-open { background: #E8F5E9; color: #2E7D32; }
    .type-normal { background: #E3F2FD; color: #1565C0; }

    /* ìë™ ìƒˆë¡œê³ ì¹¨ í‘œì‹œ */
    .auto-refresh-indicator { font-size: 11px; color: #999; margin-left: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>ì¹´ë¹„ì„œ í™ë³´ ê´€ë¦¬</h1>
    <span class="server-time" id="serverTime">--</span>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="chatrooms">ì±„íŒ…ë°© ê´€ë¦¬</button>
    <button class="tab" data-tab="promotion">í™ë³´ í˜„í™©</button>
    <button class="tab" data-tab="logs">ë¡œê·¸</button>
  </nav>

  <main>
    <!-- ============ Tab 1: ì±„íŒ…ë°© ê´€ë¦¬ ============ -->
    <section id="tab-chatrooms" class="tab-content active">

      <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ -->
      <div class="card">
        <h2>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h2>
        <div id="categoryChips" style="margin-bottom: 12px;">
          <p class="muted">ë¡œë”© ì¤‘...</p>
        </div>
        <div class="filter-row">
          <input type="text" id="newCategoryInput" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ëª…" style="max-width: 200px;">
          <button class="btn btn-sm" onclick="addCategory()">ì¶”ê°€</button>
          <span class="form-status" id="categoryStatus"></span>
        </div>
      </div>

      <!-- ì±„íŒ…ë°© ëª©ë¡ -->
      <div class="card">
        <h2>ì±„íŒ…ë°© ëª©ë¡</h2>
        <div class="filter-row">
          <button class="btn btn-sm" onclick="loadChatrooms()">ìƒˆë¡œê³ ì¹¨</button>
          <span id="chatroomCount" style="font-size: 13px; color: #6B6B6B;"></span>
        </div>
        <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;">
          <button onclick="scanChatrooms('scan')" style="padding:6px 14px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;font-size:13px;">ğŸ”„ ì „ì²´ ìŠ¤ìº”</button>
          <button onclick="scanChatrooms('add')" style="padding:6px 14px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;font-size:13px;">â• ì¶”ê°€ ìŠ¤ìº”</button>
          <span style="font-size:12px;color:#999;">ì—´ë ¤ìˆëŠ” ì±„íŒ…ì°½ì„ ì½ìŠµë‹ˆë‹¤</span>
          <span id="scanStatus" style="margin-left:4px;font-size:13px;color:#666;"></span>
        </div>
        <div id="chatroomList">
          <p class="muted">ë¡œë”© ì¤‘...</p>
        </div>
      </div>

      <!-- ì±„íŒ…ë°© ì¶”ê°€ -->
      <div class="card">
        <div class="collapsible-header" id="addRoomHeader" onclick="toggleCollapsible('addRoomBody', 'addRoomHeader')">
          <h2 style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">ì±„íŒ…ë°© ì¶”ê°€</h2>
          <span class="toggle-icon">&#9654;</span>
        </div>
        <div class="collapsible-body collapsed" id="addRoomBody">
          <form id="addRoomForm" onsubmit="addChatroom(event)" style="margin-top: 14px;">
            <div class="form-row">
              <div class="form-group">
                <label>ì±„íŒ…ë°©ëª… <span style="color: #E74C3C;">*</span></label>
                <input type="text" name="name" required placeholder="ì •í™•í•œ ì¹´ì¹´ì˜¤í†¡ ì±„íŒ…ë°© ì´ë¦„">
              </div>
              <div class="form-group">
                <label>ìœ í˜•</label>
                <select name="type">
                  <option value="open">ì˜¤í”ˆì±„íŒ…</option>
                  <option value="normal">ì¼ë°˜ì±„íŒ…</option>
                </select>
              </div>
              <div class="form-group">
                <label>ë°œì†¡ì£¼ê¸° (ë¶„)</label>
                <input type="number" name="cooldown_minutes" value="60" min="1" max="1440">
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <label>ì¹´í…Œê³ ë¦¬</label>
              <div class="checkbox-grid" id="addRoomCategories">
                <p class="muted">ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”</p>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>í™ë³´ê°€ëŠ¥ì‹œê°„</label>
                <div class="time-range">
                  <select name="active_start" id="addRoomStartTime"></select>
                  <span>~</span>
                  <select name="active_end" id="addRoomEndTime"></select>
                  <label style="font-size: 12px; margin-left: 4px;">
                    <input type="checkbox" name="next_day" id="addRoomNextDay"> ìµì¼
                  </label>
                </div>
              </div>
            </div>
            <button type="submit" class="btn btn-save">ì¶”ê°€</button>
            <span class="form-status" id="addRoomStatus"></span>
          </form>
        </div>
      </div>

    </section>

    <!-- ============ Tab 2: í™ë³´ í˜„í™© ============ -->
    <section id="tab-promotion" class="tab-content">

      <!-- í™ë³´ ì œì–´ -->
      <div class="card">
        <h2>í™ë³´ ì œì–´</h2>
        <div class="status-indicators" style="margin-bottom: 12px;">
          <span class="badge" id="systemStatusBadge">ì‹œìŠ¤í…œ: --</span>
          <span class="badge" id="promotionStatusBadge">í™ë³´: --</span>
        </div>
        <div class="control-buttons">
          <button class="btn btn-start" id="btnPromoStart" onclick="startPromotion()">ì‹œì‘</button>
          <button class="btn btn-stop" id="btnPromoStop" onclick="stopPromotion()" disabled>ì¤‘ì§€</button>
        </div>
        <span class="form-status" id="promotionControlStatus"></span>
      </div>

      <!-- ëŒ€ê¸° ì¤‘ì¸ ì‘ì—… -->
      <div class="card">
        <h2>ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…</h2>
        <div class="filter-row">
          <button class="btn btn-sm" onclick="loadPendingTasks()">ìƒˆë¡œê³ ì¹¨</button>
          <span id="pendingTaskCount" style="font-size: 13px; color: #6B6B6B;"></span>
        </div>
        <div id="pendingTaskList">
          <p class="muted">ë¡œë”© ì¤‘...</p>
        </div>
      </div>

      <!-- ìµœê·¼ í™ë³´ ì´ë ¥ -->
      <div class="card">
        <h2>ìµœê·¼ í™ë³´ ì´ë ¥<span class="auto-refresh-indicator" id="historyRefreshIndicator">10ì´ˆë§ˆë‹¤ ê°±ì‹ </span></h2>
        <div id="promotionHistory">
          <p class="muted">ë¡œë”© ì¤‘...</p>
        </div>
      </div>

    </section>

    <!-- ============ Tab 3: ë¡œê·¸ ============ -->
    <section id="tab-logs" class="tab-content">
      <div class="card">
        <h2>ì‹œìŠ¤í…œ ë¡œê·¸<span class="auto-refresh-indicator" id="logRefreshIndicator">10ì´ˆë§ˆë‹¤ ê°±ì‹ </span></h2>
        <div class="filter-row">
          <button class="btn btn-sm" onclick="loadLogs()">ìƒˆë¡œê³ ì¹¨</button>
          <select id="logLevelFilter" onchange="loadLogs()" style="max-width: 120px;">
            <option value="">ì „ì²´</option>
            <option value="ERROR">ERROR</option>
            <option value="WARNING">WARNING</option>
            <option value="INFO">INFO</option>
          </select>
        </div>
        <div id="logContainer" class="log-container">
          <p class="muted">ë¡œë”© ì¤‘...</p>
        </div>
      </div>
    </section>
  </main>

  <script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ê¸€ë¡œë²Œ ìƒíƒœ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let _categories = [];
  let _chatrooms = [];
  let _editingRoom = null; // í˜„ì¬ ì¸ë¼ì¸ ìˆ˜ì • ì¤‘ì¸ ì±„íŒ…ë°©ëª…

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• API í—¬í¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function api(url, options = {}) {
    try {
      const resp = await fetch(url, options);
      return await resp.json();
    } catch (e) {
      console.error('API ì˜¤ë¥˜:', e);
      return { error: e.message };
    }
  }

  function escHtml(s) {
    const d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ­ ì „í™˜ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');

      // íƒ­ ì§„ì… ì‹œ ë°ì´í„° ë¡œë“œ
      if (btn.dataset.tab === 'promotion') {
        loadPendingTasks();
        loadPromotionHistory();
      } else if (btn.dataset.tab === 'logs') {
        loadLogs();
      }
    });
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì ‘ê¸°/í¼ì¹˜ê¸° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function toggleCollapsible(bodyId, headerId) {
    const body = document.getElementById(bodyId);
    const header = document.getElementById(headerId);
    body.classList.toggle('collapsed');
    header.classList.toggle('open');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì‹œê°„ ì…€ë ‰íŠ¸ ìƒì„± â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function populateTimeSelects() {
    const starts = [document.getElementById('addRoomStartTime')];
    const ends = [document.getElementById('addRoomEndTime')];

    [...starts, ...ends].forEach(sel => {
      if (!sel) return;
      sel.innerHTML = '';
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          const val = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          sel.appendChild(opt);
        }
      }
    });

    // ê¸°ë³¸ê°’: 09:00 ~ 22:00
    if (starts[0]) starts[0].value = '09:00';
    if (ends[0]) ends[0].value = '22:00';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const CATEGORY_COLORS = [
    { bg: '#E8F5E9', fg: '#2E7D32' },  // ë…¹ìƒ‰
    { bg: '#E3F2FD', fg: '#1565C0' },  // íŒŒë‘
    { bg: '#FFF3E0', fg: '#E65100' },  // ì£¼í™©
    { bg: '#F3E5F5', fg: '#6A1B9A' },  // ë³´ë¼
    { bg: '#E0F7FA', fg: '#00695C' },  // ì²­ë¡
    { bg: '#FBE9E7', fg: '#BF360C' },  // ë¹¨ê°•
    { bg: '#F1F8E9', fg: '#33691E' },  // ì—°ë‘
    { bg: '#FCE4EC', fg: '#AD1457' },  // í•‘í¬
  ];

  function categoryColor(name) {
    // ê°„ë‹¨í•œ í•´ì‹œ
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = ((hash << 5) - hash) + name.charCodeAt(i);
      hash |= 0;
    }
    const idx = Math.abs(hash) % CATEGORY_COLORS.length;
    return CATEGORY_COLORS[idx];
  }

  function catChipHtml(name, removable) {
    const c = categoryColor(name);
    const removeBtn = removable
      ? ' <span class="chip-remove" onclick="removeCategory(\'' + escHtml(name).replace(/'/g, "\\'") + '\')">&times;</span>'
      : '';
    return '<span class="cat-chip' + (removable ? ' removable' : '') + '" '
      + 'style="background:' + c.bg + ';color:' + c.fg + ';">'
      + escHtml(name) + removeBtn + '</span>';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìƒëŒ€ ì‹œê°„ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function relativeTime(isoStr) {
    if (!isoStr) return '-';
    try {
      const then = new Date(isoStr);
      const now = new Date();
      const diffMs = now - then;
      if (diffMs < 0) return 'ì˜ˆì •';
      const mins = Math.floor(diffMs / 60000);
      if (mins < 1) return 'ë°©ê¸ˆ ì „';
      if (mins < 60) return mins + 'ë¶„ ì „';
      const hours = Math.floor(mins / 60);
      if (hours < 24) return hours + 'ì‹œê°„ ì „';
      const days = Math.floor(hours / 24);
      return days + 'ì¼ ì „';
    } catch (e) {
      return isoStr;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function loadCategories() {
    const data = await api('/api/categories');
    if (data.error) {
      document.getElementById('categoryChips').innerHTML = '<p class="muted">ì¹´í…Œê³ ë¦¬ ë¡œë”© ì‹¤íŒ¨</p>';
      return;
    }
    _categories = data.categories || [];
    renderCategories();
    renderAddRoomCategories();
  }

  function renderCategories() {
    const el = document.getElementById('categoryChips');
    if (_categories.length === 0) {
      el.innerHTML = '<p class="muted">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
      return;
    }
    el.innerHTML = _categories.map(c => catChipHtml(c, true)).join('');
  }

  function renderAddRoomCategories() {
    const el = document.getElementById('addRoomCategories');
    if (!el) return;
    if (_categories.length === 0) {
      el.innerHTML = '<p class="muted">ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”</p>';
      return;
    }
    el.innerHTML = _categories.map(c =>
      '<label><input type="checkbox" value="' + escHtml(c) + '"><span>' + escHtml(c) + '</span></label>'
    ).join('');
  }

  async function addCategory() {
    const input = document.getElementById('newCategoryInput');
    const statusEl = document.getElementById('categoryStatus');
    const name = input.value.trim();
    if (!name) {
      statusEl.textContent = 'ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”';
      statusEl.style.color = '#E74C3C';
      return;
    }
    if (_categories.includes(name)) {
      statusEl.textContent = 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤';
      statusEl.style.color = '#E74C3C';
      return;
    }

    statusEl.textContent = 'ì¶”ê°€ ì¤‘...';
    statusEl.style.color = '';
    const data = await api('/api/categories', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name }),
    });

    if (data.error) {
      statusEl.textContent = 'ì‹¤íŒ¨: ' + data.error;
      statusEl.style.color = '#E74C3C';
    } else {
      statusEl.textContent = 'ì¶”ê°€ ì™„ë£Œ';
      statusEl.style.color = '#2ECC71';
      input.value = '';
      await loadCategories();
      setTimeout(() => { statusEl.textContent = ''; }, 2000);
    }
  }

  async function removeCategory(name) {
    if (!confirm('"' + name + '" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const data = await api('/api/categories/' + encodeURIComponent(name), { method: 'DELETE' });
    const statusEl = document.getElementById('categoryStatus');
    if (data.error) {
      statusEl.textContent = 'ì‚­ì œ ì‹¤íŒ¨: ' + data.error;
      statusEl.style.color = '#E74C3C';
    } else {
      statusEl.textContent = 'ì‚­ì œ ì™„ë£Œ';
      statusEl.style.color = '#2ECC71';
      await loadCategories();
      setTimeout(() => { statusEl.textContent = ''; }, 2000);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì±„íŒ…ë°© ê´€ë¦¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function loadChatrooms() {
    const data = await api('/api/chatrooms');
    if (data.error) {
      document.getElementById('chatroomList').innerHTML = '<p class="muted">ì±„íŒ…ë°© ë¡œë”© ì‹¤íŒ¨</p>';
      return;
    }
    _chatrooms = data.rooms || [];
    renderChatrooms();
  }

  function renderChatrooms() {
    const container = document.getElementById('chatroomList');
    const countEl = document.getElementById('chatroomCount');

    if (_chatrooms.length === 0) {
      container.innerHTML = '<p class="muted">ë“±ë¡ëœ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      countEl.textContent = '';
      return;
    }

    countEl.textContent = 'ì´ ' + _chatrooms.length + 'ê°œ';

    let html = '<table class="data-table"><thead><tr>'
      + '<th>í™œì„±</th><th>ìœ í˜•</th><th>ì±„íŒ…ë°©ëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th>í™ë³´ì‹œê°„</th><th>ë°œì†¡ì£¼ê¸°</th><th>ìµœê·¼ë°œì†¡</th><th>ê´€ë¦¬</th>'
      + '</tr></thead><tbody>';

    _chatrooms.forEach(room => {
      if (_editingRoom === room.name) {
        html += renderEditRow(room);
      } else {
        html += renderRoomRow(room);
      }
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function renderRoomRow(room) {
    const checked = room.enabled ? 'checked' : '';
    const roomType = room.type || 'open';
    const typeBadge = roomType === 'open'
      ? '<span class="type-badge type-open">ì˜¤í”ˆ</span>'
      : '<span class="type-badge type-normal">ì¼ë°˜</span>';
    const cats = (room.categories || []).map(c => catChipHtml(c, false)).join('');
    const activeHours = room.active_hours || '-';
    const cooldown = room.cooldown_minutes ? room.cooldown_minutes + 'ë¶„' : '-';
    const lastSent = relativeTime(room.last_sent);
    const eName = escHtml(room.name).replace(/'/g, "\\'");

    return '<tr>'
      + '<td><label class="toggle-switch">'
      + '<input type="checkbox" ' + checked + ' onchange="toggleRoom(\'' + eName + '\', this.checked)">'
      + '<span class="toggle-slider"></span></label></td>'
      + '<td>' + typeBadge + '</td>'
      + '<td>' + escHtml(room.name) + '</td>'
      + '<td>' + (cats || '<span class="muted" style="padding:0;">-</span>') + '</td>'
      + '<td>' + escHtml(activeHours) + '</td>'
      + '<td>' + escHtml(cooldown) + '</td>'
      + '<td>' + escHtml(lastSent) + '</td>'
      + '<td>'
      + '<button class="btn btn-xs btn-save" onclick="startEditRoom(\'' + eName + '\')">ìˆ˜ì •</button> '
      + '<button class="btn btn-xs btn-test-send" style="background:#3498DB;color:#fff;" onclick="testSendRoom(\'' + eName + '\')"'
      + (_promotionActive ? '' : ' disabled title="í™ë³´ ì¤‘ì§€ ìƒíƒœ" style="background:#3498DB;color:#fff;opacity:0.4"') + '>í…ŒìŠ¤íŠ¸</button> '
      + '<button class="btn btn-xs btn-stop" onclick="deleteRoom(\'' + eName + '\')">ì‚­ì œ</button>'
      + '</td></tr>';
  }

  function renderEditRow(room) {
    // ì¸ë¼ì¸ ìˆ˜ì • í–‰
    const catsCheckboxes = _categories.map(c => {
      const isChecked = (room.categories || []).includes(c) ? 'checked' : '';
      return '<label style="font-size:11px;margin-right:4px;"><input type="checkbox" class="edit-cat-cb" value="' + escHtml(c) + '" ' + isChecked + '> ' + escHtml(c) + '</label>';
    }).join('');

    // ì‹œì‘/ì¢…ë£Œ ì‹œê°„ íŒŒì‹±
    const parts = (room.active_hours || '09:00~22:00').split('~');
    const startTime = (parts[0] || '09:00').trim();
    const endTime = (parts[1] || '22:00').trim();

    // ì‹œê°„ ì˜µì…˜ ìƒì„±
    let timeOptions = '';
    for (let h = 0; h < 24; h++) {
      for (let m = 0; m < 60; m += 30) {
        const val = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
        timeOptions += '<option value="' + val + '">' + val + '</option>';
      }
    }

    const curType = room.type || 'open';
    return '<tr class="edit-row"><td colspan="8" style="padding: 12px;">'
      + '<div class="form-row">'
      + '<div class="form-group"><label>ì±„íŒ…ë°©ëª…</label>'
      + '<input type="text" id="editRoomName" value="' + escHtml(room.name) + '" readonly style="background:#f0f0f0;"></div>'
      + '<div class="form-group"><label>ìœ í˜•</label>'
      + '<select id="editRoomType"><option value="open"' + (curType === 'open' ? ' selected' : '') + '>ì˜¤í”ˆì±„íŒ…</option>'
      + '<option value="normal"' + (curType === 'normal' ? ' selected' : '') + '>ì¼ë°˜ì±„íŒ…</option></select></div>'
      + '<div class="form-group"><label>ë°œì†¡ì£¼ê¸° (ë¶„)</label>'
      + '<input type="number" id="editRoomCooldown" value="' + (room.cooldown_minutes || 60) + '" min="1"></div>'
      + '</div>'
      + '<div class="form-group" style="margin-bottom:8px;"><label>ì¹´í…Œê³ ë¦¬</label>'
      + '<div class="checkbox-grid" id="editRoomCats">' + catsCheckboxes + '</div></div>'
      + '<div class="form-group" style="margin-bottom:12px;"><label>í™ë³´ê°€ëŠ¥ì‹œê°„</label>'
      + '<div class="time-range">'
      + '<select id="editRoomStart">' + timeOptions.replace('value="' + startTime + '"', 'value="' + startTime + '" selected') + '</select>'
      + '<span>~</span>'
      + '<select id="editRoomEnd">' + timeOptions.replace('value="' + endTime + '"', 'value="' + endTime + '" selected') + '</select>'
      + '</div></div>'
      + '<button class="btn btn-xs btn-save" onclick="saveEditRoom()">ì €ì¥</button> '
      + '<button class="btn btn-xs" style="background:#ccc;" onclick="cancelEditRoom()">ì·¨ì†Œ</button>'
      + '</td></tr>';
  }

  async function toggleRoom(name, enabled) {
    await api('/api/chatrooms/' + encodeURIComponent(name), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: enabled }),
    });
  }

  function startEditRoom(name) {
    _editingRoom = name;
    renderChatrooms();
  }

  function cancelEditRoom() {
    _editingRoom = null;
    renderChatrooms();
  }

  async function saveEditRoom() {
    const name = document.getElementById('editRoomName').value;
    const roomType = document.getElementById('editRoomType').value;
    const cooldown = parseInt(document.getElementById('editRoomCooldown').value) || 60;
    const startTime = document.getElementById('editRoomStart').value;
    const endTime = document.getElementById('editRoomEnd').value;

    const catCheckboxes = document.querySelectorAll('#editRoomCats .edit-cat-cb:checked');
    const categories = Array.from(catCheckboxes).map(cb => cb.value);

    const payload = {
      type: roomType,
      categories: categories,
      active_hours: startTime + '~' + endTime,
      cooldown_minutes: cooldown,
    };

    const data = await api('/api/chatrooms/' + encodeURIComponent(name), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    _editingRoom = null;

    if (data.error) {
      alert('ìˆ˜ì • ì‹¤íŒ¨: ' + data.error);
    }

    await loadChatrooms();
  }

  async function deleteRoom(name) {
    if (!confirm('"' + name + '" ì±„íŒ…ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const data = await api('/api/chatrooms/' + encodeURIComponent(name), { method: 'DELETE' });
    if (data.error) {
      alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
    }
    await loadChatrooms();
  }

  async function testSendRoom(name) {
    if (!_promotionActive) {
      alert('í™ë³´ê°€ ì¤‘ì§€ ìƒíƒœì…ë‹ˆë‹¤. ë¨¼ì € í™ë³´ë¥¼ ì‹œì‘í•˜ì„¸ìš”.');
      return;
    }
    if (!confirm('"' + name + '" ì±„íŒ…ë°©ì— í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const data = await api('/api/chatrooms/' + encodeURIComponent(name) + '/test', { method: 'POST' });
    if (data.ok) {
      alert('í…ŒìŠ¤íŠ¸ ë°œì†¡ ì™„ë£Œ');
    } else {
      alert('í…ŒìŠ¤íŠ¸ ë°œì†¡ ì‹¤íŒ¨: ' + (data.error || ''));
    }
  }

  async function scanChatrooms(mode) {
    const status = document.getElementById('scanStatus');
    const label = mode === 'add' ? 'ì¶”ê°€' : 'ìŠ¤ìº”';
    status.textContent = label + ' ì¤‘...';
    try {
      const r = await fetch('/api/chatrooms/scan', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mode: mode })
      });
      const d = await r.json();
      if (d.ok) {
        status.textContent = label + ' ìš”ì²­ ì™„ë£Œ';
        setTimeout(() => { loadChatrooms(); status.textContent = ''; }, 3000);
      } else {
        status.textContent = 'ì‹¤íŒ¨: ' + (d.error || '');
      }
    } catch(e) {
      status.textContent = 'ì—ëŸ¬: ' + e.message;
    }
  }

  async function addChatroom(e) {
    e.preventDefault();
    const form = document.getElementById('addRoomForm');
    const statusEl = document.getElementById('addRoomStatus');

    const name = form.querySelector('[name="name"]').value.trim();
    if (!name) {
      statusEl.textContent = 'ì±„íŒ…ë°©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”';
      statusEl.style.color = '#E74C3C';
      return;
    }

    const catCheckboxes = document.querySelectorAll('#addRoomCategories input[type="checkbox"]:checked');
    const categories = Array.from(catCheckboxes).map(cb => cb.value);

    const startTime = form.querySelector('[name="active_start"]').value;
    const endTime = form.querySelector('[name="active_end"]').value;
    const nextDay = document.getElementById('addRoomNextDay').checked;
    const activeHours = startTime + '~' + endTime + (nextDay ? '(ìµì¼)' : '');

    const cooldown = parseInt(form.querySelector('[name="cooldown_minutes"]').value) || 60;

    const roomType = form.querySelector('[name="type"]').value;

    const payload = {
      name: name,
      type: roomType,
      categories: categories,
      enabled: true,
      active_hours: activeHours,
      cooldown_minutes: cooldown,
      last_sent: null,
    };

    statusEl.textContent = 'ì¶”ê°€ ì¤‘...';
    statusEl.style.color = '';

    const data = await api('/api/chatrooms', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (data.error) {
      statusEl.textContent = 'ì‹¤íŒ¨: ' + data.error;
      statusEl.style.color = '#E74C3C';
    } else {
      statusEl.textContent = 'ì¶”ê°€ ì™„ë£Œ';
      statusEl.style.color = '#2ECC71';
      form.reset();
      populateTimeSelects();
      await loadChatrooms();
      setTimeout(() => { statusEl.textContent = ''; }, 2000);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• í™ë³´ ì œì–´ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let _promotionActive = false;

  async function updateStatus() {
    const data = await api('/api/status');
    if (data.error) return;

    document.getElementById('serverTime').textContent = data.server_time || '--';

    const sysEl = document.getElementById('systemStatusBadge');
    if (sysEl) {
      const connected = data.sheets_connected !== false; // ì‹œìŠ¤í…œ ì—°ê²° ìƒíƒœ
      sysEl.textContent = connected ? 'ì‹œìŠ¤í…œ: ì—°ê²°ë¨' : 'ì‹œìŠ¤í…œ: ë¯¸ì—°ê²°';
      sysEl.className = 'badge ' + (connected ? 'badge-on' : 'badge-off');
    }

    const promoEl = document.getElementById('promotionStatusBadge');
    if (promoEl) {
      const active = data.promotion_active || false;
      _promotionActive = active;
      promoEl.textContent = active ? 'í™ë³´: ì‹¤í–‰ì¤‘' : 'í™ë³´: ì¤‘ì§€';
      promoEl.className = 'badge ' + (active ? 'badge-on' : 'badge-off');

      document.getElementById('btnPromoStart').disabled = active;
      document.getElementById('btnPromoStop').disabled = !active;

      // í…ŒìŠ¤íŠ¸ ë°œì†¡ ë²„íŠ¼ í™œì„±/ë¹„í™œì„±
      document.querySelectorAll('.btn-test-send').forEach(btn => {
        btn.disabled = !active;
        btn.title = active ? '' : 'í™ë³´ ì¤‘ì§€ ìƒíƒœì—ì„œëŠ” ë°œì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        btn.style.opacity = active ? '1' : '0.4';
      });
    }
  }

  async function startPromotion() {
    const pw = prompt('í™ë³´ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (pw === null) return; // ì·¨ì†Œ
    const statusEl = document.getElementById('promotionControlStatus');
    statusEl.textContent = 'ì‹œì‘ ì¤‘...';
    const data = await api('/api/promotion/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw })
    });
    if (data.error) {
      statusEl.textContent = 'ì‹¤íŒ¨: ' + data.error;
      statusEl.style.color = '#E74C3C';
    } else {
      statusEl.textContent = 'í™ë³´ ì‹œì‘ë¨';
      statusEl.style.color = '#2ECC71';
    }
    updateStatus();
  }

  async function stopPromotion() {
    const statusEl = document.getElementById('promotionControlStatus');
    statusEl.textContent = 'ì¤‘ì§€ ì¤‘...';
    const data = await api('/api/promotion/stop', { method: 'POST' });
    if (data.error) {
      statusEl.textContent = 'ì‹¤íŒ¨: ' + data.error;
      statusEl.style.color = '#E74C3C';
    } else {
      statusEl.textContent = 'í™ë³´ ì¤‘ì§€ë¨';
      statusEl.style.color = '';
    }
    updateStatus();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ëŒ€ê¸° ì‘ì—… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function loadPendingTasks() {
    const data = await api('/api/task/pending');
    const container = document.getElementById('pendingTaskList');
    const countEl = document.getElementById('pendingTaskCount');

    if (data.error) {
      container.innerHTML = '<p class="muted">ëŒ€ê¸° ì‘ì—… ë¡œë”© ì‹¤íŒ¨</p>';
      countEl.textContent = '';
      return;
    }

    const tasks = data.tasks || [];
    if (tasks.length === 0) {
      container.innerHTML = '<p class="muted">ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      countEl.textContent = '';
      return;
    }

    countEl.textContent = tasks.length + 'ê±´ ëŒ€ê¸° ì¤‘';

    const priorityLabels = { 1: 'ê¸´ê¸‰', 2: 'ì¼ë°˜', 3: 'ì˜ˆì•½' };
    const priorityClasses = { 1: 'priority-1', 2: 'priority-2', 3: 'priority-3' };

    let html = '<table class="data-table"><thead><tr>'
      + '<th>ìš°ì„ ìˆœìœ„</th><th>ìœ í˜•</th><th>ë‚´ìš©</th><th>ë“±ë¡ì‹œê°„</th><th>ìƒíƒœ</th>'
      + '</tr></thead><tbody>';

    tasks.forEach(t => {
      const p = t.priority || 2;
      const pLabel = priorityLabels[p] || 'ì¼ë°˜';
      const pClass = priorityClasses[p] || 'priority-2';
      const content = (t.description || t.message || '-').substring(0, 60);
      const created = t.created_at ? relativeTime(t.created_at) : '-';
      const status = t.status || 'pending';

      html += '<tr>'
        + '<td><span class="priority-badge ' + pClass + '">' + escHtml(pLabel) + '</span></td>'
        + '<td>' + escHtml(t.type || t.task_type || '-') + '</td>'
        + '<td title="' + escHtml(t.description || t.message || '') + '">' + escHtml(content) + '</td>'
        + '<td>' + escHtml(created) + '</td>'
        + '<td>' + escHtml(status) + '</td>'
        + '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• í™ë³´ ì´ë ¥ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function loadPromotionHistory() {
    const data = await api('/api/promotion/history?limit=20');
    const container = document.getElementById('promotionHistory');

    if (data.error) {
      container.innerHTML = '<p class="muted">í™ë³´ ì´ë ¥ ë¡œë”© ì‹¤íŒ¨</p>';
      return;
    }

    const history = data.history || [];
    if (history.length === 0) {
      container.innerHTML = '<p class="muted">í™ë³´ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      return;
    }

    let html = '<table class="data-table"><thead><tr>'
      + '<th>ì‹œê°„</th><th>ìº í˜ì¸</th><th>ì±„íŒ…ë°©</th><th>ê²°ê³¼</th>'
      + '</tr></thead><tbody>';

    history.forEach(h => {
      const time = h.timestamp ? relativeTime(h.timestamp) : '-';
      const campaign = h.campaign || '-';
      const room = h.chatroom || h.room || '-';
      const success = h.success || h.result === 'success';
      const resultText = success ? 'ì„±ê³µ' : (h.error || 'ì‹¤íŒ¨');
      const resultClass = success ? 'result-success' : 'result-fail';

      html += '<tr>'
        + '<td>' + escHtml(time) + '</td>'
        + '<td>' + escHtml(campaign) + '</td>'
        + '<td>' + escHtml(room) + '</td>'
        + '<td class="' + resultClass + '">' + escHtml(resultText) + '</td>'
        + '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ë¡œê·¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function loadLogs() {
    const levelFilter = document.getElementById('logLevelFilter') ? document.getElementById('logLevelFilter').value : '';
    let url = '/api/logs?limit=50';
    if (levelFilter) url += '&level=' + encodeURIComponent(levelFilter);

    const data = await api(url);
    const container = document.getElementById('logContainer');

    if (data.error || !data.logs) {
      container.innerHTML = '<p class="muted">ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨</p>';
      return;
    }

    if (data.logs.length === 0) {
      container.innerHTML = '<p class="muted">ë¡œê·¸ ì—†ìŒ</p>';
      return;
    }

    let html = '';
    data.logs.forEach(l => {
      const levelClass = 'log-level-' + (l.level || 'INFO');
      html += '<div class="log-entry">'
        + '<span class="log-time">' + escHtml(l.timestamp || '') + '</span>'
        + '<span class="' + levelClass + '">[' + escHtml(l.level || '') + ']</span> '
        + '<span>' + escHtml(l.message || '') + '</span>'
        + '</div>';
    });
    container.innerHTML = html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìë™ ê°±ì‹  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setInterval(updateStatus, 5000);
  setInterval(() => {
    // í˜„ì¬ í™œì„± íƒ­ì´ í™ë³´ í˜„í™©ì´ë©´ ì´ë ¥ ìë™ ê°±ì‹ 
    const promoTab = document.getElementById('tab-promotion');
    if (promoTab && promoTab.classList.contains('active')) {
      loadPromotionHistory();
      loadPendingTasks();
    }
  }, 10000);
  setInterval(() => {
    // í˜„ì¬ í™œì„± íƒ­ì´ ë¡œê·¸ì´ë©´ ìë™ ê°±ì‹ 
    const logTab = document.getElementById('tab-logs');
    if (logTab && logTab.classList.contains('active')) {
      loadLogs();
    }
  }, 10000);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì´ˆê¸° ë¡œë“œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  populateTimeSelects();
  updateStatus();
  loadCategories();
  loadChatrooms();
  </script>
</body>
</html>
